<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Summit Forecast - Financial Forecaster</title>

<style>
/* ========== Base Theme Variables ========== */
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a1a; --muted: #6b7280;
  --accent: #059669; --ok: #16a34a; --danger: #ef4444; --pending: #e0f2fe; --pending-text: #075985; --pending-border: #bae6fd;
  --paid: #d1fae5; --paid-text: #065f46; --border: #dcdfe3;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
  --font-family: system-ui, sans-serif; --font-size: 15px; /* Reduced base font size */
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --glass-tint: 255,255,255; --glass-alpha: 0.8; --glass-stroke: rgba(0,0,0,.08);
  --glass-shadow: 0 8px 28px rgba(0,0,0,.12); --glass-backdrop-sat: 150%;
  --glass-backdrop-blur: 8px; --slide-duration: 800ms; --slide-ease: cubic-bezier(.22,.61,.36,1);
  --border-radius: 16px; /* NEW: Controllable corner radius */
  --glass-shadow-blur: 28px; --glass-shadow-alpha: 0.12; /* NEW: Controllable shadow parts */
  --glass-shadow: 0 8px var(--glass-shadow-blur) rgba(0,0,0,var(--glass-shadow-alpha));
}
.dark {
  --bg:#0b0d10; --card:#0f1418; --text:#e6eef6; --muted:#9aa4b2;
  --accent:#10b981; --ok:#22c55e; --danger:#f87171; --pending: #1e293b; --pending-text: #7dd3fc; --pending-border: #384252;
  --paid: #064e3b; --paid-text: #a7f3d0; --border:#1b2430;
  --shadow: 0 14px 36px rgba(0,0,0,.45); --glass-tint: 15,20,24;
  --glass-alpha: 0.65; --glass-stroke: rgba(255,255,255,.08);
  --glass-shadow-blur: 56px; --glass-shadow-alpha: 0.55; /* NEW: Dark mode shadow parts */
  --glass-shadow: 0 18px var(--glass-shadow-blur) rgba(0,0,0,var(--glass-shadow-alpha));
}

/* ========== Global & App Layout ========== */
*{box-sizing:border-box}
html { height: 100%; }
body {
  margin:0; min-height: 100vh; font-family:var(--font-family); font-size:var(--font-size);
  color:var(--text); background:var(--bg); line-height:1.4;
  transition: background .25s ease, color .25s ease;
  background-position:center center; background-repeat:no-repeat; background-size:cover;
  background-attachment:fixed; display: grid; place-items: center; padding: 20px;
}
.glass {
    background: rgba(var(--glass-tint), var(--glass-alpha));
    backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
    -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
    border: 1px solid var(--glass-stroke); box-shadow: var(--glass-shadow);
    transform: translateZ(0); /* BUG FIX: Prevents rendering glitches on style change */
}
.app { width:100%; max-width:980px; display:flex; flex-direction:column; gap:20px; z-index: 10; height: calc(100vh - 40px); min-height: 700px; position: relative; }
.title-wrap { width: 100%; padding:10px 16px; border-radius:var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
.title-wrap h1 { margin:0; font-size:24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.title-wrap h1 svg { width: 26px; height: 26px; fill: var(--accent); }
.header-controls { display: flex; align-items: center; gap: 8px; }
.ctrl-btn { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px; width: 36px; height: 36px; border-radius: calc(var(--border-radius) / 1.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
.ctrl-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }
.ctrl-btn svg { width: 20px; height: 20px; fill: currentColor; }

/* ========== Cards & Grids ========== */
.dashboard-container { display: flex; flex-direction: column; gap: 20px; width: 100%; }
.dashboard-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
.card, .summary-card, .finance-card, #pendingBillsCard, #expenseTrackerCard, #next30DaysCard { padding: 16px; border-radius: var(--border-radius); text-align: center; display: flex; flex-direction: column; }
.summary-card { justify-content: space-between; }
.card { border-radius: var(--border-radius); width:100%; overflow:hidden; padding-bottom:10px; }
h2, h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
.card h2 { padding: 0 4px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin: -4px -4px 12px; }
.card-header h2 { padding: 0; }
.add-bill-container {
    display: flex;
    justify-content: flex-end;
    padding-right: 25%;
    height: 0;
    position: relative;
    z-index: 20;
    margin-top: -20px; /* Counteracts the parent's 'gap' to fix spacing */
}
.add-bill-header-btn {
    background: var(--accent);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 28px rgba(0,0,0,.18);
    height: 36px; /* 25% smaller than 48px */
    width: auto;
    padding: 0 18px; /* Proportional padding */
    font-size: 14px;
    border-radius: 999px;
    position: relative;
    transform: translateY(-75%); /* This is the key for the 75% floating effect */
}
.add-bill-header-btn svg {
    width: 14px;
    height: 14px;
}
.add-bill-header-btn:hover {
    background: color-mix(in srgb, var(--accent) 90%, black);
    transform: translateY(calc(-75% - 3px)); /* Adjusted hover effect */
    box-shadow: 0 12px 32px rgba(0,0,0,.22);
}
.link-button { background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 14px; padding: 8px; font-weight: 600; }
.link-button:hover { text-decoration: underline; }

.card-footer {
    display: none;
    padding: 10px 0 0 0;
    text-align: left;
}
.btn-success {
    background-color: var(--ok);
    color: white;
    border: none;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: calc(var(--border-radius) / 1.5);
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.btn-success:hover {
    background-color: color-mix(in srgb, var(--ok) 90%, black);
}

.btn-primary {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 999px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    text-decoration: none; /* In case it's an anchor tag */
}

.btn-primary:hover {
    background: color-mix(in srgb, var(--accent) 90%, black);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.summary-card .amount { font-size: 36px; font-weight: 700; line-height: 1.1; }
.summary-card .projected-balance { font-size: 12px; color: var(--muted); margin-top: 4px; height: 1.2em; font-weight: 600; }
.summary-card .amount.paid { color: var(--ok); } .summary-card .amount.unpaid { color: var(--danger); } .summary-card .amount.total { color: var(--accent); }

/* Finance Card - default is <details> now */
.finance-card-header {
    display: flex;
    justify-content: center; /* Changed */
    align-items: center;
    width: 100%;
    position: relative; /* Added */
}
.privacy-btn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--muted);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    pointer-events: auto !important; /* Keep this for functionality */
}
.privacy-btn:hover {
    background: rgba(128,128,128,0.15);
    color: var(--text);
}
.privacy-btn svg {
    width: 20px;
    height: 20px;
}
.finance-card .stack.blurred {
    filter: blur(5px);
    pointer-events: none;
    user-select: none;
}
.privacy-blurred {
    filter: blur(5px);
    transition: filter 0.2s ease-in-out;
}
details.finance-card { padding: 16px; text-align: left; }
details.finance-card > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
}
details.finance-card > summary::-webkit-details-marker { display: none; }
#billTrackerCard > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
    background: rgba(128,128,128,0.05);
}
#billTrackerCard > summary::-webkit-details-marker { display: none; }
.finance-card .finance-row { display: grid; grid-template-columns: max-content 1fr; gap: 12px; align-items: center; }
.finance-card label { font-weight: 600; font-size: 13px; text-align: right; }
.finance-card input, .finance-card select, #expenseTrackerCard input, #expenseTrackerCard select { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: transparent; color: var(--text); font-size: 14px; width: 100%; min-width: 0; }
#expenseTrackerCard form { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
#expenseTrackerCard button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }

/* Pending & 30-Day Bills */
#pendingBillsList, #next30DaysList { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; padding-right: 5px; min-height: 80px; }
#next30DaysList { max-height: 207px; /* Approx 4 items */ }
#pendingBillsList { max-height: 95px; }
.upcoming-item { display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.05); padding: 6px 10px; border-radius: calc(var(--border-radius) / 2); }
.upcoming-item .name { font-weight: 600; font-size: 14px; }
.upcoming-item .details { font-size: 13px; text-align: right; }
.upcoming-item .amount { font-weight: 700; font-family: var(--font-mono); }
.upcoming-item .countdown { color: var(--muted); font-size: 11px; }

/* Add Bill Form & Bill List Table */
details#billTrackerCard { /* flex: 1 1 auto; min-height: 0; */ }
.bill-table-wrapper { width: 100%; overflow-y: auto; flex-grow: 1; }
.bill-table-wrapper.scrollable {
    max-height: 300px; /* Approx height of 4-5 rows */
    overflow-y: auto;
    padding-right: 5px;
}
details#addBillSection > summary { list-style: none; cursor: pointer; font-weight: 600; padding: 12px 16px; border-bottom: 1px solid var(--border); margin: -16px -16px 16px; background: rgba(128,128,128,0.05); }
details#addBillSection > summary::-webkit-details-marker { display: none; }
.add-bill-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; padding: 0 16px 16px; border-bottom: 1px solid var(--border); align-items: center; }
#billNotes { grid-column: 1 / -1; } #addBtn { grid-column: 1 / -1; }
#splitBillInputs { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }
.add-bill-form input, .add-bill-form select { padding: 10px 12px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 1.5); background: var(--bg); color: var(--text); outline: none; font-size: 14px; }
.add-bill-form button { padding: 10px 14px; border: none; background: var(--accent); color: white; border-radius: calc(var(--border-radius) / 1.5); cursor: pointer; font-weight: 600; }
table.bill-table { width: 100%; border-collapse: collapse; text-align: left; }
table.bill-table th, table.bill-table td { padding: 12px 16px; font-size: 14px; }
table.bill-table tbody tr { cursor: pointer; border-bottom: 1px dashed var(--border); }
.bill-details-cell { line-height: 1.3; }
.bill-name { font-weight: 600; }
.bill-sub-details { display: flex; gap: 8px; margin-top: 4px; }
.bill-category-badge, .bill-frequency-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; background: var(--bg); border: 1px solid var(--border); color: var(--muted); font-weight: 500;}
.split-info-icon { font-size: 11px; margin-left: 6px; color: var(--muted); border: 1px solid; padding: 1px 4px; border-radius: 6px; }
.bill-notes {
    font-size: 13px;
    color: var(--muted);
    white-space: pre-wrap; /* Allow wrapping */
    word-break: break-word; /* Break long words */
    max-height: 60px; /* Limit height to about 3-4 lines */
    overflow-y: auto; /* Add scroll for longer notes */
    padding: 4px 8px;
    background-color: rgba(128,128,128,0.05);
    border-radius: 6px;
    line-height: 1.4;
}
.bill-amount-cell .bill-amount { font-weight: 700; }
.bill-amount-cell .split-info-total { font-size: 11px; color: var(--muted); display: block; }
tr.paid { background-color: color-mix(in srgb, var(--ok) 8%, transparent); color: var(--paid-text); }
tr.paid td { box-shadow: inset 0 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); }
tr.paid td:first-child { box-shadow: inset 1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: calc(var(--border-radius) / 2) 0 0 calc(var(--border-radius) / 2);}
tr.paid td:last-child { box-shadow: inset -1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: 0 calc(var(--border-radius) / 2) calc(var(--border-radius) / 2) 0;}
tr.paid .split-info-total, tr.paid .split-info-icon, tr.paid .bill-category-badge, tr.paid .bill-frequency-badge { color: var(--paid-text); border-color: currentColor; background: transparent; }
.date-box { text-align: center; border-radius: calc(var(--border-radius) / 2); padding: 4px; width: 48px; flex-shrink: 0; border: 1px solid var(--border); }
.date-box .month { font-size: 10px; font-weight: 600; text-transform: uppercase; display: block; background-color: var(--accent); color: white; border-radius: 5px 5px 0 0; margin: -4px -4px 2px; padding: 2px; }
tr.paid .date-box .month { background-color: var(--ok); }

tr.pending { background-color: color-mix(in srgb, var(--pending) 8%, transparent); color: var(--pending-text); }
tr.pending td { box-shadow: inset 0 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); }
tr.pending td:first-child { box-shadow: inset 1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: calc(var(--border-radius) / 2) 0 0 calc(var(--border-radius) / 2);}
tr.pending td:last-child { box-shadow: inset -1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 0 calc(var(--border-radius) / 2) calc(var(--border-radius) / 2) 0;}
tr.pending .split-info-total, tr.pending .split-info-icon, tr.pending .bill-category-badge, tr.pending .bill-frequency-badge { color: var(--pending-text); border-color: currentColor; background: transparent; }
tr.pending .date-box .month { background-color: var(--pending-text); color: var(--pending); }

.date-box .day { font-size: 20px; font-weight: 700; line-height: 1; display: block; }
.date-info { min-height: 2.4em; display: flex; align-items: center; justify-content: center; }
.countdown.overdue { color: var(--danger); font-weight: 600; }
.countdown.paid { color: var(--ok); font-weight: 600; }
.countdown.pending { color: var(--pending-text); font-weight: 600; }

.actions-cell { text-align: right; white-space: nowrap; cursor: default; width: 1%; }
.actions-cell button { margin-left: 8px; }

/* Action Button Styling for Desktop & Mobile consistency */
.actions-cell button, .mobile-bill-actions button {
    border: none;
    padding: 6px 12px;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.actions-cell button:hover, .mobile-bill-actions button:hover {
    transform: translateY(-2px);
}
.actions-cell .details-btn, .mobile-bill-actions .details-btn { background-color: var(--accent); }
.actions-cell .pay-btn, .mobile-bill-actions .pay-btn { background-color: var(--ok); }
.actions-cell .pending-btn, .mobile-bill-actions .pending-btn { background-color: var(--pending-text); color: var(--pending); }
.dark .actions-cell .pending-btn, .dark .mobile-bill-actions .pending-btn { background-color: var(--pending-border); color: var(--pending-text); }
.actions-cell .unpay-btn, .mobile-bill-actions .unpay-btn { background-color: var(--muted); }
.actions-cell .remove-btn, .mobile-bill-actions .remove-btn { background-color: var(--danger); }

/* Default state for buttons inside a row */
.actions-cell .details-btn,
.actions-cell .unpay-btn,
.actions-cell .pay-btn,
.actions-cell .pending-btn {
    display: none;
}
/* Show buttons based on row status */
tr .details-btn { display: inline-block; }
tr.unpaid .pay-btn,
tr.unpaid .pending-btn { display: inline-block; }
tr.pending .pay-btn,
tr.pending .unpay-btn { display: inline-block; }
tr.paid .unpay-btn { display: inline-block; }

.no-bills-message { padding: 40px; text-align: center; color: var(--muted); }
#pastBillsCard > summary { color: var(--muted); display: flex; justify-content: center; align-items: center; list-style: none; cursor: pointer; font-weight: 600; padding: 16px; padding-bottom: 10px; margin: -16px -16px 10px; background: rgba(128,128,128,0.05); }
#pastBillsCard > summary::-webkit-details-marker { display: none; }
#pastBillsCard[open] { padding-bottom: 16px; }
#pastBillsCard .bill-table-wrapper {
    /* overflow: hidden; */ /* REMOVED FOR SCROLL FIX */
}

/* ========== The Tab Feature ========== */
#theTabCard > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
    background: rgba(128,128,128,0.05);
}
#theTabCard > summary::-webkit-details-marker {
    display: none;
}
.debt-content-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; flex-grow: 1; }
.debt-list { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; padding-right: 5px; }
.debt-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px; background: rgba(128,128,128,0.05); border-radius: calc(var(--border-radius) / 2); border-left: 3px solid var(--accent); }
.debt-item.satisfied { border-left-color: var(--ok); opacity: 0.7; }
.debt-item.satisfied .debt-details { text-decoration: line-through; }
.debt-details { display: flex; flex-direction: column; gap: 2px; }
.debt-details .debt-name { font-weight: 600; }
.debt-details .debt-subtext { font-size: 12px; color: var(--muted); }
.debt-actions button {
    border: none;
    padding: 6px 12px;
    margin-left: 4px;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.debt-actions button:hover {
    transform: translateY(-2px);
}
.debt-actions .pay-btn { background-color: var(--ok); }
.debt-actions .remove-btn { background-color: var(--danger); }
.debt-form-container form { display: flex; flex-direction: column; gap: 10px; }
.debt-form-container h3 { text-align: left; }
.debt-form-container input, .debt-form-container textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); font-size: 14px; }
.debt-form-container textarea { resize: vertical; min-height: 40px; }
.debt-form-container button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }

/* ========== Archive View & Filters ========== */
#archive-filters { padding: 16px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
#archive-filters summary { list-style: none; cursor: pointer; font-weight: 600; }
#archive-filters summary::-webkit-details-marker { display: none; }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
.filter-grid label { display: flex; flex-direction: column; text-align: left; font-size: 12px; font-weight: 600; color: var(--muted); }
.filter-grid input, .filter-grid select { margin-top: 4px; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); }


/* ========== Calendar View ========== */
#calendarView { padding: 16px; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 8px; }
.calendar-header button { background: none; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); cursor: pointer; width: 36px; height: 36px; }
.calendar-grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border); border: 1px solid var(--border); border-radius: var(--border-radius); overflow: hidden; }
.calendar-day-name { text-align: center; font-weight: 600; font-size: 12px; padding: 8px 4px; background: var(--bg); color: var(--muted); }
.calendar-day { background: var(--card); min-height: 120px; padding: 4px; font-size: 12px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; }
.calendar-day.other-month { visibility: hidden; }
.day-number { font-weight: 600; text-align: left; }
.calendar-day.today {
    box-shadow: inset 0 0 0 2px #3b82f6; /* A nice, modern blue for highlighting the current day */
}
.calendar-day.today .day-number {
    /* The green oval was removed as per user request */
}
.day-balance { font-size: 10px; font-weight: 700; color: var(--accent); }
.day-balance.negative { color: var(--danger); font-size: 10px; }
.day-balance-container { text-align: right; height: 1.2em; }
.bills-on-day {
    display: flex;
    flex-direction: column;
    gap: 4px;
    justify-content: center;
    align-items: center;
    min-height: 22px; /* space for bubble */
}
.day-bill-count {
    background-color: var(--accent);
    color: white;
    font-size: 10px;
    font-weight: 700;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
}
.calendar-day:hover .day-bill-count {
    transform: scale(1.1);
}
.bill-item-calendar { font-size: 11px; padding: 2px 6px; border-radius: 6px; background-color: var(--accent); color: white; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bill-item-calendar.expense { background-color: var(--muted); }
.bill-item-calendar.paid {
    background-color: var(--ok);
    text-decoration: line-through;
}

/* ========== Edit & Add Bill Modals ========== */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: grid; place-items: center; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s; }
.modal-overlay.visible { opacity: 1; visibility: visible; }
.modal-content { width: 90%; max-width: 500px; padding: 24px; border-radius: var(--border-radius); transform: scale(0.95); transition: transform .2s ease; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-content h2 { margin-top: 0; }
.modal-form, .modal-content form.add-bill-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-form label, .modal-content form.add-bill-form label { font-weight: 600; font-size: 14px; text-align: left; grid-column: 1 / -1; margin-bottom: -8px; }
.modal-form .full-width, .modal-content form.add-bill-form .full-width { grid-column: 1 / -1; }
.modal-form input, .modal-form select, .modal-form textarea, .modal-content form.add-bill-form input, .modal-content form.add-bill-form select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); }
.modal-form textarea { resize: vertical; min-height: 80px; }
.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; grid-column: 1 / -1; }
.modal-buttons button { padding: 10px 16px; border: none; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }
.modal-buttons .save-btn { background: var(--accent); color: white; }
.modal-buttons .cancel-btn { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.modal-buttons .danger-btn { background: var(--danger); color: white; }
.modal-buttons .special-btn { background: var(--pending-text); color: var(--pending); }
#genericModalContent input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: calc(var(--border-radius) / 1.5);
    background: var(--bg);
    color: var(--text);
    outline: none;
    font-size: 16px;
    margin-top: 8px;
}


#dayBreakdownContent ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
#dayBreakdownContent li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
}
#dayBreakdownContent li:last-child {
    border-bottom: none;
}
#dayBreakdownContent h3 {
    margin-top: 16px;
    margin-bottom: 8px;
}
#dayBreakdownContent ul.day-breakdown-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
#dayBreakdownContent ul.day-breakdown-list li {
    padding: 10px;
    background: rgba(128,128,128,0.05);
    border-radius: calc(var(--border-radius) / 2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
}
.modal-bill-details {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}
.modal-bill-amount {
    font-weight: 700;
    font-family: var(--font-mono);
}
.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.status-indicator.status-paid { background-color: var(--ok); }
.status-indicator.status-unpaid { background-color: var(--danger); }
.status-indicator.status-pending { background-color: var(--pending-text); }
.status-indicator.status-expense { background-color: var(--muted); }
.status-indicator.status-income { background-color: var(--accent); }
.modal-bill-actions {
    display: flex;
    gap: 6px;
}
.modal-bill-actions button {
    border: none;
    padding: 4px 8px;
    border-radius: calc(var(--border-radius) / 2.5);
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.modal-bill-actions button:hover {
    transform: translateY(-1px);
}
.modal-bill-actions .pay-btn { background-color: var(--ok); }
.modal-bill-actions .pending-btn { background-color: var(--pending-text); color: var(--pending); }
.dark .modal-bill-actions .pending-btn { background-color: var(--pending-border); color: var(--pending-text); }
.modal-bill-actions .unpay-btn { background-color: var(--muted); }
.modal-bill-actions .dismiss-btn { background-color: var(--danger); }
.modal-bill-actions .details-btn { background-color: var(--accent); padding: 5px 10px; }

/* ========== Natural Slide Animations ========== */
tr.slide-enter { opacity:0; transform:translateY(10px); }
tr.slide-enter-active { transition: opacity var(--slide-duration) var(--slide-ease), transform var(--slide-duration) var(--slide-ease); opacity:1; transform:translateY(0); }
tr.slide-out { transition: opacity calc(var(--slide-duration) / 2) ease, transform calc(var(--slide-duration) / 2) ease; opacity:0; transform:translateX(14px); }
tr.collapsing { overflow:hidden; height:0 !important; padding-top:0 !important; padding-bottom:0 !important; margin:0 !important; border:0 !important; transition: height var(--slide-duration) var(--slide-ease) !important; }

/* ========== Settings Menu (Condensed) ========== */
#ambianceCanvas{ position:fixed; inset:0; pointer-events:none; z-index: 5; }
.menu-panel{ position:fixed; top:78px; right:20px; border-radius:var(--border-radius); padding:14px; width:540px; display:none; z-index:1100; max-height:calc(100vh - 100px); overflow:auto; }
.menu-panel .section, .sub-section { border:1px solid var(--border); border-radius: calc(var(--border-radius) / 1.5); overflow:hidden; margin-top: 10px; }
.menu-panel summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; font-weight:700; background:rgba(128,128,128,0.08); border-radius: 8px; }
.sub-section summary { font-weight: 600; font-size: 14px; background: rgba(128,128,128,0.04); padding: 10px 12px; }
.menu-panel .content{ padding:10px 12px 14px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px; }
.slider-row{ display:flex; align-items:center; gap:10px; } .slider-row label{ min-width:148px; } .slider-row input[type=range]{ flex:1; }
.pct{ min-width:48px; text-align:right; font-size:12px; color:var(--muted); }
.shadow-cue { /* NEW */
    width: 50px; height: 30px; border-radius: 5px; background: var(--card); border: 1px solid var(--border);
    transition: box-shadow 0.1s ease-in-out;
}
.menu-notch{ position:sticky; bottom:0; display:flex; justify-content:center; padding:12px 0 2px; margin-top:8px; }
.menu-notch button{ border:none; cursor:pointer; font-weight:600; padding:12px 16px; border-radius:999px; background:var(--card); color:var(--text); border:1px solid var(--border); box-shadow:var(--shadow); }
.stack{ display:flex; flex-direction:column; gap:8px; } .hr{ border:none; border-top:1px solid var(--border); margin:6px 0; }
#resetProfileBtn { background-color: var(--danger); color: white; } /* NEW */

.bottom-nav {
    display: none;
}

@media (max-width: 768px) {
    body { padding: 10px; }
    .app { gap: 16px; height: auto; min-height: initial; }
    .dashboard-container { grid-template-columns: 1fr; }
    details#billTrackerCard { max-height: none; flex: initial; }
    .menu-panel{ right:8px; left:8px; width:auto; top:70px; }
    .calendar-day { min-height: 80px; }
}

/* ========== MOBILE MODE STYLES ========== */
@media (max-width: 768px) {
    /* Base layout fix to prevent overflow */
    .mobile-view {
        display: block; /* Override grid centering */
        padding: 0;
        overscroll-behavior-y: contain;
    }

    /* Set up main layout flow */
    .mobile-view .app {
        padding: 65px 10px 90px; /* Space for sticky header/FAB and body padding */
        max-width: 100%;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
        gap: 12px; /* Reduce gap between sections */
    }
    .mobile-view .title-wrap {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        max-width: none;
        width: 100%;
        z-index: 1000;
        border-radius: 0;
        border-bottom: 1px solid var(--border);
        box-shadow: none;
    }

    /* Re-flow dashboard into a single column */
    .mobile-view .dashboard-container {
        display: flex;
        flex-direction: column;
        order: 1; /* Dashboard section first */
    }
    .mobile-view .dashboard-row {
        display: contents; /* Let children be direct flex items */
    }

    /* Order dashboard cards vertically */
    .mobile-view #balanceSummaryCard { order: 1; }
    .mobile-view #dueSummaryCard { order: 2; }
    .mobile-view #financeCard { order: 3; }

    /* Make Finance card collapsible on mobile */

    @media (min-width: 769px) {
        #financeCard > summary {
            pointer-events: none;
            cursor: default;
        }
        #financeCard > summary::-webkit-details-marker {
            display: none;
        }
    }

    .mobile-view #theTabCard {
        order: 4;
        text-align: left;
    }
    
    .mobile-view #theTabCard .debt-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    .mobile-view details.finance-card .stack {
        overflow: hidden;
    }

    /* Order main content sections */
    .mobile-view #billTrackerCard { order: 2; margin-top: 0; }
    .mobile-view .add-bill-container { order: 3; }
    .mobile-view #pastBillsCard {
        order: 5;
        margin-bottom: auto;
    }
    .mobile-view #billTrackerCard > summary,
    .mobile-view #pastBillsCard > summary,
    .mobile-view #financeCard > summary,
    .mobile-view #theTabCard > summary {
        text-align: left;
        cursor: pointer;
        list-style: revert;
        margin: -16px -16px 10px;
        padding: 16px;
        padding-bottom: 10px;
        display: list-item;
    }
    /* START: MODIFICATION */
    .mobile-view #billTrackerCard > summary,
    .mobile-view #pastBillsCard > summary,
    .mobile-view #theTabCard > summary {
        background: rgba(128,128,128,0.05);
    }
    /* END: MODIFICATION */
    #pastBillsCard[open] .card-footer {
        display: block;
    }
    .mobile-view .bill-table-wrapper {
      padding-right: 0;
    }

    .mobile-view #archiveView main.card {
        flex-grow: 1;
        height: 70vh;
    }

    /* Floating Action Button (FAB) for "Add Bill" */
    .mobile-view .add-bill-container {
        position: fixed;
        bottom: 80px; /* Adjusted for bottom nav */
        right: 20px;
        left: auto;
        width: auto;
        height: auto;
        z-index: 1050;
        padding-right: 0;
        margin-top: 0;
    }
    .mobile-view .add-bill-header-btn {
        width: auto;
        height: 56px;
        border-radius: 999px;
        padding: 0 24px;
        box-shadow: 0 6px 16px rgba(0,0,0,.2);
        transform: none;
        font-size: 16px;
        font-weight: 700;
    }
    .mobile-view .add-bill-header-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .mobile-view .add-bill-header-btn svg {
        margin-right: 8px;
        width: 20px;
        height: 20px;
    }

    /* Hide non-essential cards in mobile view */
    .mobile-view #expenseTrackerCard,
    .mobile-view #pendingBillsCard,
    .mobile-view #next30DaysCard {
        display: none !important;
    }

    /* --- Bill List Redesign --- */
    .mobile-view .bill-table {
        border-collapse: separate;
        border-spacing: 0 10px;
        margin-top: -10px;
    }
    .mobile-view .bill-table thead {
        display: none;
    }
    .mobile-view .bill-table tbody tr {
        background: transparent;
        border: none;
        padding: 0;
        cursor: default;
        border-bottom: none; /* Override default */
    }
    .mobile-view .bill-table tbody tr td {
        padding: 0 !important;
        box-shadow: none !important;
        display: block;
        border: none !important; /* Override paid/pending borders */
        border-radius: 0 !important;
    }
    .mobile-bill-layout {
        display: grid;
        grid-template:
            "date info amount" auto
            "actions actions actions" auto / 48px 1fr auto;
        gap: 8px 12px;
        padding: 12px;
        border-radius: calc(var(--border-radius) / 1.5);
        background: var(--card);
        border: 1px solid var(--border);
    }
    tr.paid .mobile-bill-layout { border-left: 4px solid var(--ok); }
    tr.pending .mobile-bill-layout { border-left: 4px solid var(--pending-border); }
    tr.unpaid .mobile-bill-layout { border-left: 4px solid var(--danger); }

    .mobile-bill-date {
        grid-area: date;
        align-self: center;
    }
    .mobile-bill-date .date-box { width: 100%; }

    .mobile-bill-info {
        grid-area: info;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
        min-width: 0;
    }
    .mobile-bill-info .bill-name {
        font-weight: 600; font-size: 16px; line-height: 1.2;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-bill-info .bill-status { margin-top: 4px; font-size: 13px; }

    .mobile-bill-amount {
        grid-area: amount;
        text-align: right;
        align-self: center;
    }
    .mobile-bill-amount .bill-amount { font-size: 18px; font-weight: 700; font-family: var(--font-mono);}
    .mobile-bill-amount .split-info-total { font-size: 10px; }


    .mobile-bill-actions {
        grid-area: actions;
        display: flex; flex-wrap: wrap; justify-content: flex-end;
        gap: 8px; padding-top: 8px; margin-top: 8px;
        border-top: 1px dashed var(--border);
    }

    /* --- Hide desktop elements in mobile view --- */
    .mobile-view .due-date-cell, .mobile-view .bill-details-cell, .mobile-view .bill-notes-cell, .mobile-view .bill-amount-cell, .mobile-view .actions-cell {
        display: none;
    }
    .mobile-view tr td[colspan="5"] {
        display: block;
    }
    
    /* --- Mobile Calendar Optimizations --- */
    .mobile-view #calendarView {
        padding: 10px;
    }
    .mobile-view .calendar-header {
        margin-bottom: 12px;
        padding: 0 4px;
    }
    .mobile-view .calendar-header h2 {
        font-size: 18px;
    }
    .mobile-view .calendar-grid-container {
        grid-template-columns: repeat(7, minmax(0, 1fr));
    }
    .mobile-view .calendar-day-name {
        padding: 6px 2px;
        font-size: 11px;
    }
    .mobile-view .calendar-day {
        min-height: auto;
        aspect-ratio: 1 / 1;
        padding: 3px;
        font-size: 11px;
    }
    .mobile-view .day-number {
        font-size: 11px;
        font-weight: 700;
    }
    .mobile-view .day-balance {
        font-size: 9px;
        text-align: center;
    }
    .mobile-view .bills-on-day {
        gap: 2px;
        overflow: hidden;
    }
    .mobile-view .bill-item-calendar {
        font-size: 10px;
        padding: 1px 4px;
        border-radius: 4px;
    }

    /* Bottom Navigation */
    .bottom-nav {
        display: none; /* Hidden by default on desktop */
    }
    .mobile-view .bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(var(--glass-tint), var(--glass-alpha));
        backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
        -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
        border-top: 1px solid var(--glass-stroke);
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom); /* For iPhone X notch */
    }
    .mobile-view .bottom-nav-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-size: 12px;
        cursor: pointer;
        padding-top: 8px;
    }
    .mobile-view .bottom-nav-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }
    .mobile-view .bottom-nav-btn.active {
        color: var(--accent);
    }
}

/* ========== Statistics View Specific Styles ========== */
#statisticsView .dashboard-row.summary-metrics {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}
#statisticsView .dashboard-row.charts {
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
#statisticsView .dashboard-row.tables {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}
@media (max-width: 768px) {
    .mobile-view #statisticsView .dashboard-row {
        grid-template-columns: 1fr;
    }
    .mobile-view #statisticsView main.dashboard-container {
        padding: 0;
    }
}

/* ========== Goals View Specific Styles ========== */
#goalsView .dashboard-row {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.goals-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: 200px;
}

.goal-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
}
.dark .goal-item {
    background: #1c1c1e;
    border-color: #38383a;
}

.goal-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.goal-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.goal-name {
    font-weight: 600;
    font-size: 18px;
    color: var(--text);
}

.goal-notes-display {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.4;
}

.goal-progress {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.goal-progress-bar {
    width: 100%;
    height: 10px;
    background: var(--border);
    border-radius: 5px;
    overflow: hidden;
}

.goal-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--ok));
    border-radius: 5px;
    transition: width 0.4s ease;
}

.goal-progress-text {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    font-weight: 500;
}

.goal-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-top: 4px;
}

.goal-amount-container {
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.goal-amount-saved {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    font-family: var(--font-mono);
}

.goal-amount-total {
    font-size: 14px;
    font-weight: 500;
    color: var(--muted);
}

.goal-action-buttons {
    display: flex;
    gap: 12px;
}

.goal-action-btn {
    background-color: color-mix(in srgb, var(--bg) 50%, var(--border));
    border: none;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s ease;
}
.dark .goal-action-btn {
    background-color: #2c2c2e;
}

.goal-action-btn:hover {
    background-color: color-mix(in srgb, var(--bg) 30%, var(--border));
    color: var(--text);
    transform: scale(1.1);
}
.dark .goal-action-btn:hover {
    background-color: #3a3a3c;
}

.goal-action-btn.add {
    background-color: var(--accent);
    color: white;
}
.goal-action-btn.add:hover {
    background-color: color-mix(in srgb, var(--accent) 90%, black);
    color: white;
}

.goal-action-btn.delete:hover {
    background-color: var(--danger);
    color: white;
}

.goal-action-btn svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
}

.goal-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.form-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-row label {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
}

.form-row input, .form-row textarea {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: calc(var(--border-radius) / 1.5);
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s ease;
}

.form-row input:focus, .form-row textarea:focus {
    border-color: var(--accent);
}

.form-row textarea {
    resize: vertical;
    min-height: 80px;
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.feasibility-feedback {
    padding: 12px;
    border-radius: calc(var(--border-radius) / 1.5);
    border: 1px solid;
    margin: 8px 0;
}

.feasibility-feedback.feasible {
    background: color-mix(in srgb, var(--ok) 8%, transparent);
    border-color: var(--ok);
    color: var(--ok);
}

.feasibility-feedback.not-feasible {
    background: color-mix(in srgb, var(--danger) 8%, transparent);
    border-color: var(--danger);
    color: var(--danger);
}

.feasibility-feedback.warning {
    background: color-mix(in srgb, var(--pending-text) 8%, transparent);
    border-color: var(--pending-text);
    color: var(--pending-text);
}

.no-goals-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
}

.no-goals-message p {
    margin: 0 0 16px 0;
    font-size: 16px;
}

.payment-schedule-preview {
    background: rgba(128,128,128,0.05);
    border: 1px solid var(--border);
    border-radius: calc(var(--border-radius) / 1.5);
    padding: 16px;
    margin: 16px 0;
}

.payment-schedule-preview h4 {
    margin: 0 0 12px 0;
    color: var(--accent);
    font-size: 16px;
}

.schedule-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 12px;
}

.schedule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    margin: 4px 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.schedule-date {
    font-weight: 600;
    color: var(--text);
}

.schedule-amount {
    font-family: var(--font-mono);
    font-weight: 700;
    color: var(--accent);
}

.schedule-summary {
    text-align: center;
    padding: 12px;
    background: var(--card);
    border-radius: 8px;
    border: 1px solid var(--accent);
    color: var(--accent);
}

@media (max-width: 768px) {
    .mobile-view #goalsView .dashboard-row {
        grid-template-columns: 1fr;
    }
    .mobile-view #goalsView main.dashboard-container {
        padding: 0;
    }
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 0;
}

.checkbox-label input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
}

.checkmark {
    flex-grow: 1;
}

.schedule-item.down-payment {
    background: rgba(34, 197, 94, 0.1);
    border-left: 3px solid #22c55e;
}

/* Goal Payment Styling */
.goal-payment {
    border-left: 3px solid #059669;
}

.goal-payment.locked {
    background: rgba(251, 191, 36, 0.1);
    border-left-color: #f59e0b;
}

.goal-payment.grayed-out {
    opacity: 0.5;
    background: rgba(107, 114, 128, 0.1);
    border-left-color: #6b7280;
}

.goal-payment.grayed-out .bill-name,
.goal-payment.grayed-out .bill-amount {
    color: #6b7280;
}

.edit-goal-payment-btn,
.lock-goal-payment-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    margin: 2px;
}

.edit-goal-payment-btn:hover,
.lock-goal-payment-btn:hover {
    background: #2563eb;
}

.lock-goal-payment-btn {
    background: #f59e0b;
}

.lock-goal-payment-btn:hover {
    background: #d97706;
}

/* Goal Edit Modal Styles */
.goal-edit-container {
    max-width: 480px;
    margin: 0 auto;
}

.goal-edit-header {
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--accent);
}

.goal-edit-header h3 {
    margin: 0 0 6px 0;
    color: var(--accent);
    font-size: 15px;
}

.goal-progress-info {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.3;
}

.payment-schedule-list {
    max-height: 250px;
    overflow-y: auto;
    margin-bottom: 10px;
}

.schedule-payment-item {
    display: grid;
    grid-template-columns: 1fr 75px 60px 95px;
    gap: 4px;
    align-items: center;
    padding: 4px 6px;
    margin-bottom: 3px;
    border: 1px solid var(--accent);
    border-radius: 3px;
    background: var(--card);
    font-size: 11px;
    min-height: 32px;
}

.schedule-payment-item.editable {
    border-left: 3px solid #059669;
}

.schedule-payment-item.non-editable {
    border-left: 3px solid #f59e0b;
}

.schedule-payment-item.grayed-out {
    opacity: 0.6;
    border-left-color: #6b7280;
}

.payment-date {
    font-weight: 500;
    font-size: 11px;
    line-height: 1.2;
}

.payment-date-text {
    font-size: 9px;
    color: var(--text-secondary);
    margin-top: 1px;
}

.payment-amount-input {
    width: 100%;
    padding: 3px 4px;
    border: 1px solid var(--accent);
    border-radius: 2px;
    background: var(--input);
    color: var(--text);
    font-size: 11px;
    height: 24px;
}

.payment-amount-display {
    font-weight: 500;
    color: var(--accent);
    font-size: 11px;
}

.payment-status {
    text-align: center;
    font-size: 9px;
}

.payment-controls {
    display: flex;
    gap: 2px;
    justify-content: flex-end;
}

.toggle-lock-btn,
.delete-payment-btn {
    padding: 2px 4px;
    border: none;
    border-radius: 2px;
    font-size: 9px;
    cursor: pointer;
    white-space: nowrap;
    min-height: 20px;
}

.toggle-lock-btn {
    background: #f59e0b;
    color: white;
}

.toggle-lock-btn:hover {
    background: #d97706;
}

.delete-payment-btn {
    background: #dc2626;
    color: white;
}

.delete-payment-btn:hover {
    background: #b91c1c;
}

.goal-edit-summary {
    padding: 8px;
    background: var(--input);
    border-radius: 4px;
    border: 1px solid var(--accent);
    font-size: 11px;
    line-height: 1.3;
}

.recalculate-btn {
    background: #8b5cf6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
}

.recalculate-btn:hover {
    background: #7c3aed;
}

@media (max-width: 768px) {
    .goal-edit-container {
        max-width: 100%;
        margin: 0;
    }

    .goal-edit-header {
        margin-bottom: 8px;
    }

    .schedule-payment-item {
        grid-template-columns: 1fr;
        gap: 4px;
        text-align: left;
        padding: 5px 6px;
        margin-bottom: 3px;
    }

    .payment-controls {
        justify-content: center;
        margin-top: 3px;
        gap: 2px;
    }

    .payment-schedule-list {
        max-height: 200px;
        margin-bottom: 8px;
    }

    .goal-edit-summary {
        padding: 6px;
        font-size: 10px;
    }
}


@media print {
    body > *:not(#app),
    #app > *:not(#calendarView),
    .menu-panel, #editModal, #archiveView {
        display: none !important;
    }
    .app, body {
        padding: 0;
        margin: 0;
        background: none;
    }
    #calendarView {
        display: block !important;
        max-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    .glass {
        background: transparent !important;
        backdrop-filter: none !important;
        --glass-stroke: #ccc !important;
        border-color: #ccc !important;
    }
    .calendar-header .ctrl-btn {
        display: none !important;
    }
    .calendar-header h2 {
        color: black !important;
    }
    .bill-item-calendar {
        background-color: #eee !important;
        color: #333 !important;
        border: 1px solid #ddd;
    }
    .bill-item-calendar.paid {
        background-color: #e8f5e9 !important;
        color: #2e7d32 !important;
        text-decoration: none;
    }
    .calendar-day.today .day-number {
        background-color: #ddd !important;
        color: black !important;
    }
    :root {
        --text: #000;
        --muted: #555;
        --card: #fff;
        --bg: #fff;
        --border: #ccc;
    }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf-autotable.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
</head>
<body>
  <canvas id="ambianceCanvas"></canvas>
  <div class="app" id="app">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2ZM13,17H11V15H13V17ZM13,13H11V7H13V13Z" /></svg>Summit Forecast</h1>
      <div class="header-controls">
        <button id="darkToggle" class="ctrl-btn dark-toggle" title="Toggle Dark Mode"></button>
        <button id="calendarToggleBtn" class="ctrl-btn" title="Toggle Calendar View"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.53,11.06L15.47,10L10.5,14.97L8.47,12.94L7.41,14L10.5,17.09L16.53,11.06Z"/></svg></button>
        <button id="menuBtn" class="ctrl-btn menu-btn" title="Open Settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></button>
      </div>
    </header>

    <div class="dashboard-container">
        <div class="dashboard-row">
            <div id="balanceSummaryCard" class="summary-card glass"><h3 id="totalAmountLabel">Available Balance</h3><div class="amount total" id="totalAmount">$0.00</div><div class="projected-balance" id="actualBalance"></div></div>
            <div id="dueSummaryCard" class="summary-card glass"><h3 id="totalDueNext10DaysLabel">Your Share (Next 10 Days)</h3><div class="amount unpaid" id="totalDueNext10Days">$0.00</div><div class="projected-balance" id="projected10Day"></div></div>
            <div id="pendingBillsCard" class="glass"><h2>Pending</h2><div id="pendingBillsList"></div></div>
        </div>
        <div class="dashboard-row">
            <div id="next30DaysCard" class="glass"><h2>Next 30 Days</h2><div id="next30DaysList"></div></div>
            <details id="financeCard" class="finance-card glass">
                <summary class="finance-card-header">
                    My Finances
                    <button id="privacyToggleBtn" class="ctrl-btn privacy-btn" title="Toggle Visibility">
                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                        <svg class="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.83,9L15,12.17V12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,10.79 7.2,9.67 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3L2,4.27M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.55,16.73C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.27,4.75 8.04,5.25L9.9,7.11C10.54,7.03 11.22,7 12,7Z"/></svg>
                    </button>
                </summary>
                <div>
                    <div class="stack">
                        <div class="finance-row"><label for="currentBalance">Balance:</label><input type="number" id="currentBalance" placeholder="$0.00"></div>
                        <div class="finance-row"><label for="dontAutoDeduct">Don't auto-deduct:</label><input type="checkbox" id="dontAutoDeduct" style="width: auto; justify-self: start;"></div>
                        <div class="finance-row"><label for="paycheckAmount">Next/Est Paycheck:</label><input type="number" id="paycheckAmount" placeholder="$0.00"></div>
                        <div class="finance-row"><label for="nextPayday">Next Payday:</label><input type="date" id="nextPayday"></div>
                        <div class="finance-row"><label for="payFrequency">Frequency:</label><select id="payFrequency"><option>Weekly</option><option selected>Bi-Weekly</option><option>Monthly</option></select></div>
                    </div>
                </div>
            </details>
            <div id="expenseTrackerCard" class="glass">
                <h3>Log an Expense</h3>
                <div id="expenseQuickOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Food" style="width:100%; height:auto; padding: 16px 12px;">Food </button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Gas" style="width:100%; height:auto; padding: 16px 12px;">Gas </button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Coffee" style="width:100%; height:auto; padding: 16px 12px;">Coffee </button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Cigarettes" style="width:100%; height:auto; padding: 16px 12px;">Cigarettes </button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Baseball Cards" style="width:100%; height:auto; padding: 16px 12px;">Cards </button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Groceries" style="width:100%; height:auto; padding: 16px 12px;">Groceries </button>
                    <button class="ctrl-btn" id="customExpenseBtn" style="width:100%; height:auto; padding: 12px; grid-column: 1 / -1;">Custom</button>
                </div>
                <form id="expenseForm" style="display: none;">
                    <input type="text" id="expenseDescription" placeholder="e.g., Lunch" required>
                    <input type="number" id="expenseAmount" placeholder="$ Amount" step="0.01" required>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" id="cancelCustomExpenseBtn">Cancel</button>
                        <button type="submit">Log Expense</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="dashboard-row" id="theTabRow" style="display: none;">
            <details id="theTabCard" class="card glass">
                <summary>The Tab</summary>
                <div class="debt-content-wrapper">
                    <div id="debtList" class="debt-list">
                        </div>
                    <div class="debt-form-container">
                        <h3>Log a New Debt</h3>
                        <form id="addDebtForm">
                            <input type="text" id="debtName" placeholder="Who owes you?" required>
                            <input type="number" id="debtAmount" placeholder="Amount ($)" step="0.01" required>
                            <input type="date" id="debtDate" required>
                            <textarea id="debtNotes" placeholder="Notes (e.g., for lunch)"></textarea>
                            <button type="submit">Log Debt</button>
                        </form>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <details id="billTrackerCard" class="card glass" role="main">
      <summary>Upcoming Bills (Next 10 Days)</summary>
      <div>
          <div class="bill-table-wrapper">
            <table class="bill-table" id="billList">
                <thead id="billListHead">
                    <tr><th>Due Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style-align: right;>Actions</th></tr>
                </thead>
                <tbody id="billListBody"></tbody>
            </table>
            <div class="no-bills-message" id="noBillsMessage"><p>No upcoming bills. Add one to get started! </p></div>
          </div>
      </div>
    </details>

    <div class="add-bill-container">
        <button id="addBillBtnHeader" class="add-bill-header-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align: middle; margin-right: 8px;"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z"></path></svg><span class="add-bill-text">Add Bill</span>
        </button>
    </div>

    <details id="pastBillsCard" class="card glass">
        <summary>Past Bills</summary>
        <div>
            <div class="bill-table-wrapper">
                <table class="bill-table" id="pastBillsTable">
                    <thead><tr><th>Due Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style="text-align: right;">Actions</th></tr></thead>
                    <tbody id="pastBillsListBody"></tbody>
                </table>
                 <div class="no-bills-message" id="noPastBillsMessage" style="display: none;"><p>No paid bills yet.</p></div>
            </div>
            <div class="card-footer">
                <button id="archiveBtn" class="btn-success">View Full Archive</button>
            </div>
        </div>
    </details>

    <div id="calendarView" class="card glass" style="display: none;"></div>
  </div>

  <div id="archiveView" class="app" style="display: none; flex-direction: column;">
    <main class="card glass" role="main">
        <details id="archive-filters">
            <summary>Filter & Search</summary>
            <div class="filter-grid">
                <label>Search Term <input type="text" id="filterSearchTerm" placeholder="e.g., Netflix..."></label>
                <label>Start Date <input type="date" id="filterStartDate"></label>
                <label>End Date <input type="date" id="filterEndDate"></label>
                <label>Category <select id="filterCategory"></select></label>
                <button id="clearFiltersBtn" class="ctrl-btn" style="width: auto; height: 38px; align-self: end; padding: 0 16px;">Clear</button>
            </div>
        </details>
        <div class="bill-table-wrapper" id="archive-table-wrapper">
            <table class="bill-table" id="archiveBillsTable">
                <tbody id="archiveBillsListBody"></tbody>
            </table>
            <div class="no-bills-message" id="noArchivedBillsMessage" style="display: none;"><p>No archived bills found.</p></div>
        </div>
    </main>
    <div class="add-bill-container">
        <button id="backFromArchiveBtn" class="add-bill-header-btn"> Go Back</button>
    </div>
  </div>

  <div id="statisticsView" class="app" style="display: none; flex-direction: column;">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M3.5 18.5C4.22 18.5 4.85 18.22 5.33 17.74L17.74 5.33C18.22 4.85 18.5 4.22 18.5 3.5C18.5 2.67 17.83 2 17 2C16.17 2 15.5 2.67 15.5 3.5C15.5 4.22 15.78 4.85 16.26 5.33L3.85 17.74C3.37 18.22 3 18.83 3 19.5V20H10V18.5H3.5M19 12V15L22 12L19 9V12M17 16V19L20 16L17 13V16M13 16H15V18H13V16M9 12H11V14H9V12M5 8H7V10H5V8Z"/></svg>Statistics</h1>
      <div class="header-controls" style="display: flex; gap: 10px;">
        <select id="statsTimeRange" class="ctrl-btn" style="width: auto; padding: 0 10px;"><option value="7">Last 7 Days</option><option value="30" selected>Last 30 Days</option><option value="90">Last 90 Days</option><option value="365">This Year</option><option value="all">All Time</option></select>
        <select id="statsCategory" class="ctrl-btn" style="width: auto; padding: 0 10px;"><option value="all">All Categories</option></select>
      </div>
    </header>
    <main class="dashboard-container" style="flex-grow: 1; overflow-y: auto; padding: 0 10px 10px; gap: 16px;">
      
      <!-- Key Summary Metrics -->
      <div class="dashboard-row summary-metrics">
        <div class="summary-card glass"><h3>Total Income</h3><div id="statsTotalIncome" class="amount" style="color: var(--ok);">$0.00</div></div>
        <div class="summary-card glass"><h3>Total Expenses</h3><div id="statsTotalExpenses" class="amount" style="color: var(--danger);">$0.00</div></div>
        <div class="summary-card glass"><h3>Net Balance</h3><div id="statsNetBalance" class="amount" style="color: var(--accent);">$0.00</div></div>
        <div class="summary-card glass"><h3>Bills Paid</h3><div id="statsBillsPaid" class="amount">0 / 0</div></div>
      </div>

      <!-- Charts & Visualizations -->
      <div class="dashboard-row charts">
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Spending by Category</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="categoryPieChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Expenses Over Time</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="expensesLineChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Upcoming vs Paid Bills</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="billsBarChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Cash Flow Projection</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="cashFlowLineChart"></canvas></div>
        </div>
      </div>

      <!-- Tables/Lists -->
      <div class="dashboard-row tables">
        <div id="topCategoriesCard" class="card glass">
          <h2>Top Expense Categories</h2>
          <div id="topCategoriesList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
        <div id="largestExpensesCard" class="card glass">
          <h2>Largest Single Expenses</h2>
          <div id="largestExpensesList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
        <div id="recurringBillsCard" class="card glass">
          <h2>Recurring Bills Overview</h2>
          <div id="recurringBillsList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
      </div>

      <!-- Debt/Tab Stats -->
      <div class="dashboard-row">
        <div id="debtStatsCard" class="card glass" style="width: 100%;">
          <h2>Debt / "The Tab" Stats</h2>
          <div id="debtStatsList" class="debt-stats-placeholder" style="padding: 10px; color: var(--muted); display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
      </div>

    </main>
  </div>

  <div id="goalsView" class="app" style="display: none; flex-direction: column;">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"/></svg>AI Goal System</h1>
      <div class="header-controls">
        <button id="addGoalBtn" class="ctrl-btn" title="Add New Goal">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
        </button>
      </div>
    </header>
    <main class="dashboard-container" style="flex-grow: 1; overflow-y: auto; padding: 0 10px 10px; gap: 16px;">
      
      <!-- Goals Dashboard -->
      <div id="goalsDashboard" class="dashboard-row">
        <div class="summary-card glass">
          <h3>Active Goals</h3>
          <div id="activeGoalsCount" class="amount" style="color: var(--accent);">0</div>
        </div>
        <div class="summary-card glass">
          <h3>Total Saved</h3>
          <div id="totalSaved" class="amount" style="color: var(--ok);">$0.00</div>
        </div>
        <div class="summary-card glass">
          <h3>Total Goal Amount</h3>
          <div id="totalGoalAmount" class="amount" style="color: var(--muted);">$0.00</div>
        </div>
      </div>

      <!-- Active Goals List -->
      <div class="dashboard-row">
        <div id="activeGoalsCard" class="card glass" style="width: 100%;">
          <div class="card-header">
            <h2>Your Financial Goals</h2>
          </div>
          <div id="activeGoalsList" class="goals-list">
            <div class="no-goals-message" id="noGoalsMessage">
              <p> No goals yet! Create your first financial goal to get started.</p>
              <button id="createFirstGoalBtn" class="btn-primary" style="margin-top: 10px;">Create Your First Goal</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <div id="goalCreationModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2>Create New Goal</h2>
      <form id="goalCreationForm" class="goal-form" style="border-bottom: none; padding-bottom: 0;">
          <div class="form-row">
            <label for="goalName">Goal Name</label>
            <input type="text" id="goalName" placeholder="e.g., Emergency Fund, Vacation" required>
          </div>
          <div class="form-row">
            <label for="goalAmount">Goal Amount ($)</label>
            <input type="number" id="goalAmount" placeholder="5000" min="1" step="0.01" required>
          </div>
          <div class="form-row">
            <label for="goalEndDate">Target Date</label>
            <input type="date" id="goalEndDate" required>
          </div>
          <div class="form-row">
            <label for="goalNotes">Notes (Optional)</label>
            <textarea id="goalNotes" placeholder="What is this goal for?"></textarea>
          </div>
          <div class="form-row">
            <label class="checkbox-label">
              <input type="checkbox" id="makeDownPayment">
              <span class="checkmark"></span>
              Make a down payment today (will reduce future payments)
            </label>
          </div>
          <div id="downPaymentAmount" class="form-row" style="display: none;">
            <label for="downPaymentInput">Down Payment Amount</label>
            <input type="number" id="downPaymentInput" placeholder="0.00" min="0" step="0.01">
          </div>
          <div id="feasibilityCheck" class="feasibility-feedback" style="display: none;">
            <!-- AI feasibility analysis will be displayed here -->
          </div>
          <div id="paymentSchedulePreview" class="payment-schedule-preview" style="display: none;">
            <h4> Proposed Payment Schedule (Based on Your Paydays)</h4>
            <div id="scheduleList" class="schedule-list"></div>
            <div class="schedule-summary">
              <strong>Total: <span id="scheduleTotalAmount">$0.00</span> over <span id="scheduleTotalPayments">0</span> payments</strong>
            </div>
          </div>
          <div class="form-actions modal-buttons">
            <button type="button" id="cancelGoalBtn" class="cancel-btn">Cancel</button>
            <button type="button" id="previewGoalBtn" class="save-btn" style="display: none;">Create</button>
            <button type="submit" id="createGoalBtn" class="save-btn" style="display: none;"> Confirm & Create Goal</button>
          </div>
        </form>
    </div>
  </div>

  <div id="editModal" class="modal-overlay"><div class="modal-content glass"><h2 id="editModalTitle">Edit Bill</h2><div class="modal-form"><label for="editBillName">Bill Name</label><input type="text" id="editBillName" class="full-width"><label for="editBillAmount">Total Amount</label><input type="number" step="0.01" id="editBillAmount" class="full-width"><label for="editBillDate">Due Date</label><input type="date" id="editBillDate" class="full-width"><label for="editBillCategory">Category</label><select id="editBillCategory" class="full-width"></select><label for="editBillFrequency">Frequency</label><select id="editBillFrequency" class="full-width"></select><div id="editCustomFrequencyWrapper" class="full-width" style="display: none;"><input type="number" id="editBillCustomFrequency" placeholder="Every X Days" style="width: 100%;"></div><label for="editBillNotes">Notes</label><textarea id="editBillNotes" class="full-width"></textarea><div id="editSplitBillInputs" class="full-width"><hr><label>Split Info</label><input type="text" id="editBillSplitName" placeholder="Split with (Name)"><input type="number" id="editBillSplitAmount" placeholder="Their Share ($)"></div><div class="modal-buttons"><button type="button" class="cancel-btn" id="closeModalBtn">Cancel</button><button type="button" class="save-btn" id="saveEditBtn">Save Changes</button></div></div></div></div>

  <div id="dayBreakdownModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2 id="dayBreakdownTitle">Day Breakdown</h2>
      <div id="dayBreakdownContent"></div>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" id="closeDayBreakdownModalBtn">Close</button>
      </div>
    </div>
  </div>

  <div id="addBillModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2>Add New Bill</h2>
      <form class="add-bill-form" id="addBillForm" style="border-bottom: none; padding-bottom: 0;">
          <input id="billName" type="text" placeholder="Bill Name (e.g., Netflix)" required class="full-width" />
          <input id="billAmount" type="number" placeholder="Total Amount ($)" step="0.01" min="0" />
          <input id="billDate" type="date" required />
          <select id="billFrequency"><option>One-Time</option><option>Weekly</option><option>Bi-Weekly</option><option selected>Monthly</option><option>Quarterly</option><option>Annually</option><option>Custom</option></select>
          <select id="billCategory"><option>Utilities</option><option>Subscription</option><option>Rent/Mortgage</option><option>Loan</option><option>Insurance</option><option>Groceries</option><option>Personal</option><option>Other</option><option value="Expense">Expense</option></select>
          <div id="customFrequencyWrapper" class="full-width" style="display: none;">
            <input type="number" id="billCustomFrequency" placeholder="Every X Days" style="width: 100%;">
          </div>
          <input id="billNotes" type="text" placeholder="Notes (optional)" class="full-width" />
          <div id="splitBillInputs" class="full-width"><input type="text" id="billSplitName" placeholder="Split with (Name)"><input type="number" id="billSplitAmount" placeholder="Their Share ($)"></div>
          <div class="modal-buttons full-width">
            <button type="button" class="cancel-btn" id="closeAddBillModalBtn">Cancel</button>
            <button id="addBtn" type="button" class="save-btn">Add Bill</button>
          </div>
      </form>
    </div>
  </div>

    <div id="expenseModal" class="modal-overlay">
      <div class="modal-content glass">
        <h2>Log an Expense</h2>
        <div id="expenseModalContent">
            <div id="expenseModalQuickOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Food" style="width:100%; height:auto; padding: 16px 12px;">Food </button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Gas" style="width:100%; height:auto; padding: 16px 12px;">Gas </button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Coffee" style="width:100%; height:auto; padding: 16px 12px;">Coffee </button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Cigarettes" style="width:100%; height:auto; padding: 16px 12px;">Cigarettes </button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Baseball Cards" style="width:100%; height:auto; padding: 16px 12px;">Cards </button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Groceries" style="width:100%; height:auto; padding: 16px 12px;">Groceries </button>
                <button class="ctrl-btn" id="customExpenseModalBtn" style="width:100%; height:auto; padding: 12px; grid-column: 1 / -1;">Custom</button>
            </div>
            <form id="expenseModalForm" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <input type="text" id="expenseModalDescription" placeholder="e.g., Lunch" required>
                <input type="number" id="expenseModalAmount" placeholder="$ Amount" step="0.01" required>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" id="cancelCustomExpenseModalBtn">Cancel</button>
                    <button type="submit">Log Expense</button>
                </div>
            </form>
        </div>
        <div class="modal-buttons" style="margin-top: 10px;">
          <button type="button" class="cancel-btn" id="closeExpenseModalBtn">Close</button>
        </div>
      </div>
    </div>

  <div class="menu-panel glass" id="menuPanel" aria-hidden="true">
    <div class="section"><details><summary>Appearance</summary>
        <div class="content">
          <div class="sub-section"><details><summary>User Interface</summary><div class="content"><div class="stack"><label for="uiStyleSelect">Style</label><select id="uiStyleSelect"></select></div><div class="slider-row"><label for="glassOpacity">Opacity</label><input type="range" id="glassOpacity" min="10" max="100" value="80" /><span class="pct" id="glassOpacityPct"></span></div><div class="slider-row"><label for="glassBlurSlider">Blur</label><input type="range" id="glassBlurSlider" min="0" max="20" value="8" /><span class="pct" id="glassBlurPct"></span></div><div class="slider-row"><label for="cornerRadiusSlider">Corner Radius</label><input type="range" id="cornerRadiusSlider" min="0" max="32" value="16" /><span class="pct" id="cornerRadiusPct"></span></div><div class="slider-row"><label for="glassShadowSlider">Glass Shadow</label><input type="range" id="glassShadowSlider" min="0" max="100" value="50" /><div id="shadowCue" class="shadow-cue"></div></div></div></details></div>
          <div class="sub-section"><details><summary>Animations</summary><div class="content"><label><input type="checkbox" id="enableNaturalSlide"> Natural Slide Animation</label><div class="slider-row"><label for="slideSpeed">Animation Speed</label><input type="range" id="slideSpeed" min="100" max="1500" value="1000"><span class="pct" id="slideSpeedPct"></span></div></div></details></div>
          <div class="sub-section"><details><summary>Background</summary><div class="content"><div class="stack"><label><input type="checkbox" id="enableCustomBackground">Enable Custom Background</label></div><div id="customBackgroundOptions" class="stack" style="display:none;"><div class="hr"></div><div class="stack"><label for="backgroundType">Type</label><select id="backgroundType"><option value="theme" selected>Theme</option><option value="image">Image</option><option value="color">Gradient</option></select></div><div id="imageWallpaperControls" style="display:none; margin-top: 10px;"><input type="file" id="wallpaperFile" accept="image/*" /></div><div id="colorWallpaperControls" class="stack" style="display:none; margin-top: 10px;"><label>Start Color: <input type="color" id="wallpaperColor3" value="#1e1b4b"></label><label>End Color: <input type="color" id="wallpaperColor2" value="#4c1d95"></label><div class="slider-row"><label for="gradientAngle">Angle</label><input type="range" id="gradientAngle" min="0" max="360" value="145"><span class="pct" id="gradientAnglePct"></span></div><div class="stack"><label><input type="checkbox" id="gradientSpinToggle">Enable Spinning</label><div class="slider-row" id="gradientSpinControls" style="display:none;"><label for="gradientSpinSpeed">Speed</label><input type="range" id="gradientSpinSpeed" min="1" max="100" value="10"><span class="pct" id="gradientSpinSpeedPct"></span></div></div></div></div><div class="hr"></div><div class="stack"><label><input type="checkbox" id="enableAmbiance">Enable Live Effects</label><div id="ambianceSettings" class="stack" style="display:none; margin-top: 10px;"><select id="ambianceSelect"><option value="none" selected>None</option><option value="snowflakes">Snowflakes</option><option value="orbs">Orbs</option><option value="starfield">Starfield</option></select><div id="ambianceControls" class="stack" style="display:none; border:1px solid var(--border); border-radius:8px; padding:10px; gap: 10px;"><div id="snowControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="snowDensity" min="0" max="300" value="100"><span class="pct" id="snowDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="snowSize" min="10" max="40" value="20"><span class="pct" id="snowSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="snowSpeed" min="10" max="100" value="30"><span class="pct" id="snowSpeedPct"></span></div></div><div id="orbsControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="orbsDensity" min="10" max="150" value="40"><span class="pct" id="orbsDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="orbsSize" min="20" max="150" value="70"><span class="pct" id="orbsSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="orbsSpeed" min="5" max="100" value="20"><span class="pct" id="orbsSpeedPct"></span></div><label>Color: <input type="color" id="orbsColor" value="#9aa4b2"></label></div><div id="starfieldControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="starfieldDensity" min="50" max="1500" value="500"><span class="pct" id="starfieldDensityPct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="starfieldSpeed" min="1" max="100" value="25"><span class="pct" id="starfieldSpeedPct"></span></div></div></div></div></div></div></details></div>
    </div></details></div>
    <div class="section"><details><summary>Utility</summary><div class="content">
      <div class="stack">
        <label><input type="checkbox" id="disableAutoOpenCurrentBills"> Disable auto-opening current bills on startup</label>
        <label><input type="checkbox" id="enableTheTab"> Enable "The Tab"</label>
        <label><input type="checkbox" id="blurSummary"> Blur Summary Amounts</label>
      </div>
      <div class="hr"></div>
      <div class="sub-section"><details open><summary>Experimental Tools</summary><div class="content"><div class="stack">
        <label for="unpaidDays" style="text-align: left; font-size: 14px; font-weight: 600;">Mark bills unpaid after X days:</label>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
            <input type="number" id="unpaidDays" value="30" style="padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text);">
            <button id="unpaidToolBtn" class="ctrl-btn" style="width: auto; height: 38px; padding: 0 16px; background-color: var(--pending-text); color: var(--pending);">Run</button>
        </div>
        <div class="hr"></div>
        <div>
            <p style="font-size:12px;color:var(--muted);margin:4px 0 10px;">Generate a realistic, randomized profile of a heavy user to see the app's full potential.</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="demoModeBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px; background-color: var(--accent); color: white;">Enable Demo Mode</button>
                <button id="deactivateDemoBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Deactivate</button>
            </div>
        </div>
      </div></div></details></div>
      <div class="hr"></div>
      <div class="sub-section"><details><summary>Data Management</summary><div class="content"><div class="stack"><p style="font-size:12px;color:var(--muted);margin:4px 0 0;">Import or export your full application profile. This includes all bills, settings, and appearance customizations.</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;"><button id="importProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Import Profile</button><button id="exportProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Export Profile</button></div><div class="hr"></div><button id="resetProfileBtn" class="ctrl-btn" style="width: 100%; height: auto; padding: 10px; margin-top: 5px;">Reset to Factory Defaults</button></div></div></details></div></div></details></div>
    <div class="menu-notch"><button id="closeMenuNotch">Close</button></div>
  </div>

  <div id="genericModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2 id="genericModalTitle"></h2>
      <div id="genericModalContent">
        <p id="genericModalText" style="line-height: 1.5; margin: 16px 0;"></p>
      </div>
      <div class="modal-buttons" id="genericModalButtons"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <button id="dashboardTabBtn" class="bottom-nav-btn active">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13,3V9H21V3M13,15H21V21H13M3,21H11V11H3M3,3H11V9H3"/></svg>
      <span>Dashboard</span>
    </button>
    <button id="goalsTabBtn" class="bottom-nav-btn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"/></svg>
      <span>Goals</span>
    </button>
    <button id="statisticsTabBtn" class="bottom-nav-btn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.5C4.22 18.5 4.85 18.22 5.33 17.74L17.74 5.33C18.22 4.85 18.5 4.22 18.5 3.5C18.5 2.67 17.83 2 17 2C16.17 2 15.5 2.67 15.5 3.5C15.5 4.22 15.78 4.85 16.26 5.33L3.85 17.74C3.37 18.22 3 18.83 3 19.5V20H10V18.5H3.5M19 12V15L22 12L19 9V12M17 16V19L20 16L17 13V16M13 16H15V18H13V16M9 12H11V14H9V12M5 8H7V10H5V8Z"/></svg>
      <span>Statistics</span>
    </button>
  </div>

<script>
// IFFE to encapsulate the entire application
(function(){
    "use strict";
    // --- All JavaScript logic is included below ---

    // --- STATE & DOM ---
    let bills = [], debts = [], userFinances = {}, currentView = 'list', calendarDate = new Date(), activeModalResolve = null, isAnimationRunning = true;
    let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0; // For swipe gestures
    const $ = (s) => document.getElementById(s);
    const billTrackerCard = $('billTrackerCard'), pastBillsCard = $('pastBillsCard'), calendarView = $('calendarView'), calendarToggleBtn = $('calendarToggleBtn'), billListBody = $('billListBody'), pastBillsListBody = $('pastBillsListBody');
    const addBillForm = $('addBillForm');
    const splitBillInputs = $('splitBillInputs');
    const addBtn = $('addBtn'), noBillsMessage = $('noBillsMessage'), noPastBillsMessage = $('noPastBillsMessage'), darkToggle = $('darkToggle'), menuBtn = $('menuBtn'), menuPanel = $('menuPanel'), closeMenuNotch = $('closeMenuNotch');
    const totalAmountEl = $('totalAmount'), totalDueNext10DaysEl = $('totalDueNext10Days');
    const pendingBillsList = $('pendingBillsList'), next30DaysList = $('next30DaysList');
    const currentBalance = $('currentBalance'), paycheckAmount = $('paycheckAmount'), nextPayday = $('nextPayday'), payFrequency = $('payFrequency');
    const expenseForm = $('expenseForm');
    const editModal = $('editModal'), closeModalBtn = $('closeModalBtn'), saveEditBtn = $('saveEditBtn');
    const addBillModal = $('addBillModal'), closeAddBillModalBtn = $('closeAddBillModalBtn');
    const editSplitBillInputs = $('editSplitBillInputs');
    const addBillBtnHeader = $('addBillBtnHeader');
    const archiveView = $('archiveView'), appView = $('app'), archiveBtn = $('archiveBtn'), backFromArchiveBtn = $('backFromArchiveBtn');
    const archiveBillsListBody = $('archiveBillsListBody'), noArchivedBillsMessage = $('noArchivedBillsMessage');
    const ambianceCanvas = $('ambianceCanvas'), ctxAmbiance = ambianceCanvas.getContext('2d');
    const uiStyleSelect = $('uiStyleSelect'), glassOpacity = $('glassOpacity'), glassBlurSlider = $('glassBlurSlider');
    const enableNaturalSlide = $('enableNaturalSlide'), slideSpeed = $('slideSpeed');
    const enableCustomBackground = $('enableCustomBackground'), customBackgroundOptions = $('customBackgroundOptions'), backgroundType = $('backgroundType');
    const wallpaperFile = $('wallpaperFile'), wallpaperColor2 = $('wallpaperColor2'), wallpaperColor3 = $('wallpaperColor3');
    const gradientAngle = $('gradientAngle'), gradientSpinToggle = $('gradientSpinToggle'), gradientSpinControls = $('gradientSpinControls'), gradientSpinSpeed = $('gradientSpinSpeed');
    const enableAmbiance = $('enableAmbiance'), ambianceSettings = $('ambianceSettings'), ambianceControls = $('ambianceControls'), ambianceSelect = $('ambianceSelect');
    const snowDensity = $('snowDensity'), snowSize = $('snowSize'), snowSpeed = $('snowSpeed');
    const orbsDensity = $('orbsDensity'), orbsSize = $('orbsSize'), orbsSpeed = $('orbsSpeed'), orbsColor = $('orbsColor');
    const starfieldDensity = $('starfieldDensity'), starfieldSpeed = $('starfieldSpeed');
    const dontAutoDeduct = $('dontAutoDeduct');
    const cornerRadiusSlider = $('cornerRadiusSlider');
    const glassShadowSlider = $('glassShadowSlider');
    const genericModal = $('genericModal'), genericModalTitle = $('genericModalTitle'), genericModalContent = $('genericModalContent'), genericModalText = $('genericModalText'), genericModalButtons = $('genericModalButtons');
    const filterSearchTerm = $('filterSearchTerm'), filterStartDate = $('filterStartDate'), filterEndDate = $('filterEndDate'), filterCategory = $('filterCategory'), clearFiltersBtn = $('clearFiltersBtn');
    const disableAutoOpenCurrentBills = $('disableAutoOpenCurrentBills');
    const expenseModal = $('expenseModal');
    const enableTheTab = $('enableTheTab'), theTabRow = $('theTabRow'), addDebtForm = $('addDebtForm'), debtList = $('debtList');
    const statisticsView = $('statisticsView'), dashboardTabBtn = $('dashboardTabBtn'), statisticsTabBtn = $('statisticsTabBtn');
    const goalsView = $('goalsView'), goalsTabBtn = $('goalsTabBtn');
    const activeGoalsCount = $('activeGoalsCount'), totalSaved = $('totalSaved'), totalGoalAmount = $('totalGoalAmount');
    const activeGoalsList = $('activeGoalsList'), noGoalsMessage = $('noGoalsMessage');
    const goalCreationModal = $('goalCreationModal'), goalCreationForm = $('goalCreationForm');
    const addGoalBtn = $('addGoalBtn'), createFirstGoalBtn = $('createFirstGoalBtn');
    const cancelGoalBtn = $('cancelGoalBtn');
    const goalName = $('goalName'), goalAmount = $('goalAmount'), goalEndDate = $('goalEndDate'), goalNotes = $('goalNotes');
    const feasibilityCheck = $('feasibilityCheck');
    const paymentSchedulePreview = $('paymentSchedulePreview'), scheduleList = $('scheduleList');
    const previewGoalBtn = $('previewGoalBtn'), createGoalBtn = $('createGoalBtn');
    const scheduleTotalAmount = $('scheduleTotalAmount'), scheduleTotalPayments = $('scheduleTotalPayments');
    const makeDownPayment = $('makeDownPayment'), downPaymentAmount = $('downPaymentAmount'), downPaymentInput = $('downPaymentInput');
    const statsTimeRange = $('statsTimeRange'), statsCategory = $('statsCategory');
    const blurSummary = $('blurSummary');
    let charts = {}, goals = [];

    let ambianceParticles = [], gradientAnimationAngle = 0;
    const materialPresets = { glass: { styles: { 'default': { name: 'Default', light: '255,255,255', dark: '15,20,24' }, 'twilight': { name: 'Twilight', light: '235, 230, 255', dark: '30, 25, 45' }, 'graphite': { name: 'Graphite', light: '240,240,245', dark: '35,35,40' }, 'emerald': { name: 'Emerald', light: '240,255,245', dark: '20,40,30' }, 'blue': { name: 'Blue', light: '235,245,255', dark: '20,30,45' }, }}};

    // --- UTILITY ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    const formatDate = (dateStr) => { const d = new Date(dateStr + 'T00:00:00'); return { month: d.toLocaleString('default', { month: 'short' }).toUpperCase(), day: d.getDate() }; };
    const getCountdown = (dateStr) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(dateStr + 'T00:00:00');
        const diffTime = dueDate.getTime() - today.getTime();
        const diffDays = Math.round(diffTime / 864e5);

        if (diffDays > 1) return `${diffDays} days left`;
        if (diffDays === 1) return 'Due tomorrow';
        if (diffDays === 0) return 'Due today';
        return `${Math.abs(diffDays)} days overdue`;
    };
    const resizeCanvas = (cv) => { const dpr = window.devicePixelRatio || 1; cv.width = window.innerWidth * dpr; cv.height = window.innerHeight * dpr; cv.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0); };
    const getUserShare = bill => (bill.isSplit && bill.splitWithAmount) ? bill.amount - bill.splitWithAmount : bill.amount;

    // --- DATA & STATE ---
    function saveData() {
        try {
            localStorage.setItem('summitForecast.bills', JSON.stringify(bills));
            localStorage.setItem('summitForecast.debts', JSON.stringify(debts));
            localStorage.setItem('summitForecast.goals', JSON.stringify(goals));
            const settings = { darkMode: document.documentElement.classList.contains('dark'), dontAutoDeduct: dontAutoDeduct.checked, finances: { balance: currentBalance.value, paycheck: paycheckAmount.value, payday: nextPayday.value, frequency: payFrequency.value }, financesBlurred: $('financeCard').querySelector('.stack').classList.contains('blurred'), naturalSlide: { enabled: enableNaturalSlide.checked, speed: slideSpeed.value }, uiStyle: uiStyleSelect.value, glassOpacity: glassOpacity.value, glassBlur: glassBlurSlider.value, cornerRadius: cornerRadiusSlider.value, glassShadow: glassShadowSlider.value, customBg: enableCustomBackground.checked, bgType: backgroundType.value, bgColor2: wallpaperColor2.value, bgColor3: wallpaperColor3.value, bgGradientAngle: gradientAngle.value, bgGradientSpin: gradientSpinToggle.checked, bgGradientSpinSpeed: gradientSpinSpeed.value, ambiance: enableAmbiance.checked, ambianceEffect: ambianceSelect.value, snowDensity: snowDensity.value, snowSize: snowSize.value, snowSpeed: snowSpeed.value, orbsDensity: orbsDensity.value, orbsSize: orbsSize.value, orbsSpeed: orbsSpeed.value, orbsColor: orbsColor.value, starfieldDensity: starfieldDensity.value, starfieldSpeed: starfieldSpeed.value, disableAutoOpenCurrentBills: disableAutoOpenCurrentBills.checked, theTabEnabled: enableTheTab.checked, blurSummary: blurSummary.checked };
            localStorage.setItem('summitForecast.settings', JSON.stringify(settings));
        } catch (error) { console.error("Failed to save data:", error); }
    }
    function loadData() {
        try {
            bills = JSON.parse(localStorage.getItem('summitForecast.bills') || '[]');
            debts = JSON.parse(localStorage.getItem('summitForecast.debts') || '[]');
            goals = JSON.parse(localStorage.getItem('summitForecast.goals') || '[]');
        
        // Update editability for existing goals
        goals.forEach(goal => {
            updateGoalPaymentEditability(goal.id);
        });
            bills.forEach(bill => {
                if (typeof bill.paid === 'boolean' && !bill.status) {
                    bill.status = bill.paid ? 'paid' : 'unpaid';
                    delete bill.paid;
                } else if (!bill.status) { bill.status = 'unpaid'; }
                if (bill.status === 'paid' && !bill.paidTimestamp) {
                    bill.paidTimestamp = new Date(bill.date + 'T12:00:00Z').toISOString();
                }
            });

            const settingsData = localStorage.getItem('summitForecast.settings');
            const settings = settingsData ? JSON.parse(settingsData) : {};
            if (settings.darkMode) { document.documentElement.classList.add('dark'); darkToggle.innerHTML = ''; } else { darkToggle.innerHTML = '';}
            dontAutoDeduct.checked = settings.dontAutoDeduct || false;
            userFinances = settings.finances || {};
            currentBalance.value = userFinances.balance || ''; paycheckAmount.value = userFinances.paycheck || ''; nextPayday.value = userFinances.payday || ''; payFrequency.value = userFinances.frequency || 'Bi-Weekly';
            const slideSettings = settings.naturalSlide || {};
            enableNaturalSlide.checked = slideSettings.enabled === false ? false : true; slideSpeed.value = slideSettings.speed || 1000;
            populateStyleSelector();
            uiStyleSelect.value = settings.uiStyle || 'twilight';
            glassOpacity.value = settings.glassOpacity || 80; glassBlurSlider.value = settings.glassBlur || 8;
            cornerRadiusSlider.value = settings.cornerRadius || 16;
            glassShadowSlider.value = settings.glassShadow || 50;
            enableCustomBackground.checked = settings.customBg || false; backgroundType.value = settings.bgType || 'theme';
            wallpaperColor2.value = settings.bgColor2 || '#1e1b4b'; wallpaperColor3.value = settings.bgColor3 || '#4c1d95';
            gradientAngle.value = settings.bgGradientAngle || 145; gradientSpinToggle.checked = settings.bgGradientSpin || false; gradientSpinSpeed.value = settings.bgGradientSpinSpeed || '10';
            enableAmbiance.checked = settings.ambiance || false; ambianceSelect.value = settings.ambianceEffect || 'none';
            disableAutoOpenCurrentBills.checked = settings.disableAutoOpenCurrentBills || false;
            enableTheTab.checked = settings.theTabEnabled || false;
            blurSummary.checked = settings.blurSummary || false;
            const ambiance = settings.ambianceSettings || {};
            snowDensity.value = ambiance.snowDensity || 100;
            snowSize.value = ambiance.snowSize || 20;
            snowSpeed.value = ambiance.snowSpeed || 30;
            orbsDensity.value = ambiance.orbsDensity || 40;
            orbsSize.value = ambiance.orbsSize || 70;
            orbsSpeed.value = ambiance.orbsSpeed || 20;
            orbsColor.value = ambiance.orbsColor || '#9aa4b2';
            starfieldDensity.value = settings.starfieldDensity || 500;
            starfieldSpeed.value = settings.starfieldSpeed || 25;

            if (settings.financesBlurred) {
                const financeStack = $('financeCard').querySelector('.stack');
                financeStack.classList.add('blurred');
                $('actualBalance').classList.add('privacy-blurred');
                $('projected10Day').classList.add('privacy-blurred');
                const privacyBtn = $('privacyToggleBtn');
                if (privacyBtn) {
                    privacyBtn.querySelector('.eye-open').style.display = 'none';
                    privacyBtn.querySelector('.eye-closed').style.display = 'block';
                }
            }

        } catch (error) { console.error("Failed to load data:", error); }
        $('billDate').value = new Date().toISOString().split('T')[0];
        $('debtDate').value = new Date().toISOString().split('T')[0];
        applyAllAppearance(); renderApp(true);
        if (window.innerWidth > 768) {
            $('financeCard').setAttribute('open', '');
        }
        if (!disableAutoOpenCurrentBills.checked) {
            billTrackerCard.setAttribute('open', '');
        }
    }

    // --- RENDERING ---
    function renderApp(isInitialLoad = false) {
        const dashboardContainer = document.querySelector('.dashboard-container');
        const addBillContainer = document.querySelector('.add-bill-container');

        if (currentView === 'list') {
            dashboardContainer.style.display = 'flex';
            billTrackerCard.style.display = 'flex';
            addBillContainer.style.display = 'flex';
            pastBillsCard.style.display = 'block';
            calendarView.style.display = 'none';
            calendarToggleBtn.classList.remove('active');
            renderLists(isInitialLoad);
        } else { // calendar view
            dashboardContainer.style.display = 'none';
            billTrackerCard.style.display = 'none';
            addBillContainer.style.display = 'none';
            pastBillsCard.style.display = 'none';
            calendarView.style.display = 'block';
            calendarToggleBtn.classList.add('active');
            renderCalendar();
        }
        updateSummary(); renderPendingBills(); renderNext30Days();
        if(enableTheTab.checked) renderTheTab();
    }
    function renderLists(isInitialLoad = false) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const tenDaysFromNow = new Date();
        tenDaysFromNow.setDate(today.getDate() + 10);

        const activeBills = bills.filter(b => {
            if (b.status === 'paid') return false;
            if (b.status === 'pending') return true;
            const billDate = new Date(b.date + 'T00:00:00');
            return billDate <= tenDaysFromNow;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        const pastBills = bills.filter(b => {
            if (b.status !== 'paid' || !b.paidTimestamp) return false;
            const paidDate = new Date(b.paidTimestamp);
            return paidDate >= thirtyDaysAgo;
        }).sort((a, b) => new Date(b.paidTimestamp) - new Date(a.paidTimestamp));

        billListBody.innerHTML = ''; noBillsMessage.style.display = activeBills.length === 0 ? 'block' : 'none';
        pastBillsListBody.innerHTML = ''; noPastBillsMessage.style.display = pastBills.length === 0 ? 'block' : 'none';

        activeBills.forEach(bill => billListBody.appendChild(createBillRow(bill, isInitialLoad)));
        pastBills.forEach(bill => pastBillsListBody.appendChild(createBillRow(bill, isInitialLoad)));

        const applyScrollable = (tbody, threshold) => {
            const wrapper = tbody.closest('.bill-table-wrapper');
            if (!wrapper) return;
            const isMobile = document.body.classList.contains('mobile-view');
            wrapper.classList.toggle('scrollable', !isMobile && tbody.children.length > threshold);
        };
        applyScrollable(billListBody, 3);
        applyScrollable(pastBillsListBody, 3);
    }
    function renderArchive() {
        archiveBillsListBody.innerHTML = '';

        const searchTerm = filterSearchTerm.value.toLowerCase();
        const startDate = filterStartDate.value;
        const endDate = filterEndDate.value;
        const category = filterCategory.value;

        let filteredBills = bills.filter(b => b.status === 'paid');

        if (searchTerm) {
            filteredBills = filteredBills.filter(b =>
                b.name.toLowerCase().includes(searchTerm) ||
                (b.notes && b.notes.toLowerCase().includes(searchTerm))
            );
        }
        if (startDate) {
            filteredBills = filteredBills.filter(b => b.date >= startDate);
        }
        if (endDate) {
            filteredBills = filteredBills.filter(b => b.date <= endDate);
        }
        if (category) {
            filteredBills = filteredBills.filter(b => b.category === category);
        }

        const sortedBills = filteredBills.sort((a, b) => new Date(b.date) - new Date(a.date));
        noArchivedBillsMessage.style.display = sortedBills.length === 0 ? 'block' : 'none';
        sortedBills.forEach(bill => archiveBillsListBody.appendChild(createBillRow(bill, true)));
    }
    function createBillRow(bill, isInitialLoad = false) {
        const tr = document.createElement('tr');
        tr.dataset.id = bill.id;
        if (bill.status === 'paid') tr.classList.add('paid');
        else if (bill.status === 'pending') tr.classList.add('pending');
        else tr.classList.add('unpaid');
        
        // Add goal payment specific styling
        if (bill.isGoalPayment) {
            tr.classList.add('goal-payment');
            if (bill.isGrayedOut) tr.classList.add('grayed-out');
            if (bill.isLocked) tr.classList.add('locked');
        }

        const { month, day } = formatDate(bill.date);
        const yourShare = getUserShare(bill);
        const amountDisplay = bill.isSplit ? `<span class="bill-amount">${formatCurrency(yourShare)}</span><span class="split-info-total">Total: ${formatCurrency(bill.amount)}</span>` : `<span class="bill-amount">${formatCurrency(bill.amount)}</span>`;
        let nameHtml = `<span class="bill-name">${bill.name}</span>`;
        if(bill.isSplit) { nameHtml += `<span class="split-info-icon" title="Split with ${bill.splitWithName}"></span>`; }
        let countdownHtml;
        if (bill.status === 'paid') {
            countdownHtml = `<span class="countdown paid">Paid</span>`;
        } else if (bill.status === 'pending') {
            countdownHtml = `<span class="countdown pending">Pending</span>`;
        } else {
            const countdownText = getCountdown(bill.date);
            const isOverdueClass = countdownText.includes('overdue') ? 'overdue' : '';
            countdownHtml = `<span class="countdown ${isOverdueClass}">${countdownText}</span>`;
        }

        const isMobile = document.body.classList.contains('mobile-view');

        if (isMobile) {
            let actionsHTML = `<button class="details-btn">Details</button>`;
            if (bill.status === 'unpaid') {
                actionsHTML += `<button class="pay-btn">Paid </button><button class="pending-btn">Pending</button>`;
            } else if (bill.status === 'pending') {
                actionsHTML += `<button class="pay-btn">Paid </button><button class="unpay-btn">Unpaid </button>`;
            } else if (bill.status === 'paid') {
                actionsHTML += `<button class="unpay-btn">Unpaid </button>`;
            }
            
            // Add goal payment specific buttons
            if (bill.isGoalPayment) {
                if (bill.canEdit && !bill.isGrayedOut) {
                    actionsHTML += `<button class="edit-goal-payment-btn" onclick="editGoalPayment(${bill.id})"> Edit</button>`;
                    const lockIcon = bill.isLocked ? '' : '';
                    const lockText = bill.isLocked ? 'Unlock' : 'Lock';
                    actionsHTML += `<button class="lock-goal-payment-btn" onclick="toggleGoalPaymentLock(${bill.id})">${lockIcon} ${lockText}</button>`;
                }
            }
            
            actionsHTML += `<button class="remove-btn"></button>`;

            tr.innerHTML = `
                <td colspan="5">
                    <div class="mobile-bill-layout">
                        <div class="mobile-bill-date">
                             <div class="date-box">
                                <span class="month">${month}</span>
                                <span class="day">${day}</span>
                            </div>
                        </div>
                        <div class="mobile-bill-info">
                            ${nameHtml}
                            <div class="bill-status">${countdownHtml}</div>
                        </div>
                        <div class="mobile-bill-amount">${amountDisplay}</div>
                        <div class="mobile-bill-actions">${actionsHTML}</div>
                    </div>
                </td>`;
        } else {
            tr.innerHTML = `
                <td><div class="due-date-cell"><div class="date-box"><span class="month">${month}</span><span class="day">${day}</span></div><div class="date-info">${countdownHtml}</div></div></td>
                <td class="bill-details-cell">${nameHtml}<div class="bill-sub-details"><span class="bill-category-badge">${bill.category}</span><span class="bill-frequency-badge">${bill.frequency}</span></div></td>
                <td><div class="bill-notes">${bill.notes || '-'}</div></td>
                <td class="bill-amount-cell">${amountDisplay}</td>
                <td class="actions-cell">
                    <button class="details-btn">Details</button>
                    <button class="pay-btn">Paid </button>
                    <button class="pending-btn">Pending</button>
                    <button class="unpay-btn">Unpaid </button>
                    ${bill.isGoalPayment && bill.canEdit && !bill.isGrayedOut ? `
                        <button class="edit-goal-payment-btn" onclick="editGoalPayment(${bill.id})"> Edit</button>
                        <button class="lock-goal-payment-btn" onclick="toggleGoalPaymentLock(${bill.id})">${bill.isLocked ? ' Unlock' : ' Lock'}</button>
                    ` : ''}
                    <button class="remove-btn"></button>
                </td>`;
        }

        if (!isInitialLoad && bill.justAdded) {
            animateEnter(tr);
            delete bill.justAdded;
        }
        return tr;
    }
    function getPaydaysForMonth(year, month) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';

        while (currentPayday.getFullYear() > year || (currentPayday.getFullYear() === year && currentPayday.getMonth() > month)) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() - 1);
            else break;
        }

        while (currentPayday.getFullYear() < year || (currentPayday.getFullYear() === year && currentPayday.getMonth() <= month)) {
            if (currentPayday.getFullYear() === year && currentPayday.getMonth() === month) {
                paydays.push(currentPayday.getDate());
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() + 1);
            else break;
        }
        return paydays;
    }

    function getPaydaysInRange(startDate, endDate) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';

        // Rewind to before the start date
        while (currentPayday > startDate) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') {
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() - 1);
                if (currentPayday.getDate() !== d) currentPayday.setDate(0); // handle end of month
            }
            else break;
        }

        // Fast-forward through the range
        while (currentPayday <= endDate) {
            if (currentPayday >= startDate) {
                paydays.push(new Date(currentPayday));
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') {
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() + 1);
                if (currentPayday.getDate() !== d) currentPayday.setDate(0); // handle end of month
            }
            else break;
        }
        return paydays;
    }

    function getBillsForDate(targetDate) {
        const targetYear = targetDate.getFullYear();
        const targetMonth = targetDate.getMonth();
        const targetDay = targetDate.getDate();

        return bills.filter(bill => {
            const billDate = new Date(bill.date + 'T00:00:00');
            const billYear = billDate.getFullYear();
            const billMonth = billDate.getMonth();
            const billDay = billDate.getDate();

            if (billDate > targetDate && bill.frequency === 'One-Time') {
                return false;
            }

            switch (bill.frequency) {
                case 'One-Time':
                    return targetYear === billYear && targetMonth === billMonth && targetDay === billDay;
                case 'Weekly': {
                    if (targetDate < billDate) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % 7 === 0;
                }
                case 'Bi-Weekly': {
                    if (targetDate < billDate) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % 14 === 0;
                }
                case 'Monthly':
                    return billDay === targetDay && targetDate >= billDate;
                case 'Quarterly':
                    {
                        if (billDay !== targetDay || targetDate < billDate) return false;
                        const monthDiff = (targetYear - billYear) * 12 + (targetMonth - billMonth);
                        return monthDiff >= 0 && monthDiff % 3 === 0;
                    }
                case 'Annually':
                    return billMonth === targetMonth && billDay === targetDay && targetDate >= billDate;
                case 'Custom': {
                    if (targetDate < billDate || !bill.customFrequencyDays || bill.customFrequencyDays <= 0) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % bill.customFrequencyDays === 0;
                }
                default:
                    return false;
            }
        });
    }

    function renderCalendar() {
        calendarView.innerHTML = '';
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const monthName = calendarDate.toLocaleString('default', { month: 'long' });

        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.innerHTML = `
            <button id="prevMonthBtn" title="Previous Month" class="ctrl-btn"></button>
            <h2>${monthName} ${year}</h2>
            <span style="display: flex; gap: 8px;">
                <button id="printCalendarBtn" title="Print Calendar" class="ctrl-btn"></button>
                <button id="nextMonthBtn" title="Next Month" class="ctrl-btn"></button>
            </span>
        `;
        calendarView.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'calendar-grid-container';
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        grid.innerHTML += weekdays.map(day => `<div class="calendar-day-name">${day}</div>`).join('');

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const paydays = getPaydaysForMonth(year, month);
        const today = new Date();
        today.setHours(0,0,0,0);

        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day other-month';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }

            const currentDate = new Date(year, month, day);
            currentDate.setHours(0,0,0,0);

            const allBillsForDay = getBillsForDate(currentDate);
            const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
            
            const effectiveBills = allBillsForDay.map(bill => {
                if (bill.frequency === 'One-Time') {
                    return { ...bill, displayStatus: bill.status };
                }
                // For recurring bills, check if a corresponding one-time payment was made on this specific day
                const paidInstance = oneTimePaidBills.find(p => {
                    const paidDate = new Date(p.date + 'T00:00:00');
                    return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === currentDate.getTime();
                });
                return { ...bill, displayStatus: paidInstance ? 'paid' : bill.status };
            });

            // The bubble should only show for bills that are not yet paid.
            const unpaidBillsOnDay = effectiveBills.filter(b => b.displayStatus !== 'paid');

            const dayNumberHTML = `<div class="day-number">${day}</div>`;
            let balanceHTML = '';
            const dailyTotal = effectiveBills.reduce((sum, bill) => {
                return (bill.displayStatus !== 'paid') ? sum + getUserShare(bill) : sum;
            }, 0);

            if (dailyTotal > 0) {
                balanceHTML = `<div class="day-balance negative">${formatCurrency(dailyTotal)}</div>`;
            }

            let billsHTML = '';
            // Use the count of all effective bills for the bubble, so paid items are included in the count
            if (paydays.includes(day)) {
                billsHTML = `<div class="day-bill-count" style="width: 20px; height: 20px; font-size: 14px;"></div>`;
            } else if (effectiveBills.length > 0) {
                billsHTML = `<div class="day-bill-count">${effectiveBills.length}</div>`;
            }

            dayCell.innerHTML = `
                ${dayNumberHTML}
                <div class="bills-on-day">${billsHTML}</div>
                <div class="day-balance-container">${balanceHTML}</div>
            `;
            grid.appendChild(dayCell);
        }
        calendarView.appendChild(grid);
    }
    function renderPendingBills() {
        pendingBillsList.innerHTML = '';
        const pending = bills.filter(b => b.status === 'pending')
                               .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (pending.length === 0) {
            pendingBillsList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No pending bills.</p>';
            return;
        }

        pending.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item';
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            pendingBillsList.appendChild(item);
        });
    }
    function renderNext30Days() {
        next30DaysList.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);

        const next30 = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status !== 'paid' && billDate >= today && billDate <= thirtyDaysFromNow;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        if (next30.length === 0) {
            next30DaysList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No bills due in the next 30 days.</p>';
            return;
        }

        next30.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item';
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            next30DaysList.appendChild(item);
        });
    }
    function renderTheTab() {
        debtList.innerHTML = '';
        const sortedDebts = [...debts].sort((a, b) => (a.status === 'satisfied' ? 1 : -1) || new Date(b.date) - new Date(a.date));

        if (sortedDebts.length === 0) {
            debtList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No outstanding debts owed to you.</p>';
            return;
        }

        sortedDebts.forEach(debt => {
            const item = document.createElement('div');
            item.className = 'debt-item';
            item.dataset.id = debt.id;
            
            const paidAmount = debt.paidAmount || 0;
            const remainingAmount = debt.amount - paidAmount;
            
            if (remainingAmount <= 0) {
                debt.status = 'satisfied';
            }

            if (debt.status === 'satisfied') {
                item.classList.add('satisfied');
            }

            const payBtn = debt.status !== 'satisfied'
                ? `<button class="pay-btn make-payment-btn" title="Make Payment">Pay</button>`
                : '';

            const amountText = debt.status === 'satisfied' 
                ? `Paid: ${formatCurrency(debt.amount)}` 
                : `Remaining: ${formatCurrency(remainingAmount)} of ${formatCurrency(debt.amount)}`;

            item.innerHTML = `
                <div class="debt-details">
                    <span class="debt-name">${debt.name}</span>
                    <span class="debt-subtext">${amountText}</span>
                    <span class="debt-subtext">On ${debt.date} - ${debt.notes || 'No notes'}</span>
                </div>
                <div class="debt-actions">
                    ${payBtn}
                    <button class="remove-btn dismiss-debt-btn" title="Dismiss Debt"></button>
                </div>
            `;
            debtList.appendChild(item);
        });
    }
    function updateSummary() {
        const balance = parseFloat(currentBalance.value) || 0;
        const pendingTotal = bills.filter(b => b.status === 'pending').reduce((sum, bill) => sum + getUserShare(bill), 0);
        const availableBalance = balance - pendingTotal;

        $('totalAmountLabel').textContent = 'Available Balance';
        totalAmountEl.textContent = formatCurrency(availableBalance);

        const actualBalanceEl = $('actualBalance');
        if (pendingTotal > 0) {
            actualBalanceEl.textContent = `Actual: ${formatCurrency(balance)}`;
            actualBalanceEl.style.display = 'block';
        } else {
            actualBalanceEl.style.display = 'none';
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tenDaysFromNow = new Date();
        tenDaysFromNow.setDate(today.getDate() + 10);

        const dueInNext10Days = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status === 'unpaid' && billDate >= today && billDate <= tenDaysFromNow;
        });

        const totalDue = dueInNext10Days.reduce((sum, bill) => sum + getUserShare(bill), 0);
        totalDueNext10DaysEl.textContent = formatCurrency(totalDue);

        // Projected balance calculation
        const projectedBalanceEl = $('projected10Day');
        const paydaysIn10Days = getPaydaysInRange(today, tenDaysFromNow);
        const incomeIn10Days = paydaysIn10Days.length * (parseFloat(paycheckAmount.value) || 0);
        const projectedBalance = availableBalance - totalDue + incomeIn10Days;
        projectedBalanceEl.textContent = `Est. balance after 10 days: ${formatCurrency(projectedBalance)}`;
        projectedBalanceEl.style.display = 'block';
    }

    // --- MODAL & EDITING ---
    function resolveModal(value) {
        if (activeModalResolve) {
            let returnValue = value;
            const modalInput = $('modal-input');
            if (modalInput) {
                returnValue = (value !== 'cancel') ? modalInput.value : 'cancel';
            }
            activeModalResolve(returnValue);
            activeModalResolve = null;
        }
        genericModal.classList.remove('visible');
    }

    function showModal({ title, text, customHTML = '', input = null, buttons = [] }) {
        genericModalTitle.textContent = title;

        if (customHTML) {
            genericModalContent.innerHTML = customHTML;
        } else {
            let contentHTML = `<p id="genericModalText" style="line-height: 1.5; margin: 16px 0; white-space: pre-wrap;">${text}</p>`;
            if (input) {
                contentHTML += `<input id="modal-input" type="${input.type || 'text'}" placeholder="${input.placeholder || ''}" min="${input.min || ''}" step="${input.step || ''}" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px;">`;
            }
            genericModalContent.innerHTML = contentHTML;
        }

        genericModalButtons.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class || 'save-btn';
            button.addEventListener('click', () => resolveModal(btnInfo.value));
            genericModalButtons.appendChild(button);
        });

        genericModal.classList.add('visible');
        const modalInput = $('modal-input');
        if (modalInput) {
            modalInput.focus();
        }

        return new Promise(resolve => {
            activeModalResolve = resolve;
        });
    }

    function openEditModal(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        $('editModalTitle').textContent = 'Edit Bill'; // Set title for clarity
        editModal.dataset.editingId = billId;
        $('editBillName').value = bill.name;
        $('editBillAmount').value = bill.amount;
        $('editBillDate').value = bill.date;
        $('editBillCategory').innerHTML = $('billCategory').innerHTML;
        $('editBillCategory').value = bill.category;
        $('editBillFrequency').innerHTML = $('billFrequency').innerHTML;
        $('editBillFrequency').value = bill.frequency;
        $('editCustomFrequencyWrapper').style.display = bill.frequency === 'Custom' ? 'grid' : 'none';
        $('editBillCustomFrequency').value = bill.customFrequencyDays || '';
        $('editBillNotes').value = bill.notes || '';
        editSplitBillInputs.style.display = 'block';
        $('editBillSplitName').value = bill.splitWithName || '';
        $('editBillSplitAmount').value = bill.splitWithAmount || '';
        editModal.classList.add('visible');
    }
    function closeEditModal() { editModal.classList.remove('visible'); }
    function handleSaveEdit() {
        const billId = Number(editModal.dataset.editingId);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        bill.name = $('editBillName').value.trim();
        bill.amount = parseFloat($('editBillAmount').value) || 0;
        bill.date = $('editBillDate').value;
        bill.category = $('editBillCategory').value;
        bill.frequency = $('editBillFrequency').value;
        if (bill.frequency === 'Custom') {
            bill.customFrequencyDays = parseInt($('editBillCustomFrequency').value, 10) || 0;
        } else {
            delete bill.customFrequencyDays;
        }
        bill.notes = $('editBillNotes').value.trim();
        const splitName = $('editBillSplitName').value.trim();
        const splitAmount = parseFloat($('editBillSplitAmount').value) || 0;
        if (splitName && splitAmount > 0) {
            bill.isSplit = true;
            bill.splitWithName = splitName;
            bill.splitWithAmount = splitAmount;
        } else {
            bill.isSplit = false;
            bill.splitWithName = '';
            bill.splitWithAmount = 0;
        }
        saveData();
        renderApp(true);
        closeEditModal();
    }

    function showDayBreakdown(date) {
        const dayBreakdownModal = $('dayBreakdownModal');
        const dayBreakdownTitle = $('dayBreakdownTitle');
        const dayBreakdownContent = $('dayBreakdownContent');
        dayBreakdownTitle.textContent = `Breakdown for ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

        // This logic correctly determines the effective list of bills for the day
        const allBillsForDay = getBillsForDate(date);
        
        // Find all one-time paid bills that could correspond to a recurring bill on this day
        const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
        
        const effectiveBills = allBillsForDay.map(bill => {
            if (bill.frequency === 'One-Time') {
                return { ...bill, displayStatus: bill.status };
            }
            // For recurring bills, check if a corresponding one-time payment was made on this specific day
            const paidInstance = oneTimePaidBills.find(p => {
                const paidDate = new Date(p.date + 'T00:00:00');
                return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === date.getTime();
            });
            return { ...bill, displayStatus: paidInstance ? 'paid' : bill.status };
        });

        const paydaysOnDay = getPaydaysForMonth(date.getFullYear(), date.getMonth()).includes(date.getDate());
        let contentHTML = '<h3>Bills & Expenses</h3>';

        if (effectiveBills.length > 0) {
            contentHTML += '<ul class="day-breakdown-list">';
            effectiveBills.sort((a,b) => a.name.localeCompare(b.name)).forEach(bill => {
                const isExpense = bill.category === 'Expense';
                let statusClass = bill.displayStatus.toLowerCase();
                if (isExpense && statusClass === 'paid') { statusClass = 'expense'; }

                let actionId = bill.id;
                if (bill.displayStatus === 'paid' && bill.frequency !== 'One-Time') {
                    // This is a paid recurring bill. Find the actual paid instance to get its ID for the 'unpay' action.
                    const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
                    const paidInstance = oneTimePaidBills.find(p => {
                        const paidDate = new Date(p.date + 'T00:00:00');
                        // `date` is from the outer scope of showDayBreakdown
                        return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === date.getTime();
                    });
                    if (paidInstance) {
                        actionId = paidInstance.id;
                    }
                }

                let actionsHTML = '<div class="modal-bill-actions">';
                if (!isExpense) {
                    actionsHTML += `<button class="details-btn" data-bill-id="${actionId}">Details</button>`;
                }
                actionsHTML += '</div>';

                contentHTML += `
                    <li data-bill-id="${bill.id}">
                        <span class="modal-bill-details">
                            <span class="status-indicator status-${statusClass}"></span>
                            <div>
                                <span>${bill.name}</span>
                                <small style="display: block; color: var(--muted); text-transform: capitalize;">Status: ${bill.displayStatus}</small>
                            </div>
                        </span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="modal-bill-amount">${formatCurrency(getUserShare(bill))}</span>
                            ${actionsHTML}
                        </div>
                    </li>`;
            });
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No bills or expenses on this day.</p>';
        }

        contentHTML += '<h3>Income</h3>';
        if (paydaysOnDay && paycheckAmount.value > 0) {
            contentHTML += '<ul class="day-breakdown-list">';
            contentHTML += `<li><span class="modal-bill-details"><span class="status-indicator status-income"></span>Paycheck</span><span class="modal-bill-amount">${formatCurrency(parseFloat(paycheckAmount.value))}</span></li>`;
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No income on this day.</p>';
        }
        dayBreakdownContent.innerHTML = contentHTML;
        dayBreakdownModal.classList.add('visible');
    }

    function closeDayBreakdownModal() {
        $('dayBreakdownModal').classList.remove('visible');
    }

    // --- APPEARANCE & ANIMATIONS ---
    function applyLayoutMode() {
        const wasMobile = document.body.classList.contains('mobile-view');
        const isMobile = window.innerWidth <= 768;

        if (wasMobile !== isMobile) {
            document.body.classList.toggle('mobile-view', isMobile);

            const addButtonText = addBillBtnHeader.querySelector('.add-bill-text');
            const financeCard = $('financeCard');
            const pastBillsCard = $('pastBillsCard'); 

            if (isMobile) {
                if (addButtonText) addButtonText.textContent = 'Bill / Expense';
            } else {
                financeCard.setAttribute('open', '');
                pastBillsCard.removeAttribute('open'); // Ensure it starts closed on desktop too
                if (addButtonText) addButtonText.textContent = 'Add Bill';
            }
            // The logic for opening/closing the current bills card is now universal
            if (disableAutoOpenCurrentBills.checked) {
                billTrackerCard.removeAttribute('open');
            } else {
                billTrackerCard.setAttribute('open', '');
            }
            // Re-render lists after layout change to apply correct template
            renderLists(true);
        }

        if (!isAnimationRunning) {
            isAnimationRunning = true;
            requestAnimationFrame(mainLoop);
        }
    }

    function applyTheTab() {
        theTabRow.style.display = enableTheTab.checked ? '' : 'none';
        if (enableTheTab.checked) {
            renderTheTab();
        }
    }

    function applySummaryBlur() {
        const shouldBlur = blurSummary.checked;
        [totalAmountEl, totalDueNext10DaysEl].forEach(el => {
            el.classList.toggle('privacy-blurred', shouldBlur);
        });
    }

    function applyAllAppearance() {
        applyMaterialStyle();
        applyGlassEffect();
        applyCornerRadius();
        applyGlassShadow();
        applySlideSpeed();
        updateWallpaper();
        applyAmbianceSettings();
        applyTheTab();
        applySummaryBlur();
        applyLayoutMode();
    }
    function populateStyleSelector() {
        uiStyleSelect.innerHTML = '';
        for (const key in materialPresets.glass.styles) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = materialPresets.glass.styles[key].name;
            uiStyleSelect.appendChild(option);
        }
    }
    function applyMaterialStyle() {
        const isDark = document.documentElement.classList.contains('dark');
        const selectedStyle = uiStyleSelect.value || 'twilight';
        if(materialPresets.glass.styles[selectedStyle]){
            const tint = materialPresets.glass.styles[selectedStyle][isDark ? 'dark' : 'light'];
            document.documentElement.style.setProperty('--glass-tint', tint);
        }
    }
    function applyGlassEffect() {
        const opacity = glassOpacity.value / 100;
        const blur = glassBlurSlider.value;
        document.documentElement.style.setProperty('--glass-alpha', opacity);

        // When opacity is 100%, neutralize backdrop-filter to prevent "see-through" effect
        if (parseInt(glassOpacity.value, 10) >= 100) {
            document.documentElement.style.setProperty('--glass-backdrop-blur', '0px');
            document.documentElement.style.setProperty('--glass-backdrop-sat', '100%');
        } else {
            // Restore user-defined blur and default saturation for the glass effect
            document.documentElement.style.setProperty('--glass-backdrop-blur', `${blur}px`);
            document.documentElement.style.setProperty('--glass-backdrop-sat', '150%');
        }

        $('glassOpacityPct').textContent = `${glassOpacity.value}%`;
        $('glassBlurPct').textContent = `${blur}px`;
    }
    function applyCornerRadius() {
        const radius = cornerRadiusSlider.value;
        document.documentElement.style.setProperty('--border-radius', `${radius}px`);
        $('cornerRadiusPct').textContent = `${radius}px`;
    }
    function applyGlassShadow() {
        const value = glassShadowSlider.value;
        const isDark = document.documentElement.classList.contains('dark');
        const blur = isDark ? 20 + (value / 100) * 60 : 10 + (value / 100) * 40;
        const alpha = isDark ? 0.2 + (value / 100) * 0.4 : 0.08 + (value / 100) * 0.2;
        document.documentElement.style.setProperty('--glass-shadow-blur', `${blur}px`);
        document.documentElement.style.setProperty('--glass-shadow-alpha', alpha.toFixed(3));
        const cue = $('shadowCue');
        const yOffset = isDark ? 18 : 8;
        cue.style.boxShadow = `0 ${yOffset}px ${blur}px rgba(0,0,0,${alpha})`;
    }

    function updateWallpaper() {
        customBackgroundOptions.style.display = enableCustomBackground.checked ? 'block' : 'none';
        if (!enableCustomBackground.checked) { document.body.style.backgroundImage = ''; return; }
        const type = backgroundType.value;
        $('imageWallpaperControls').style.display = type === 'image' ? 'block' : 'none';
        $('colorWallpaperControls').style.display = type === 'color' ? 'block' : 'none';
        gradientSpinControls.style.display = gradientSpinToggle.checked ? 'flex' : 'none';
        if (type === 'image') {
            const wallpaper = localStorage.getItem('summitForecast.wallpaper');
            document.body.style.backgroundImage = wallpaper ? `url(${wallpaper})` : '';
        } else if (type === 'color') {
            document.body.style.backgroundImage = `linear-gradient(${gradientAngle.value}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        } else {
            document.body.style.backgroundImage = '';
        }
    }
    const applySlideSpeed = () => {
        $('slideSpeedPct').textContent = `${slideSpeed.value} px/s`;
    };
    function animateEnter(tr){ 
        if(!enableNaturalSlide.checked) return; 
        const speed = parseFloat(slideSpeed.value) || 1000;
        const duration = (tr.offsetHeight / speed) * 1000;
        document.documentElement.style.setProperty('--slide-duration', `${duration}ms`);
        tr.classList.add('slide-enter'); 
        requestAnimationFrame(() => { 
            tr.classList.add('slide-enter-active'); 
            setTimeout(() => tr.classList.remove('slide-enter','slide-enter-active'), duration); 
        }); 
    }
    function animateRemove(tr, callback){ 
        if(!enableNaturalSlide.checked){ tr.remove(); callback(); return; } 
        const speed = parseFloat(slideSpeed.value) || 1000;
        const duration = (tr.offsetHeight / speed) * 1000;
        document.documentElement.style.setProperty('--slide-duration', `${duration}ms`);
        tr.style.height = `${tr.offsetHeight}px`; 
        tr.classList.add('slide-out'); 
        requestAnimationFrame(() => { 
            tr.classList.add('collapsing'); 
        }); 
        setTimeout(() => { 
            if(tr.parentNode) { tr.remove(); } 
            callback(); 
        }, duration);
    }

    function applyAmbianceSettings() {
        ambianceSettings.style.display = enableAmbiance.checked ? 'block' : 'none';
        ambianceControls.style.display = enableAmbiance.checked && ambianceSelect.value !== 'none' ? 'block' : 'none';
        ['snowControls', 'orbsControls', 'starfieldControls'].forEach(c => $(c).style.display = 'none');
        ambianceParticles = [];
        ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
        if (enableAmbiance.checked) {
            const effect = ambianceSelect.value;
            if (effect === 'none') return;
            $(effect + 'Controls').style.display = 'block';
            let density = 100;
            if (effect === 'snowflakes') density = snowDensity.value;
            else if (effect === 'orbs') density = orbsDensity.value;
            else if (effect === 'starfield') density = starfieldDensity.value;
            for (let i = 0; i < density; i++) {
                if (effect === 'snowflakes') ambianceParticles.push(createSnowflake(true));
                else if (effect === 'orbs') ambianceParticles.push(createOrb(true));
                else if (effect === 'starfield') ambianceParticles.push(createStar(true));
            }
        }
    }

    function createSnowflake(isInitial = false) {
        const size = (Math.random() * (snowSize.value / 10) + 1);
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height : -size, size: size, speed: (Math.random() * (snowSpeed.value / 20) + 0.5), opacity: Math.random() * 0.5 + 0.3, update: function() { this.y += this.speed; this.x += Math.sin(this.y/50)*0.5; }, draw: function() { ctxAmbiance.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); }, isOutOfBounds: function() { return this.y > ambianceCanvas.height + this.size; } };
    }

    function createOrb(isInitial = false) {
        const size = Math.random() * (orbsSize.value / 10) + 5;
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height : ambianceCanvas.height + size, size: size, speed: (Math.random() * (orbsSpeed.value / 20) + 0.1), color: orbsColor.value, update: function() { this.y -= this.speed; }, draw: function() { ctxAmbiance.fillStyle = this.color; ctxAmbiance.globalAlpha = 0.5; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); ctxAmbiance.globalAlpha = 1; }, isOutOfBounds: function() { return this.y < -this.size; } };
    }

    function createStar(isInitial = false) {
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height: 0, size: Math.random() * 1.5 + 0.5, speed: (Math.random() * (starfieldSpeed.value / 10) + 0.1), update: function() { this.y += this.speed; if (this.y > ambianceCanvas.height) {this.y = 0; this.x = Math.random() * ambianceCanvas.width;} }, draw: function() { ctxAmbiance.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctxAmbiance.fillRect(this.x, this.y, this.size, this.size); }, isOutOfBounds: function() { return false; } };
    }

    function mainLoop() {
        if (!isAnimationRunning) return;

        if (gradientSpinToggle.checked && enableCustomBackground.checked && backgroundType.value === 'color') {
            const currentAngle = parseFloat(gradientAngle.value);
            gradientAnimationAngle = (gradientAnimationAngle + (parseFloat(gradientSpinSpeed.value) / 200)) % 360;
            document.body.style.backgroundImage = `linear-gradient(${currentAngle + gradientAnimationAngle}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        }

        if (enableAmbiance.checked && ambianceSelect.value !== 'none') {
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
            ambianceParticles.forEach((p, index) => {
                p.update();
                p.draw();
                if (p.isOutOfBounds()) ambianceParticles.splice(index, 1);
            });
            const effect = ambianceSelect.value;
            let targetDensity = 0;
            if (effect === 'snowflakes') targetDensity = snowDensity.value;
            else if (effect === 'orbs') targetDensity = orbsDensity.value;
            else if (effect === 'starfield') targetDensity = starfieldDensity.value;
            if (ambianceParticles.length < targetDensity) {
                 if (effect === 'snowflakes') ambianceParticles.push(createSnowflake());
                 else if (effect === 'orbs') ambianceParticles.push(createOrb());
            }
        } else if (ambianceParticles.length > 0) {
            ambianceParticles = [];
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
        }
        requestAnimationFrame(mainLoop);
    }

    // --- EVENT HANDLERS ---
    const handleAddBill = async () => {
        const name = $('billName').value.trim();
        if (!name) {
            await showModal({ title: 'Missing Information', text: 'Please enter at least a bill name.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
            return;
        }
        const amount = parseFloat($('billAmount').value) || 0;
        const date = $('billDate').value || new Date().toISOString().split('T')[0];
        const newBill = { id: Date.now(), name, amount, date, category: $('billCategory').value, frequency: $('billFrequency').value, notes: $('billNotes').value.trim(), status: 'unpaid', isSplit: false, justAdded: true };
        if (newBill.frequency === 'Custom') {
            newBill.customFrequencyDays = parseInt($('billCustomFrequency').value, 10) || 0;
        }
        const splitName = $('billSplitName').value.trim();
        const splitAmount = parseFloat($('billSplitAmount').value);
        if (splitName && splitAmount > 0) {
            newBill.isSplit = true; newBill.splitWithName = splitName; newBill.splitWithAmount = splitAmount;
            if (newBill.splitWithAmount >= amount && amount > 0) {
                await showModal({ title: 'Invalid Split', text: "The other person's share cannot be greater than or equal to the total amount.", buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
        }
        bills.push(newBill); addBillForm.reset(); $('billDate').value = new Date().toISOString().split('T')[0];
        addBillModal.classList.remove('visible');
        saveData(); renderApp();
    };

    const handleAddExpense = (desc, amount, modalToClose = null) => {
        if (desc && amount > 0) {
            const newExpenseAsBill = { id: Date.now(), name: desc, amount: amount, date: new Date().toISOString().split('T')[0], category: 'Expense', frequency: 'One-Time', notes: 'Logged as a one-time expense.', status: 'paid', isSplit: false, justAdded: true, paidTimestamp: new Date().toISOString() };
            bills.push(newExpenseAsBill);
            if (!dontAutoDeduct.checked) {
                const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                currentBalance.value = (currentBalanceVal - amount).toFixed(2);
            }
            saveData(); renderApp();
            expenseForm.reset();
            toggleExpenseView(false);

            if (modalToClose) {
                modalToClose.classList.remove('visible');
            }
        }
    };

    const handleCustomExpenseSubmit = (e) => { e.preventDefault(); const desc = $('expenseDescription').value.trim(); const amount = parseFloat($('expenseAmount').value); handleAddExpense(desc, amount); };
    const handleQuickExpense = async (e) => {
        const expenseType = e.target.closest('.quick-expense-btn').dataset.expense;
        const result = await showModal({
            title: `Log Expense: ${expenseType}`,
            customHTML: `<label for="modal-input" style="font-size: 14px; color: var(--muted);">Enter Amount:</label><input type="number" id="modal-input" placeholder="0.00" step="0.01" required>`,
            buttons: [
                { text: 'Log Expense', value: 'log', class: 'save-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
            ]
        });

        const amount = parseFloat(result);
        if (result !== 'cancel' && amount > 0) {
            const modalToClose = e.target.closest('.modal-overlay');
            handleAddExpense(expenseType, amount, modalToClose);
        }
    };
    const toggleExpenseView = (showCustom, isModal = false) => {
        const quickOpts = isModal ? $('expenseModalQuickOptions') : $('expenseQuickOptions');
        const form = isModal ? $('expenseModalForm') : $('expenseForm');
        quickOpts.style.display = showCustom ? 'none' : 'grid';
        form.style.display = showCustom ? 'flex' : 'none';
    };

    const handleListClick = async (e) => {
        const tr = e.target.closest('tr'); if (!tr) return;
        const billId = Number(tr.dataset.id);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        const target = e.target;

        if (target.matches('.details-btn')) {
            openEditModal(billId);
            return;
        }

        if (target.matches('.pay-btn')) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(bill.date + 'T00:00:00');
            const diffDays = Math.round((dueDate.getTime() - today.getTime()) / 864e5);
            if (diffDays > 10) {
                await showModal({ title: 'Notice', text: 'Bills cannot be marked as paid more than 10 days in advance.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
            const oldStatus = bill.status;
            const isRecurring = bill.frequency !== 'One-Time';
            const paidTimestamp = new Date().toISOString();

            if (!isRecurring) {
                bill.status = 'paid';
                bill.paidTimestamp = paidTimestamp;
            } else {
                const paidInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: bill.notes || 'Recurring payment.', paidTimestamp: paidTimestamp };
                bills.push(paidInstance);
                const nextDueDate = new Date(bill.date + 'T00:00:00');
                if (bill.frequency === 'Weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                else if (bill.frequency === 'Bi-Weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                else if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                else if (bill.frequency === 'Custom' && bill.customFrequencyDays > 0) {
                    nextDueDate.setDate(nextDueDate.getDate() + bill.customFrequencyDays);
                }
                bill.date = nextDueDate.toISOString().split('T')[0];
                bill.status = 'unpaid';
            }
            if (!dontAutoDeduct.checked && oldStatus !== 'paid') {
                const share = getUserShare(bill);
                currentBalance.value = ((parseFloat(currentBalance.value) || 0) - share).toFixed(2);
            }
            
            // If this is a goal payment, update the goal's saved amount
            if (bill.isGoalPayment && bill.goalId) {
                const goal = goals.find(g => g.id === bill.goalId);
                if (goal) {
                    goal.savedAmount = (goal.savedAmount || 0) + bill.amount;
                    goal.lastPayment = { amount: bill.amount, date: new Date().toISOString() };
                    console.log(`Goal ${goal.name} updated: $${bill.amount} added`);
                }
                // Lock the bill when it's paid
                bill.isLocked = true;
                updateGoalPaymentEditability(bill.goalId);
            }
            
            saveData(); renderApp(true);
        } else if (target.matches('.pending-btn')) {
            bill.status = 'pending'; saveData(); renderApp(true);
        } else if (target.matches('.unpay-btn')) {
            if (bill.status === 'pending') { bill.status = 'unpaid'; saveData(); renderApp(true); return; }
            const share = getUserShare(bill);
            const choice = await showModal({
                title: 'Confirm Un-Pay',
                text: `This will delete the payment record for "${bill.name}" and add ${formatCurrency(share)} back to your balance (if auto-deduct is enabled). Are you sure?`,
                buttons: [
                    { text: 'Yes, Un-Pay', value: 'confirm', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'confirm') {
                if (!dontAutoDeduct.checked) {
                    currentBalance.value = ((parseFloat(currentBalance.value) || 0) + share).toFixed(2);
                }
                
                // If this is a goal payment, deduct from the goal's saved amount
                if (bill.isGoalPayment && bill.goalId) {
                    const goal = goals.find(g => g.id === bill.goalId);
                    if (goal) {
                        goal.savedAmount = Math.max(0, (goal.savedAmount || 0) - bill.amount);
                        console.log(`Goal ${goal.name} updated: $${bill.amount} deducted`);
                    }
                    // Unlock the bill when it's unpaid (if it was previously paid)
                    bill.isLocked = false;
                    updateGoalPaymentEditability(bill.goalId);
                }
                
                animateRemove(tr, () => { bills = bills.filter(b => b.id !== billId); saveData(); renderApp(true); });
            }
        } else if (target.matches('.remove-btn')) {
            // Check if this is a goal payment
            if (bill.isGoalPayment && bill.goalId) {
                const goal = goals.find(g => g.id === bill.goalId);
                const goalName = goal ? goal.name : 'Unknown Goal';
                
                const result = await showModal({
                    title: `Manage Goal Payment`,
                    text: `This payment is part of your "${goalName}" goal. You can mark it as paid or pending, but to delete or modify the amount, please use the Goals tool where you can set it to $0 or make other adjustments.`,
                    buttons: [
                        { text: ' Open Goals Tool', value: 'goals', class: 'save-btn' },
                        { text: 'OK', value: 'ok', class: 'cancel-btn' },
                    ]
                });
                
                if (result === 'goals') {
                    // Switch to goals tab and open the goal edit modal
                    goalsTabBtn.click();
                    setTimeout(() => {
                        window.editGoal(bill.goalId);
                    }, 100);
                }
            } else {
                // Regular bill deletion logic
                const choice = await showModal({
                    title: `Manage "${bill.name}"`,
                    text: `Delete this bill permanently (including future occurrences), or just dismiss this single occurrence without affecting your balance?`,
                    buttons: [
                        { text: 'Delete Bill', value: 'delete', class: 'danger-btn' },
                        { text: 'Dismiss Bill', value: 'dismiss', class: 'special-btn' },
                        { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
                    ]
                });

                if (choice === 'delete') {
                    animateRemove(tr, () => {
                        bills = bills.filter(b => b.id !== billId);
                        saveData();
                        renderApp(true);
                    });
                } else if (choice === 'dismiss') {
                    const isRecurring = bill.frequency === 'Monthly' || bill.frequency === 'Quarterly' || bill.frequency === 'Annually';
                    const paidTimestamp = new Date().toISOString();
                    if (!isRecurring) {
                        bill.status = 'paid';
                        bill.paidTimestamp = paidTimestamp;
                    } else {
                        const dismissedInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: `Dismissed for this cycle.`, paidTimestamp: paidTimestamp };
                        bills.push(dismissedInstance);
                        const nextDueDate = new Date(bill.date + 'T00:00:00');
                        if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                        else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                        else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                        bill.date = nextDueDate.toISOString().split('T')[0];
                    }
                    saveData();
                    renderApp(true);
                }
            }
        }
    };

    const handleModalActionClick = async (e) => {
        const target = e.target.closest('.modal-bill-actions button');
        if (!target) return;

        const billId = Number(target.dataset.billId);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;

        if (target.matches('.details-btn')) {
            closeDayBreakdownModal();
            openEditModal(billId);
            return;
        }

        if (target.matches('.pay-btn')) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(bill.date + 'T00:00:00');
            const diffDays = Math.round((dueDate.getTime() - today.getTime()) / 864e5);
            if (diffDays > 10) {
                await showModal({ title: 'Notice', text: 'Bills cannot be marked as paid more than 10 days in advance.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
            const oldStatus = bill.status;
            const isRecurring = bill.frequency !== 'One-Time';
            const paidTimestamp = new Date().toISOString();

            if (!isRecurring) {
                bill.status = 'paid';
                bill.paidTimestamp = paidTimestamp;
            } else {
                const paidInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: bill.notes || 'Recurring payment.', paidTimestamp: paidTimestamp };
                bills.push(paidInstance);
                const nextDueDate = new Date(bill.date + 'T00:00:00');
                if (bill.frequency === 'Weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                else if (bill.frequency === 'Bi-Weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                else if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                else if (bill.frequency === 'Custom' && bill.customFrequencyDays > 0) {
                    nextDueDate.setDate(nextDueDate.getDate() + bill.customFrequencyDays);
                }
                bill.date = nextDueDate.toISOString().split('T')[0];
                bill.status = 'unpaid';
            }
            if (!dontAutoDeduct.checked && oldStatus !== 'paid') {
                const share = getUserShare(bill);
                currentBalance.value = ((parseFloat(currentBalance.value) || 0) - share).toFixed(2);
            }
        } else if (target.matches('.pending-btn')) {
            bill.status = 'pending';
        } else if (target.matches('.unpay-btn')) {
            if (bill.status === 'pending') {
                bill.status = 'unpaid';
            } else {
                const share = getUserShare(bill);
                 const choice = await showModal({
                    title: 'Confirm Un-Pay',
                    text: `This will delete the payment record for "${bill.name}" and add ${formatCurrency(share)} back to your balance (if auto-deduct is enabled). Are you sure?`,
                    buttons: [
                        { text: 'Yes, Un-Pay', value: 'confirm', class: 'danger-btn' },
                        { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                    ]
                });

                if (choice === 'confirm') {
                    if (!dontAutoDeduct.checked) {
                        currentBalance.value = ((parseFloat(currentBalance.value) || 0) + share).toFixed(2);
                    }
                    bills = bills.filter(b => b.id !== billId);
                } else {
                    return; // Do not re-render if cancelled
                }
            }
        }

        saveData();
        closeDayBreakdownModal();
        renderApp(true);
    };

    const handleListDoubleClick = (e) => { const tr = e.target.closest('tr[data-id]'); if (tr && !e.target.closest('.actions-cell, .mobile-bill-actions')) openEditModal(Number(tr.dataset.id)); };
    const handleToggleDarkMode = () => { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); darkToggle.innerHTML = isDark ? '' : ''; applyMaterialStyle(); applyGlassShadow(); saveData(); };
    const handleWallpaperFile = async (e) => {
        const file = e.target.files[0];
        if (file && file.size < 5*1024*1024) {
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('summitForecast.wallpaper', e.target.result);
                updateWallpaper();
                saveData();
            };
            reader.readAsDataURL(file);
        } else if (file) {
            await showModal({ title: 'File Too Large', text: 'Please select an image smaller than 5MB.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
        }
    };
    const handleCalendarNav = (e) => {
        const dayCell = e.target.closest('.calendar-day');
        if (dayCell && !dayCell.classList.contains('other-month')) {
            const day = dayCell.querySelector('.day-number').textContent;
            const date = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), day);
            showDayBreakdown(date); return;
        }
        let reRender = false;
        if (e.target.closest('#prevMonthBtn')) { calendarDate.setMonth(calendarDate.getMonth() - 1); reRender = true; }
        else if (e.target.closest('#nextMonthBtn')) { calendarDate.setMonth(calendarDate.getMonth() + 1); reRender = true; }
        else if (e.target.closest('#printCalendarBtn')) { window.print(); }
        if (reRender) { renderCalendar(); }
    };

    function handleExportProfile() {
        try {
            const profileData = { bills: JSON.parse(localStorage.getItem('summitForecast.bills') || '[]'), debts: JSON.parse(localStorage.getItem('summitForecast.debts') || '[]'), settings: JSON.parse(localStorage.getItem('summitForecast.settings') || '{}'), wallpaper: localStorage.getItem('summitForecast.wallpaper') || null };
            const blob = new Blob([JSON.stringify(profileData, null, 2)], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "SummitForecast_Profile.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) { console.error("Failed to export profile:", error); showModal({ title: 'Error', text: 'Could not export profile.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]}); }
    }

    function handleImportProfile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json,.json';
        input.onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const profileData = JSON.parse(event.target.result);
                    if (profileData && profileData.bills && profileData.settings) {
                        localStorage.setItem('summitForecast.bills', JSON.stringify(profileData.bills));
                        localStorage.setItem('summitForecast.settings', JSON.stringify(profileData.settings));
                    if (profileData.debts) {
                        localStorage.setItem('summitForecast.debts', JSON.stringify(profileData.debts));
                    }
                        if (profileData.wallpaper) { localStorage.setItem('summitForecast.wallpaper', profileData.wallpaper); }
                        else { localStorage.removeItem('summitForecast.wallpaper'); }
                        await showModal({ title: 'Success', text: 'Profile imported successfully! The application will now reload.', buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]});
                        location.reload();
                    } else {
                        await showModal({ title: 'Error', text: 'Invalid profile file.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                    }
                } catch (error) {
                    console.error("Failed to import profile:", error);
                    await showModal({ title: 'Error', text: 'Could not import profile.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    async function handleUnpaidTool() {
        const days = parseInt($('unpaidDays').value, 10);
        if (isNaN(days) || days < 0) {
            await showModal({
                title: 'Invalid Input',
                text: 'Please enter a valid number of days.',
                buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
            });
            return;
        }

        const confirmRes = await showModal({
            title: 'Confirm Action',
            text: `Are you sure? This will mark ALL bills due after ${days} day(s) from now as 'unpaid'. This includes recurring bills and cannot be easily undone.`,
            buttons: [
                { text: 'Yes, Mark as Unpaid', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (confirmRes === 'confirm') {
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + days);
            targetDate.setHours(0, 0, 0, 0);

            let changes = 0;
            bills.forEach(bill => {
                const billDate = new Date(bill.date + 'T00:00:00');
                if (billDate >= targetDate) {
                    if(bill.status !== 'unpaid') {
                        bill.status = 'unpaid';
                        delete bill.paidTimestamp;
                        changes++;
                    }
                }
            });
            saveData();
            renderApp(true);
            await showModal({
                title: 'Success',
                text: `${changes} bill(s) were marked as unpaid.`,
                buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
            });
        }
    }

    async function handleResetProfile() {
        const choice = await showModal({
            title: 'Confirm Reset',
            text: 'Are you sure you want to reset EVERYTHING to factory defaults? All bills, financial info, and appearance settings will be permanently deleted.',
            buttons: [
                { text: 'Yes, Reset Everything', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (choice === 'confirm') {
            localStorage.removeItem('summitForecast.bills');
            localStorage.removeItem('summitForecast.settings');
            localStorage.removeItem('summitForecast.wallpaper');
            localStorage.removeItem('summitForecast.debts');
            await showModal({ title: 'Profile Reset', text: 'Your profile has been reset. The application will now reload.', buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]});
            location.reload();
        }
    }

    // --- DEMO MODE ---
    function generateDemoProfile() {
        // --- Helpers ---
        const rand = (min, max) => Math.random() * (max - min) + min;
        const randInt = (min, max) => Math.floor(rand(min, max + 1));
        const oneOf = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const toYMD = (date) => date.toISOString().split('T')[0];
        let idCounter = Date.now();

        // --- Config ---
        const demoBills = [];
        const demoDebts = [];
        let demoSettings = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lookbackStartDate = new Date(today);
        lookbackStartDate.setFullYear(today.getFullYear() - 1);

        // 1. Finances
        const annualSalary = rand(75000, 95000);
        const paycheck = parseFloat((annualSalary / 26).toFixed(2));
        let nextPayday = new Date(today);
        // Find the next Friday. If today is Friday, it's a potential payday.
        nextPayday.setDate(nextPayday.getDate() + (5 - nextPayday.getDay() + 7) % 7);
        if (randInt(0, 1) === 1) { // 50% chance the next payday is one week later
            nextPayday.setDate(nextPayday.getDate() + 7);
        }

        demoSettings.finances = {
            balance: rand(paycheck * 0.8, paycheck * 2.2).toFixed(2),
            paycheck: paycheck,
            payday: toYMD(nextPayday),
            frequency: 'Bi-Weekly'
        };
        demoSettings.theTabEnabled = true;

        // 2. Recurring Bills & Their History
        const recurringBillTemplates = [
            { name: 'Mortgage', amount: rand(1400, 1800), day: 1, category: 'Rent/Mortgage', frequency: 'Monthly' },
            { name: 'Car Payment', amount: rand(450, 600), day: 15, category: 'Loan', frequency: 'Monthly' },
            { name: 'Car Insurance', amount: rand(100, 180), day: 20, category: 'Insurance', frequency: 'Monthly' },
            { name: 'Wisconsin Public Service', amount: rand(80, 250), day: randInt(5, 25), category: 'Utilities', frequency: 'Monthly' },
            { name: 'Spectrum Internet', amount: rand(80, 100), day: randInt(5, 25), category: 'Utilities', frequency: 'Monthly' },
            { name: 'Green Bay Water Utility', amount: rand(50, 90), day: randInt(5, 25), category: 'Utilities', frequency: 'Quarterly' },
            { name: 'AT&T Cell Phone', amount: rand(80, 130), day: randInt(5, 25), category: 'Subscription', frequency: 'Monthly' },
            { name: 'Netflix/Hulu Bundle', amount: rand(25, 45), day: randInt(5, 25), category: 'Subscription', frequency: 'Monthly' },
            { name: 'Planet Fitness', amount: rand(25, 45), day: randInt(5, 25), category: 'Personal', frequency: 'Monthly' },
        ];

        recurringBillTemplates.forEach(billTmpl => {
            // Find the next due date for this bill
            let nextDueDate = new Date(today);
            nextDueDate.setDate(billTmpl.day);
            if (nextDueDate < today) {
                if (billTmpl.frequency === 'Monthly') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                } else if (billTmpl.frequency === 'Quarterly') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                }
            }

            // Create the main recurring bill (the one that shows up as upcoming)
            demoBills.push({
                id: idCounter++,
                name: billTmpl.name,
                amount: parseFloat(billTmpl.amount.toFixed(2)),
                date: toYMD(nextDueDate),
                category: billTmpl.category,
                frequency: billTmpl.frequency,
                status: 'unpaid',
                notes: 'Recurring payment'
            });

            // Now, generate the history of 'paid' bills for this recurring item
            let historicalDueDate = new Date(nextDueDate);
            while (historicalDueDate > lookbackStartDate) {
                // Move to the PREVIOUS due date
                if (billTmpl.frequency === 'Monthly') {
                    historicalDueDate.setMonth(historicalDueDate.getMonth() - 1);
                } else if (billTmpl.frequency === 'Quarterly') {
                    historicalDueDate.setMonth(historicalDueDate.getMonth() - 3);
                }

                if (historicalDueDate < lookbackStartDate) break;
                
                // Create a paid, one-time bill for this historical date
                const paidAmount = billTmpl.amount * rand(0.95, 1.05); // slight variation
                demoBills.push({
                    id: idCounter++,
                    name: billTmpl.name, // Same name to link them conceptually
                    amount: parseFloat(paidAmount.toFixed(2)),
                    date: toYMD(historicalDueDate),
                    category: billTmpl.category,
                    frequency: 'One-Time', // Historical entries are always one-time
                    status: 'paid',
                    paidTimestamp: historicalDueDate.toISOString(),
                    notes: 'Recurring payment history'
                });
            }
        });

        // 3. Historical One-Off Paid Expenses (for realism)
        const expenseTemplates = {
            Groceries: { names: ["Woodman's", "Pick 'n Save", "Festival Foods", "Meijer", "Aldi"], amount: [70, 220], perWeek: 1.2 },
            Gas: { names: ["Kwik Trip", "Shell", "BP", "Costco Gas"], amount: [40, 70], perWeek: 1 },
            Food: { names: ["Kroll's East", "Hinterland Brewery", "Chipotle", "Culver's", "Titletown Gameday"], amount: [15, 85], perWeek: 3 },
            Coffee: { names: ["Starbucks", "Colectivo Coffee", "Kwik Trip Coffee"], amount: [4, 12], perWeek: 3 },
            Personal: { names: ["Target", "Amazon Order", "Walmart", "Bay Park Square Mall"], amount: [40, 400], perWeek: 0.5 },
            Entertainment: { names: ["Resch Center Event", "Concert Ticket", "Packers Game", "Lambeau Field Tour"], amount: [50, 300], perWeek: 0.2 }
        };

        for (let d = new Date(lookbackStartDate); d <= today; d.setDate(d.getDate() + 1)) {
            Object.entries(expenseTemplates).forEach(([category, config]) => {
                if (Math.random() < config.perWeek / 7) {
                    const expenseDate = new Date(d);
                    const amount = rand(config.amount[0], config.amount[1]);
                    demoBills.push({
                        id: idCounter++,
                        name: oneOf(config.names),
                        amount: parseFloat(amount.toFixed(2)),
                        date: toYMD(expenseDate),
                        category: category,
                        frequency: 'One-Time',
                        status: 'paid',
                        paidTimestamp: expenseDate.toISOString(),
                        notes: 'One-time expense'
                    });
                }
            });
        }
        
        // 4. "The Tab" Debts
        const friends = ['Aaron', 'Jordy', 'Davante', 'Clay'];
        for(let i=0; i < randInt(2, 4); i++) {
            const debtDate = new Date(today);
            debtDate.setDate(debtDate.getDate() - randInt(1, 45));
            demoDebts.push({
                id: idCounter++,
                name: oneOf(friends),
                amount: randInt(10, 50),
                date: toYMD(debtDate),
                notes: oneOf(['For lunch', 'Concert ticket', 'Drinks at Hinterland']),
                status: 'outstanding',
                paidAmount: 0
            });
        }

        // 5. Save to localStorage
        localStorage.setItem('summitForecast.bills', JSON.stringify(demoBills));
        localStorage.setItem('summitForecast.debts', JSON.stringify(demoDebts));
        const existingSettings = JSON.parse(localStorage.getItem('summitForecast.settings') || '{}');
        const finalSettings = {...existingSettings, ...demoSettings};
        localStorage.setItem('summitForecast.settings', JSON.stringify(finalSettings));
    }


    // --- EVENT HANDLERS ---
    $('billFrequency').addEventListener('change', () => {
        $('customFrequencyWrapper').style.display = $('billFrequency').value === 'Custom' ? 'grid' : 'none';
    });
    $('editBillFrequency').addEventListener('change', () => {
        $('editCustomFrequencyWrapper').style.display = $('editBillFrequency').value === 'Custom' ? 'grid' : 'none';
    });

    // --- EVENT LISTENERS ---
    const privacyToggleBtn = $('privacyToggleBtn');
    if (privacyToggleBtn) {
        privacyToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the summary from toggling
            e.preventDefault();
            const financeStack = $('financeCard').querySelector('.stack');
            const isBlurred = financeStack.classList.toggle('blurred');
            $('actualBalance').classList.toggle('privacy-blurred', isBlurred);
            $('projected10Day').classList.toggle('privacy-blurred', isBlurred);
            privacyToggleBtn.querySelector('.eye-open').style.display = isBlurred ? 'none' : 'block';
            privacyToggleBtn.querySelector('.eye-closed').style.display = isBlurred ? 'block' : 'none';
            saveData(); // Save the new state
        });
    }
    addBillBtnHeader.addEventListener('click', async () => {
        if (document.body.classList.contains('mobile-view')) {
            const choice = await showModal({
                title: 'What would you like to add?',
                text: '',
                buttons: [
                    { text: 'Add a Bill', value: 'bill', class: 'save-btn' },
                    { text: 'Log an Expense', value: 'expense', class: 'special-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });
            if (choice === 'bill') {
                addBillModal.classList.add('visible');
            } else if (choice === 'expense') {
                toggleExpenseView(false, true); // Reset to quick options
                expenseModal.classList.add('visible');
            }
        } else {
            addBillModal.classList.add('visible');
        }
    });
    closeAddBillModalBtn.addEventListener('click', () => addBillModal.classList.remove('visible'));
    archiveBtn.addEventListener('click', () => {
        appView.style.display = 'none';
        archiveView.style.display = 'flex';
        const categories = [...new Set(bills.map(b => b.category))].sort();
        filterCategory.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(c => filterCategory.innerHTML += `<option value="${c}">${c}</option>`);
        renderArchive();
    });
    backFromArchiveBtn.addEventListener('click', () => { archiveView.style.display = 'none'; appView.style.display = 'grid'; });
    addBtn.addEventListener('click', handleAddBill);
    expenseForm.addEventListener('submit', handleCustomExpenseSubmit);
    billListBody.addEventListener('click', handleListClick);
    pastBillsListBody.addEventListener('click', handleListClick);
    archiveBillsListBody.addEventListener('dblclick', async (e) => {
        const tr = e.target.closest('tr[data-id]');
        if (tr) {
            const billId = Number(tr.dataset.id);
            const bill = bills.find(b => b.id === billId);
            if (bill && bill.paidTimestamp) {
                const paidDate = new Date(bill.paidTimestamp);
                const formattedDate = paidDate.toLocaleString([], { dateStyle: 'long', timeStyle: 'short' });
                await showModal({
                    title: `"${bill.name}"`,
                    text: `Marked as Paid on: ${formattedDate}`,
                    buttons: [{ text: 'Close', value: 'close', class: 'cancel-btn' }]
                });
            }
        }
    });
    archiveBillsListBody.addEventListener('click', async (e) => {
        if (e.target.matches('.remove-btn')) {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const billId = Number(tr.dataset.id);
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const choice = await showModal({
                title: 'Confirm Deletion',
                text: `Are you sure you want to permanently delete this paid record for "${bill.name}"? This cannot be undone.`,
                buttons: [
                    { text: 'Delete Record', value: 'delete', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'delete') {
                animateRemove(tr, () => {
                    bills = bills.filter(b => b.id !== billId);
                    saveData();
                    renderArchive();
                });
            }
        }
    });

    [filterSearchTerm, filterStartDate, filterEndDate, filterCategory].forEach(el => {
        el.addEventListener('input', renderArchive);
    });
    clearFiltersBtn.addEventListener('click', () => {
        filterSearchTerm.value = '';
        filterStartDate.value = '';
        filterEndDate.value = '';
        filterCategory.value = '';
        renderArchive();
    });

    $('customExpenseBtn').addEventListener('click', () => toggleExpenseView(true));
    $('cancelCustomExpenseBtn').addEventListener('click', () => toggleExpenseView(false));
    document.querySelectorAll('.quick-expense-btn').forEach(btn => btn.addEventListener('click', handleQuickExpense));

    // Expense Modal Listeners
    $('closeExpenseModalBtn').addEventListener('click', () => expenseModal.classList.remove('visible'));
    $('expenseModal').querySelectorAll('.quick-expense-btn').forEach(btn => btn.addEventListener('click', handleQuickExpense));
    $('customExpenseModalBtn').addEventListener('click', () => toggleExpenseView(true, true));
    $('cancelCustomExpenseModalBtn').addEventListener('click', () => toggleExpenseView(false, true));
    $('expenseModalForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = $('expenseModalDescription').value.trim();
        const amount = parseFloat($('expenseModalAmount').value);
        handleAddExpense(desc, amount, expenseModal);
        $('expenseModalForm').reset();
    });


    billListBody.addEventListener('dblclick', handleListDoubleClick);
    pastBillsListBody.addEventListener('dblclick', handleListDoubleClick);
    saveEditBtn.addEventListener('click', handleSaveEdit);
    closeModalBtn.addEventListener('click', closeEditModal);
    $('closeDayBreakdownModalBtn').addEventListener('click', closeDayBreakdownModal);
    $('dayBreakdownModal').addEventListener('click', handleModalActionClick);
    darkToggle.addEventListener('click', handleToggleDarkMode);
    menuBtn.addEventListener('click', () => { menuPanel.style.display = menuPanel.style.display === 'block' ? 'none' : 'block'; });
    closeMenuNotch.addEventListener('click', () => menuPanel.style.display = 'none');
    calendarToggleBtn.addEventListener('click', () => { currentView = currentView === 'list' ? 'calendar' : 'list'; renderApp(true); });
    calendarView.addEventListener('click', handleCalendarNav);

    // Swipe navigation for calendar on mobile
    function handleSwipeGesture() {
        const swipeThreshold = 50; // minimum distance for a swipe in pixels
        if (document.body.classList.contains('mobile-view') && currentView === 'calendar') {
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swiped left
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swiped right
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            }
        }
    }

    function handleMainViewSwipe() {
        // Ensure there was a touchstart event
        if (touchStartX === 0) return;

        const swipeThreshold = 50;
        const verticalThreshold = 75; // Don't swipe if scrolling vertically

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // Reset coordinates for the next swipe
        touchStartX = 0;
        touchStartY = 0;

        if (Math.abs(deltaX) < swipeThreshold || Math.abs(deltaY) > verticalThreshold) {
            // Not a long enough horizontal swipe, or it's mostly a vertical scroll
            return;
        }

        const isDashboardActive = dashboardTabBtn.classList.contains('active');
        const isGoalsActive = goalsTabBtn.classList.contains('active');
        const isStatisticsActive = statisticsTabBtn.classList.contains('active');

        if (isDashboardActive && deltaX < 0) { // Swiped left from Dashboard
            goalsTabBtn.click();
        } else if (isGoalsActive && deltaX < 0) { // Swiped left from Goals
            statisticsTabBtn.click();
        } else if (isGoalsActive && deltaX > 0) { // Swiped right from Goals
            dashboardTabBtn.click();
        } else if (isStatisticsActive && deltaX > 0) { // Swiped right from Statistics
            goalsTabBtn.click();
        }
    }
    calendarView.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    calendarView.addEventListener('touchend', e => {
        // Stop the event from bubbling to the main view's swipe listener
        e.stopPropagation();
        touchEndX = e.changedTouches[0].screenX;

        const swipeThreshold = 50; // minimum distance for a swipe in pixels
        
        // Ensure it's in mobile mode and the calendar is the current view
        if (document.body.classList.contains('mobile-view') && currentView === 'calendar') {
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swiped left (next month)
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swiped right (previous month)
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            }
        }
    });

    // Swipe navigation for main views
    const setupSwipeListener = (element) => {
        element.addEventListener('touchstart', e => {
            // Do not start a swipe if the user is interacting with a form element or a scrollable area
            if (e.target.closest('input, select, textarea, button, [contenteditable]')) return;
            if (e.target.closest('.scrollable, .bill-table-wrapper, #pendingBillsList, #next30DaysList, .debt-list')) return;

            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        element.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleMainViewSwipe();
        }, { passive: true });
    };
    setupSwipeListener(appView);
    setupSwipeListener(statisticsView);
    setupSwipeListener(goalsView);

    [currentBalance, paycheckAmount, nextPayday, payFrequency, dontAutoDeduct].forEach(el => el.addEventListener('input', () => { saveData(); updateSummary(); }));
    document.querySelectorAll('.menu-panel input, .menu-panel select').forEach(el => {
        const event = el.type === 'range' || el.type === 'color' ? 'input' : 'change';
        el.addEventListener(event, () => {
            applyAllAppearance();
            saveData();
        });
    });

    blurSummary.addEventListener('change', applySummaryBlur);
    wallpaperFile.addEventListener('change', handleWallpaperFile);
    $('exportProfileBtn').addEventListener('click', handleExportProfile);
    $('importProfileBtn').addEventListener('click', handleImportProfile);
    $('resetProfileBtn').addEventListener('click', handleResetProfile);
    $('unpaidToolBtn').addEventListener('click', handleUnpaidTool);

    $('demoModeBtn').addEventListener('click', async () => {
        const choice = await showModal({
            title: 'Enable Demo Mode?',
            text: 'This will replace your current profile with a randomized, pre-populated one.\n\nYour current data will be lost. This action cannot be undone.',
            buttons: [
                { text: 'Enable Demo', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (choice === 'confirm') {
            generateDemoProfile();
            await showModal({ 
                title: 'Demo Mode Enabled', 
                text: 'The application will now reload with the demo profile.', 
                buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]
            });
            location.reload();
        }
    });

    $('deactivateDemoBtn').addEventListener('click', handleResetProfile);

    window.addEventListener('resize', () => { resizeCanvas(ambianceCanvas); applyAmbianceSettings(); applyLayoutMode(); });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
             if (activeModalResolve) {
                const lastButton = genericModalButtons.lastElementChild;
                if (lastButton && lastButton.classList.contains('cancel-btn')) {
                    lastButton.click();
                }
             } else if (editModal.classList.contains('visible')) {
                closeEditModal();
             } else if (addBillModal.classList.contains('visible')) {
                addBillModal.classList.remove('visible');
             } else if (expenseModal.classList.contains('visible')) {
                expenseModal.classList.remove('visible');
             } else if ($('dayBreakdownModal').classList.contains('visible')) {
                closeDayBreakdownModal();
             }
        }
    });

    addDebtForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newDebt = {
            id: Date.now(),
            name: $('debtName').value.trim(),
            amount: parseFloat($('debtAmount').value),
            date: $('debtDate').value,
            notes: $('debtNotes').value.trim(),
            status: 'outstanding',
            paidAmount: 0
        };
        if (newDebt.name && newDebt.amount > 0 && newDebt.date) {
            debts.push(newDebt);
            addDebtForm.reset();
            $('debtDate').value = new Date().toISOString().split('T')[0];
            saveData();
            renderTheTab();
        }
    });

    debtList.addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const item = target.closest('.debt-item');
        const debtId = Number(item.dataset.id);
        const debt = debts.find(d => d.id === debtId);
        if (!debt) return;

        if (target.classList.contains('make-payment-btn')) {
            const paidAmount = debt.paidAmount || 0;
            const remainingAmount = debt.amount - paidAmount;

            const paymentResult = await showModal({
                title: `Pay Tab for ${debt.name}`,
                customHTML: `
                    <p style="margin-bottom: 12px;">Remaining balance: <strong>${formatCurrency(remainingAmount)}</strong></p>
                    <label for="modal-input" style="display: block; margin-bottom: 4px; font-size: 14px; color: var(--muted);">Enter payment amount:</label>
                    <input type="number" id="modal-input" placeholder="${remainingAmount.toFixed(2)}" value="${remainingAmount.toFixed(2)}" step="0.01" required>`,
                buttons: [
                    { text: 'Make Payment', value: 'pay', class: 'save-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
                ]
            });
            
            const paymentAmount = parseFloat(paymentResult);

            if (paymentResult !== 'cancel' && !isNaN(paymentAmount) && paymentAmount > 0) {
                if (paymentAmount > remainingAmount + 0.001) { // Add a small tolerance for floating point issues
                     await showModal({
                        title: 'Invalid Amount',
                        text: 'Payment cannot be greater than the remaining balance.',
                        buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
                    });
                    return;
                }
                
                if (!dontAutoDeduct.checked) {
                    const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                    currentBalance.value = (currentBalanceVal + paymentAmount).toFixed(2);
                }
                
                debt.paidAmount = (debt.paidAmount || 0) + paymentAmount;
                if (debt.paidAmount >= debt.amount) {
                    debt.status = 'satisfied';
                }
                saveData();
                renderTheTab();
                updateSummary();
            }
        } else if (target.classList.contains('dismiss-debt-btn')) {
            const choice = await showModal({
                title: 'Confirm Dismissal',
                text: `Are you sure you want to permanently remove this debt record for "${debt.name}"? This action cannot be undone.`,
                buttons: [
                    { text: 'Yes, Remove It', value: 'confirm', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'confirm') {
                debts = debts.filter(d => d.id !== debtId);
                saveData();
                renderTheTab();
            }
        }
    });

    function getDateRange(timeRange) {
        const endDate = new Date();
        let startDate = new Date();
        endDate.setHours(23, 59, 59, 999); // End of today

        switch (String(timeRange)) {
            case '7':
                startDate.setDate(endDate.getDate() - 7);
                break;
            case '30':
                startDate.setDate(endDate.getDate() - 30);
                break;
            case '90':
                startDate.setDate(endDate.getDate() - 90);
                break;
            case '365':
                startDate.setFullYear(endDate.getFullYear() - 1);
                break;
            case 'all':
                // Find the date of the earliest bill to set as start date
                startDate = bills.length > 0 ? new Date(bills.map(b => new Date(b.date)).sort((a, b) => a - b)[0]) : new Date();
                break;
        }
        startDate.setHours(0, 0, 0, 0); // Start of the day
        return { startDate, endDate };
    }

    function getFilteredStatsData(startDate, endDate, category) {
        return bills.filter(bill => {
            if (bill.status !== 'paid' || !bill.paidTimestamp) return false;
            const paidDate = new Date(bill.paidTimestamp);
            const categoryMatch = category === 'all' || bill.category === category;
            return paidDate >= startDate && paidDate <= endDate && categoryMatch;
        });
    }

    function calculateIncome(startDate, endDate) {
        if (!paycheckAmount.value || !nextPayday.value) return 0;
        const paydaysInRange = getPaydaysInRange(startDate, endDate);
        const paycheck = parseFloat(paycheckAmount.value) || 0;
        return paydaysInRange.length * paycheck;
    }
    
    function populateStatsCategoryFilter() {
        const selectedValue = statsCategory.value;
        while (statsCategory.options.length > 1) { statsCategory.remove(1); }
        const categories = [...new Set(bills.map(b => b.category))].sort();
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            statsCategory.appendChild(option);
        });
        if (statsCategory.querySelector(`option[value="${selectedValue}"]`)) {
            statsCategory.value = selectedValue;
        }
    }

    function getThemeColors() {
        const style = getComputedStyle(document.documentElement);
        return {
            accent: style.getPropertyValue('--accent').trim(),
            ok: style.getPropertyValue('--ok').trim(),
            danger: style.getPropertyValue('--danger').trim(),
            muted: style.getPropertyValue('--muted').trim(),
            text: style.getPropertyValue('--text').trim(),
            card: style.getPropertyValue('--card').trim(),
            border: style.getPropertyValue('--border').trim()
        };
    }

    function renderCategoryPieChart(data, colors) {
        const ctx = $('categoryPieChart').getContext('2d');
        if (!ctx || data.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = colors.muted;
            ctx.textAlign = 'center';
            ctx.fillText('No data for this period', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        charts.categoryPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(([cat]) => cat),
                datasets: [{
                    data: data.map(([, total]) => total),
                    backgroundColor: [colors.accent, colors.ok, '#3b82f6', '#f97316', '#8b5cf6'],
                    borderColor: colors.card,
                    borderWidth: 2,
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: colors.text } } } }
        });
    }

    function renderExpensesLineChart(bills, income, startDate, endDate, colors) {
        const ctx = $('expensesLineChart').getContext('2d');
        if (!ctx) return;

        const labels = [];
        const datePoints = {};
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = d.toISOString().split('T')[0];
            labels.push(dateString);
            datePoints[dateString] = { expenses: 0, income: 0 };
        }

        bills.forEach(bill => {
            const dateString = new Date(bill.paidTimestamp).toISOString().split('T')[0];
            if (datePoints[dateString]) {
                datePoints[dateString].expenses += getUserShare(bill);
            }
        });
        
        const paydaysInRange = getPaydaysInRange(startDate, endDate);
        paydaysInRange.forEach(pd => {
            const dateString = pd.toISOString().split('T')[0];
            if (datePoints[dateString]) {
                datePoints[dateString].income += (parseFloat(paycheckAmount.value) || 0);
            }
        });

        charts.expensesLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Expenses', data: Object.values(datePoints).map(p => p.expenses), borderColor: colors.danger, backgroundColor: colors.danger+'33', fill: true, tension: 0.2 },
                    { label: 'Income', data: Object.values(datePoints).map(p => p.income), borderColor: colors.ok, backgroundColor: colors.ok+'33', fill: true, tension: 0.2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: colors.text } }, x: { ticks: { color: colors.text } } }, plugins: { legend: { labels: { color: colors.text } } } }
        });
    }

    function renderBillsBarChart(bills, colors) {
        const ctx = $('billsBarChart').getContext('2d');
        if (!ctx) return;
        
        const statusCounts = bills.reduce((acc, bill) => {
            acc[bill.status] = (acc[bill.status] || 0) + 1;
            return acc;
        }, { paid: 0, unpaid: 0, pending: 0 });

        charts.billsBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Paid', 'Unpaid', 'Pending'],
                datasets: [{
                    label: 'Bill Status',
                    data: [statusCounts.paid, statusCounts.unpaid, statusCounts.pending],
                    backgroundColor: [colors.ok, colors.danger, colors.accent]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { ticks: { color: colors.text, stepSize: 1 } }, y: { ticks: { color: colors.text } } }, plugins: { legend: { display: false } } }
        });
    }

    function renderCashFlowLineChart(colors) {
        const ctx = $('cashFlowLineChart').getContext('2d');
        if (!ctx) return;

        let balance = parseFloat(currentBalance.value) || 0;
        const projectionDays = 90;
        const labels = [];
        const data = [];
        
        let currentDate = new Date();
        currentDate.setHours(0,0,0,0);
        const endDate = new Date(currentDate);
        endDate.setDate(currentDate.getDate() + projectionDays);
        
        const paydays = getPaydaysInRange(currentDate, endDate);
        const recurringBills = bills.filter(b => b.frequency !== 'One-Time' && b.status !== 'paid');

        for (let i = 0; i <= projectionDays; i++) {
            labels.push(currentDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            
            // Add income
            if (paydays.some(pd => pd.getTime() === currentDate.getTime())) {
                balance += (parseFloat(paycheckAmount.value) || 0);
            }

            // Subtract bills due
            const billsDueToday = getBillsForDate(currentDate);
            billsDueToday.forEach(bill => {
                 if (recurringBills.some(rb => rb.id === bill.id)) {
                    balance -= getUserShare(bill);
                 }
            });
            
            data.push(balance);
            currentDate.setDate(currentDate.getDate() + 1);
        }

        charts.cashFlowLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Projected Balance', data: data, borderColor: colors.accent, backgroundColor: colors.accent+'33', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: colors.text } }, x: { ticks: { color: colors.text } } } }
        });
    }

    function renderStatistics() {
        // Destroy existing charts
        Object.values(charts).forEach(chart => {
            if(chart) chart.destroy();
        });

        const timeRange = statsTimeRange.value;
        const category = statsCategory.value;
        const { startDate, endDate } = getDateRange(timeRange);
        const themeColors = getThemeColors();

        // --- Calculations ---
        const filteredPaidBills = getFilteredStatsData(startDate, endDate, category);
        const totalIncome = calculateIncome(startDate, endDate);
        const totalExpenses = filteredPaidBills.reduce((sum, bill) => sum + getUserShare(bill), 0);
        const netBalance = totalIncome - totalExpenses;
        
        const allBillsInRange = bills.filter(b => {
             const billDate = new Date(b.date + 'T00:00:00');
             const categoryMatch = category === 'all' || b.category === category;
             return billDate >= startDate && billDate <= endDate && categoryMatch;
        });
        const paidBillsCount = filteredPaidBills.length;
        const totalBillsCount = allBillsInRange.length;

        // --- Update Summary Cards ---
        $('statsTotalIncome').textContent = formatCurrency(totalIncome);
        $('statsTotalExpenses').textContent = formatCurrency(totalExpenses);
        $('statsNetBalance').textContent = formatCurrency(netBalance);
        $('statsNetBalance').style.color = netBalance >= 0 ? 'var(--ok)' : 'var(--danger)';
        $('statsBillsPaid').textContent = `${paidBillsCount} / ${totalBillsCount}`;

        // --- Update Tables ---
        const categories = filteredPaidBills.reduce((acc, bill) => {
            const category = bill.category || 'Uncategorized';
            if (category === 'Expense') return acc;
            acc[category] = (acc[category] || 0) + getUserShare(bill);
            return acc;
        }, {});
        const topCategories = Object.entries(categories).sort(([, a], [, b]) => b - a).slice(0, 5);
        $('topCategoriesList').innerHTML = topCategories.length > 0 ? topCategories.map(([cat, total], i) => `<p>${i + 1}. ${cat}: <strong>${formatCurrency(total)}</strong></p>`).join('') : '<p>No expense data for this period.</p>';

        const largestExpenses = [...filteredPaidBills];
        const largestByName = new Map();
        for (const bill of largestExpenses) {
            const existing = largestByName.get(bill.name);
            if (!existing || getUserShare(bill) > getUserShare(existing)) {
                largestByName.set(bill.name, bill);
            }
        }
        const uniqueLargestExpenses = Array.from(largestByName.values()).sort((a, b) => getUserShare(b) - getUserShare(a)).slice(0, 5);
        $('largestExpensesList').innerHTML = uniqueLargestExpenses.length > 0 ? uniqueLargestExpenses.map((bill, i) => `<p>${i + 1}. ${bill.name}: <strong>${formatCurrency(getUserShare(bill))}</strong></p>`).join('') : '<p>No expenses logged for this period.</p>';

        const recurringBills = bills.filter(b => b.frequency !== 'One-Time' && b.category !== 'Expense');
        const recurringOverview = recurringBills.reduce((acc, bill) => {
            const freq = bill.frequency;
            if (!acc[freq]) { acc[freq] = { total: 0, count: 0 }; }
            acc[freq].total += bill.amount;
            acc[freq].count++;
            return acc;
        }, {});
        $('recurringBillsList').innerHTML = Object.keys(recurringOverview).length > 0 ? Object.entries(recurringOverview).map(([freq, { total, count }]) => `<p>${freq}: <strong>${formatCurrency(total / count)}</strong> (avg)</p>`).join('') : '<p>No recurring bills set up.</p>';
            
        if(enableTheTab.checked) {
            const totalOwedToYou = debts.reduce((sum, debt) => sum + (debt.amount - (debt.paidAmount || 0)), 0);
            const debtsByPerson = debts.reduce((acc, debt) => {
                const remaining = debt.amount - (debt.paidAmount || 0);
                if (remaining > 0.001) { acc[debt.name] = (acc[debt.name] || 0) + remaining; }
                return acc;
            }, {});
            $('debtStatsList').innerHTML = `<div><h4>Owed to You: <strong style="color: var(--ok)">${formatCurrency(totalOwedToYou)}</strong></h4><h4>You Owe Others: <strong style="color: var(--danger)">${formatCurrency(0)}</strong></h4><small style="color: var(--muted)">(Tracking debts you owe is not yet supported)</small></div><div><h4>Breakdown by Person (Owed to You):</h4>${Object.keys(debtsByPerson).length > 0 ? Object.entries(debtsByPerson).map(([name, amount]) => `<p>${name}: <strong>${formatCurrency(amount)}</strong></p>`).join('') : '<p>No outstanding debts.</p>'}</div>`;
            $('debtStatsCard').style.display = 'block';
        } else {
            $('debtStatsCard').style.display = 'none';
        }

        // --- Render Charts ---
        renderCategoryPieChart(topCategories, themeColors);
        renderExpensesLineChart(filteredPaidBills, totalIncome, startDate, endDate, themeColors);
        renderBillsBarChart(allBillsInRange, themeColors);
        renderCashFlowLineChart(themeColors);
    }

    dashboardTabBtn.addEventListener('click', () => {
        if (dashboardTabBtn.classList.contains('active')) return;

        appView.style.display = 'flex';
        archiveView.style.display = 'none';
        statisticsView.style.display = 'none';
        goalsView.style.display = 'none';

        dashboardTabBtn.classList.add('active');
        statisticsTabBtn.classList.remove('active');
        goalsTabBtn.classList.remove('active');
        
        // ADDED: Ensure clicking dashboard tab always returns to the main list view
        currentView = 'list';
        
        // Ensure the correct view (list/calendar) is rendered within the main app
        renderApp(true); 
    });

    statisticsTabBtn.addEventListener('click', () => {
        if (statisticsTabBtn.classList.contains('active')) return;

        statisticsView.style.display = 'flex';
        appView.style.display = 'none';
        archiveView.style.display = 'none';
        goalsView.style.display = 'none';

        statisticsTabBtn.classList.add('active');
        dashboardTabBtn.classList.remove('active');
        goalsTabBtn.classList.remove('active');

        populateStatsCategoryFilter();
        renderStatistics();
    });

    [statsTimeRange, statsCategory].forEach(el => el.addEventListener('change', renderStatistics));

    // --- GOALS SYSTEM ---
    function renderGoalsView() {
        console.log('Rendering goals view, goals:', goals);
        // Update dashboard summary
        activeGoalsCount.textContent = goals.length;
        const totalSavedAmount = goals.reduce((sum, goal) => sum + (goal.savedAmount || 0), 0);
        const totalGoalAmountSum = goals.reduce((sum, goal) => sum + goal.amount, 0);
        totalSaved.textContent = formatCurrency(totalSavedAmount);
        totalGoalAmount.textContent = formatCurrency(totalGoalAmountSum);

        // Render goals list
        if (goals.length === 0) {
            noGoalsMessage.style.display = 'block';
            activeGoalsList.innerHTML = '';
            activeGoalsList.appendChild(noGoalsMessage);
        } else {
            noGoalsMessage.style.display = 'none';
            activeGoalsList.innerHTML = '';
            
            goals.forEach(goal => {
                const goalElement = createGoalElement(goal);
                activeGoalsList.appendChild(goalElement);
            });
        }
    }

    function createGoalElement(goal) {
        const progress = ((goal.savedAmount || 0) / goal.amount) * 100;
        const remaining = goal.amount - (goal.savedAmount || 0);
        const targetDate = new Date(goal.endDate);
        const today = new Date();
        const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        const goalDiv = document.createElement('div');
        goalDiv.className = 'goal-item';
        goalDiv.innerHTML = `
            <div class="goal-info">
                <div class="goal-name">${goal.name}</div>
                <div class="goal-progress">
                    <div class="goal-progress-bar">
                        <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="goal-progress-text">
                        <span>${Math.round(progress)}% complete</span>
                        <span>${daysRemaining > 0 ? `${daysRemaining} days left` : 'Target date reached'}</span>
                    </div>
                </div>
                ${goal.notes ? `<div class="goal-notes-display">${goal.notes}</div>` : ''}
            </div>
            <div class="goal-actions">
                <div class="goal-amount-container">
                    <div class="goal-amount-saved">${formatCurrency(goal.savedAmount || 0)}</div>
                    <div class="goal-amount-total"> of ${formatCurrency(goal.amount)}</div>
                </div>
                <div class="goal-action-buttons">
                    <button class="goal-action-btn" onclick="editGoal(${goal.id})" title="Modify Goal">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="goal-action-btn add" onclick="addGoalPayment(${goal.id})" title="Add Payment">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="goal-action-btn delete" onclick="deleteGoal(${goal.id})" title="Delete Goal">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        `;
        return goalDiv;
    }

    function checkGoalFeasibility() {
        const amount = parseFloat(goalAmount.value);
        const endDate = new Date(goalEndDate.value);
        const today = new Date();
        
        if (!amount || !endDate || endDate <= today) {
            feasibilityCheck.style.display = 'none';
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
            return;
        }

        const payFreq = payFrequency.value || 'Bi-Weekly';
        const nextPaydayValue = nextPayday.value;
        
        if (!nextPaydayValue) {
            showFeasibilityFeedback('warning', ' Please set your next payday in the Finance section first.');
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
            return;
        }

        // Check for down payment
        const downPayment = makeDownPayment.checked ? (parseFloat(downPaymentInput.value) || 0) : 0;
        const remainingAmount = Math.max(0, amount - downPayment);

        // Calculate actual pay periods based on payday schedule
        const schedule = generatePaymentSchedule();
        const payPeriodsRemaining = schedule.length;

        if (payPeriodsRemaining <= 0) {
            showFeasibilityFeedback('not-feasible', 'Goal date is too soon. Please select a date after your next payday.');
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
            return;
        }

        const requiredPerPaycheck = remainingAmount / payPeriodsRemaining;
        const currentPay = parseFloat(paycheckAmount.value) || 0;
        const balance = parseFloat(currentBalance.value) || 0;
        
        // Calculate discretionary income (simplified)
        const upcomingBills = bills.filter(b => b.status === 'unpaid' || b.status === 'pending');
        const billsTotal = upcomingBills.reduce((sum, bill) => sum + getUserShare(bill), 0);
        const discretionary = Math.max(0, currentPay - (billsTotal / payPeriodsRemaining));

        if (requiredPerPaycheck <= discretionary * 0.8) {
            showFeasibilityFeedback('feasible', ` Goal is feasible! You'd need to save ${formatCurrency(requiredPerPaycheck)} per paycheck.`);
            previewGoalBtn.style.display = 'inline-block';
        } else if (requiredPerPaycheck <= discretionary) {
            showFeasibilityFeedback('warning', ` Goal is tight but possible. You'd need to save ${formatCurrency(requiredPerPaycheck)} per paycheck.`);
            previewGoalBtn.style.display = 'inline-block';
        } else {
            const suggestedDate = new Date(today);
            const extendedPeriods = Math.ceil(amount / (discretionary * 0.8));
            switch(payFreq) {
                case 'Weekly': suggestedDate.setDate(today.getDate() + (extendedPeriods * 7)); break;
                case 'Bi-Weekly': suggestedDate.setDate(today.getDate() + (extendedPeriods * 14)); break;
                case 'Monthly': suggestedDate.setMonth(today.getMonth() + extendedPeriods); break;
                default: suggestedDate.setDate(today.getDate() + (extendedPeriods * 14)); break;
            }
            showFeasibilityFeedback('not-feasible', ` Goal is not feasible. Try extending to ${suggestedDate.toLocaleDateString()} or reducing the amount.`);
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
        }
    }

    function showFeasibilityFeedback(type, message) {
        feasibilityCheck.className = `feasibility-feedback ${type}`;
        feasibilityCheck.textContent = message;
        feasibilityCheck.style.display = 'block';
    }

    function generatePaymentSchedule() {
        const amount = parseFloat(goalAmount.value);
        const endDate = new Date(goalEndDate.value);
        const today = new Date();
        
        if (!amount || !endDate || endDate <= today) {
            return [];
        }

        const payFreq = payFrequency.value || 'Bi-Weekly';
        const nextPaydayValue = nextPayday.value;
        
        if (!nextPaydayValue) {
            console.warn('No next payday set in dashboard');
            return [];
        }

        const nextPaydayDate = new Date(nextPaydayValue);
        const schedule = [];
        let currentPayday = new Date(nextPaydayDate);
        
        // Generate all paydays from next payday until goal end date
        while (currentPayday <= endDate) {
            if (currentPayday > today) {
                schedule.push({
                    date: new Date(currentPayday),
                    paymentNumber: schedule.length + 1
                });
            }
            
            // Calculate next payday based on frequency
            switch(payFreq) {
                case 'Weekly':
                    currentPayday.setDate(currentPayday.getDate() + 7);
                    break;
                case 'Bi-Weekly':
                    currentPayday.setDate(currentPayday.getDate() + 14);
                    break;
                case 'Monthly':
                    currentPayday.setMonth(currentPayday.getMonth() + 1);
                    break;
                default: // Default to Bi-Weekly
                    currentPayday.setDate(currentPayday.getDate() + 14);
                    break;
            }
        }

        if (schedule.length === 0) return [];

        // Check for down payment
        const downPayment = makeDownPayment.checked ? (parseFloat(downPaymentInput.value) || 0) : 0;
        const remainingAmount = Math.max(0, amount - downPayment);

        // Calculate payment amount per payday
        const paymentAmount = remainingAmount / schedule.length;
        
        // Add payment amounts to schedule
        schedule.forEach(payment => {
            payment.amount = paymentAmount;
        });
        
        return schedule;
    }

    function showPaymentSchedulePreview() {
        const schedule = generatePaymentSchedule();
        
        if (schedule.length === 0) {
            paymentSchedulePreview.style.display = 'none';
            return;
        }

        scheduleList.innerHTML = '';
        let totalAmount = 0;

        // Check for down payment
        const downPayment = makeDownPayment.checked ? (parseFloat(downPaymentInput.value) || 0) : 0;

        // Show down payment if applicable
        if (downPayment > 0) {
            const downPaymentItem = document.createElement('div');
            downPaymentItem.className = 'schedule-item down-payment';
            downPaymentItem.innerHTML = `
                <span class="schedule-date"> Down Payment: Today</span>
                <span class="schedule-amount">${formatCurrency(downPayment)}</span>
            `;
            scheduleList.appendChild(downPaymentItem);
            totalAmount += downPayment;
        }

        schedule.forEach(payment => {
            totalAmount += payment.amount;
            const scheduleItem = document.createElement('div');
            scheduleItem.className = 'schedule-item';
            const payFreq = payFrequency.value || 'Bi-Weekly';
            scheduleItem.innerHTML = `
                <span class="schedule-date"> Payday #${payment.paymentNumber}: ${payment.date.toLocaleDateString()}</span>
                <span class="schedule-amount">${formatCurrency(payment.amount)}</span>
            `;
            scheduleList.appendChild(scheduleItem);
        });

        const totalPayments = schedule.length + (downPayment > 0 ? 1 : 0);
        scheduleTotalAmount.textContent = formatCurrency(totalAmount);
        scheduleTotalPayments.textContent = totalPayments;
        
        // Hide the old preview since we now have the full modal
        paymentSchedulePreview.style.display = 'none';
        createGoalBtn.style.display = 'none';
    }

    function createGoalPaymentSchedule(goal, downPaymentAmount = 0) {
        const today = new Date();
        const endDate = new Date(goal.endDate);
        const payFreq = payFrequency.value || 'Bi-Weekly';
        const nextPaydayValue = nextPayday.value;
        
        if (!nextPaydayValue) {
            console.warn('No next payday set - cannot create payment schedule');
            return;
        }

        const nextPaydayDate = new Date(nextPaydayValue);
        const schedule = [];
        let currentPayday = new Date(nextPaydayDate);
        
        // Generate all paydays from next payday until goal end date
        while (currentPayday <= endDate) {
            if (currentPayday > today) {
                schedule.push(new Date(currentPayday));
            }
            
            // Calculate next payday based on frequency
            switch(payFreq) {
                case 'Weekly':
                    currentPayday.setDate(currentPayday.getDate() + 7);
                    break;
                case 'Bi-Weekly':
                    currentPayday.setDate(currentPayday.getDate() + 14);
                    break;
                case 'Monthly':
                    currentPayday.setMonth(currentPayday.getMonth() + 1);
                    break;
                default: // Default to Bi-Weekly
                    currentPayday.setDate(currentPayday.getDate() + 14);
                    break;
            }
        }

        if (schedule.length === 0) return;

        // Calculate remaining amount after down payment and any saved progress
        const remainingAmount = goal.amount - goal.savedAmount - downPaymentAmount;
        const paymentAmount = remainingAmount / schedule.length;
        
        // Create bill entries for each payday
        schedule.forEach((paymentDate, index) => {
            const goalBill = {
                id: Date.now() + index, // Unique ID
                name: ` ${goal.name} - Goal Payment`,
                amount: paymentAmount,
                date: paymentDate.toISOString().split('T')[0],
                category: 'Goal Savings',
                frequency: 'One-Time',
                status: 'unpaid',
                notes: ` Goal: ${goal.name}\n Target: ${formatCurrency(goal.amount)} by ${new Date(goal.endDate).toLocaleDateString()}\n Payment ${index + 1} of ${schedule.length}\n${goal.notes ? ' ' + goal.notes : ''}`,
                goalId: goal.id, // Link to the goal
                isGoalPayment: true, // Flag to identify this as a goal payment
                goalName: goal.name,
                goalTargetAmount: goal.amount,
                goalEndDate: goal.endDate,
                paymentNumber: index + 1,
                totalPayments: schedule.length,
                isLocked: false, // Payment amount can be modified
                isEditable: true // Payment can be edited or deleted
            };
            
            bills.push(goalBill);
        });
        
        console.log(`Created ${schedule.length} goal payment bills for "${goal.name}"`);
    }

    function createDownPaymentBill(goal, downPaymentAmount) {
        const today = new Date();
        const downPaymentBill = {
            id: Date.now() + 999999, // Unique ID (offset to avoid conflicts)
            name: ` ${goal.name} - Down Payment`,
            amount: downPaymentAmount,
            date: today.toISOString().split('T')[0],
            category: 'Goal Savings',
            frequency: 'One-Time',
            status: 'unpaid', // User needs to mark this as paid
            notes: ` Down Payment for Goal: ${goal.name}\n Target: ${formatCurrency(goal.amount)} by ${new Date(goal.endDate).toLocaleDateString()}\n Initial Contribution\n${goal.notes ? ' ' + goal.notes : ''}`,
            goalId: goal.id,
            isGoalPayment: true,
            goalName: goal.name,
            goalTargetAmount: goal.amount,
            goalEndDate: goal.endDate,
            isDownPayment: true,
            paymentNumber: 0, // Down payment is payment 0
            isLocked: true, // Down payments are locked by default
            isEditable: true // Can be edited or deleted
        };
        
        bills.push(downPaymentBill);
        console.log(`Created down payment bill of ${formatCurrency(downPaymentAmount)} for "${goal.name}"`);
    }

    function updateGoalPaymentEditability(goalId) {
        const goalBills = bills.filter(b => b.isGoalPayment && b.goalId === goalId);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Sort bills by date to determine chronological order
        goalBills.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Find the last payment (most recent date that's <= today)
        let lastPaymentIndex = -1;
        for (let i = goalBills.length - 1; i >= 0; i--) {
            const billDate = new Date(goalBills[i].date);
            billDate.setHours(0, 0, 0, 0);
            if (billDate <= today) {
                lastPaymentIndex = i;
                break;
            }
        }
        
        goalBills.forEach((bill, index) => {
            const billDate = new Date(bill.date);
            billDate.setHours(0, 0, 0, 0);
            
            // All goal payments should be editable in the edit modal
            bill.isEditable = true;
            bill.canDelete = true;
            bill.canEdit = true;
            
            // Gray out past payments for visual distinction but still allow editing
            if (index < lastPaymentIndex) {
                bill.isGrayedOut = true;
            } else {
                bill.isGrayedOut = false;
            }
            
            // If paid, it's automatically locked (but preserve existing lock states)
            if (bill.status === 'paid' && bill.isLocked === undefined) {
                bill.isLocked = true;
            }
            // Note: We don't reset isLocked for unpaid bills to preserve user's manual lock choices
        });
        
        console.log(`Updated editability for ${goalBills.length} goal payments`);
    }

    window.editGoalPayment = async function(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill || !bill.isGoalPayment || !bill.canEdit) return;

        const result = await showModal({
            title: `Edit Goal Payment`,
            text: `${bill.name}\nCurrent Amount: ${formatCurrency(bill.amount)}`,
            input: bill.amount.toFixed(2),
            buttons: [
                { text: 'Save & Lock', value: 'lock', class: 'save-btn' },
                { text: 'Save', value: 'save', class: 'save-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (result === 'save' || result === 'lock') {
            const newAmount = parseFloat(document.querySelector('#genericModal input').value);
            if (newAmount > 0 && newAmount !== bill.amount) {
                const oldAmount = bill.amount;
                bill.amount = newAmount;
                
                if (result === 'lock') {
                    bill.isLocked = true;
                }
                
                // Recalculate unlocked payments for this goal
                recalculateGoalPayments(bill.goalId);
                
                console.log(`Goal payment updated: ${formatCurrency(oldAmount)} -> ${formatCurrency(newAmount)}`);
                saveData();
                renderApp(true);
            }
        }
    }

    window.toggleGoalPaymentLock = function(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill || !bill.isGoalPayment || !bill.canEdit) return;

        bill.isLocked = !bill.isLocked;
        
        if (!bill.isLocked) {
            // If unlocking, recalculate payments
            recalculateGoalPayments(bill.goalId);
        }
        
        console.log(`Goal payment ${bill.isLocked ? 'locked' : 'unlocked'}`);
        saveData();
        renderApp(true);
    }

    function recalculateGoalPayments(goalId) {
        const goal = goals.find(g => g.id === goalId);
        if (!goal) return;

        const goalBills = bills.filter(b => b.isGoalPayment && b.goalId === goalId);
        
        // If no bills left, nothing to recalculate
        if (goalBills.length === 0) {
            console.log('No goal payments remaining');
            return;
        }

        // Separate locked and unlocked bills (only considering editable ones)
        const lockedBills = goalBills.filter(b => b.isLocked === true);
        const unlockedBills = goalBills.filter(b => b.isLocked !== true);

        console.log(` Found ${lockedBills.length} locked bills, ${unlockedBills.length} unlocked bills`);

        if (unlockedBills.length === 0) {
            console.log('No unlocked payments to recalculate - all payments are locked');
            // Check if locked amounts match goal
            const lockedTotal = lockedBills.reduce((sum, b) => sum + b.amount, 0);
            const goalRemaining = goal.amount - (goal.savedAmount || 0);
            if (Math.abs(lockedTotal - goalRemaining) > 0.01) {
                console.warn(` Warning: Locked total (${formatCurrency(lockedTotal)}) doesn't match goal remaining (${formatCurrency(goalRemaining)})`);
            }
            return;
        }

        // Calculate the total amount that should be distributed across all payments
        // This is the goal amount minus what's already been saved
        const totalToDistribute = goal.amount - (goal.savedAmount || 0);

        // Calculate how much is already allocated to locked payments
        const lockedAmount = lockedBills.reduce((sum, b) => sum + b.amount, 0);

        // Calculate remaining amount to distribute among unlocked payments
        const remainingToAllocate = totalToDistribute - lockedAmount;

        console.log(` Total to distribute: ${formatCurrency(totalToDistribute)}, Locked: ${formatCurrency(lockedAmount)}, Remaining for ${unlockedBills.length} payments: ${formatCurrency(remainingToAllocate)}`);

        if (remainingToAllocate > 0) {
            const amountPerUnlockedPayment = remainingToAllocate / unlockedBills.length;

            unlockedBills.forEach(bill => {
                console.log(` Updating unlocked payment ${bill.id}: ${formatCurrency(bill.amount)}  ${formatCurrency(amountPerUnlockedPayment)}`);
                bill.amount = amountPerUnlockedPayment;
            });

            console.log(` Recalculated ${unlockedBills.length} unlocked payments to ${formatCurrency(amountPerUnlockedPayment)} each`);

            // Log locked payments to verify they weren't changed
            lockedBills.forEach(bill => {
                console.log(` Locked payment ${bill.id} remains: ${formatCurrency(bill.amount)}`);
            });

            // Verify the math
            const newTotal = lockedAmount + (amountPerUnlockedPayment * unlockedBills.length);
            console.log(` Verification: Locked (${formatCurrency(lockedAmount)}) + Unlocked (${formatCurrency(amountPerUnlockedPayment * unlockedBills.length)}) = ${formatCurrency(newTotal)}`);
        } else {
            console.log(' No remaining amount to allocate to unlocked payments');
        }
    }


    window.addGoalPayment = async function(goalId) {
        const goal = goals.find(g => g.id === goalId);
        if (!goal) return;

        const remaining = goal.amount - (goal.savedAmount || 0);
        const amount = await showModal({
            title: `Add Payment to "${goal.name}"`,
            text: `How much would you like to add? (Remaining: ${formatCurrency(remaining)})`,
            input: { type: 'number', placeholder: '0.00', min: '0.01', step: '0.01' },
            buttons: [
                { text: 'Add Payment', value: 'add', class: 'save-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (amount === 'add') {
            const paymentAmount = parseFloat(document.querySelector('#genericModal input').value);
            if (paymentAmount > 0) {
                goal.savedAmount = (goal.savedAmount || 0) + paymentAmount;
                goal.lastPayment = { amount: paymentAmount, date: new Date().toISOString() };
                
                // Deduct from balance if enabled
                if (!dontAutoDeduct.checked) {
                    currentBalance.value = ((parseFloat(currentBalance.value) || 0) - paymentAmount).toFixed(2);
                }
                
                saveData();
                renderGoalsView();
                if (goal.savedAmount >= goal.amount) {
                    await showModal({
                        title: ' Goal Completed!',
                        text: `Congratulations! You've reached your goal "${goal.name}"!`,
                        buttons: [{ text: 'Awesome!', value: 'ok', class: 'save-btn' }]
                    });
                }
            }
        }
    }

    window.deleteGoal = async function(goalId) {
        const goal = goals.find(g => g.id === goalId);
        if (!goal) return;

        const choice = await showModal({
            title: 'Delete Goal',
            text: `Are you sure you want to delete "${goal.name}"? This will also refund ${formatCurrency(goal.savedAmount || 0)} to your balance.`,
            buttons: [
                { text: 'Delete Goal', value: 'delete', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (choice === 'delete') {
            // Refund saved amount to balance
            if ((goal.savedAmount || 0) > 0 && !dontAutoDeduct.checked) {
                currentBalance.value = ((parseFloat(currentBalance.value) || 0) + (goal.savedAmount || 0)).toFixed(2);
            }
            
            // Remove all associated goal payment bills
            bills = bills.filter(b => !(b.isGoalPayment && b.goalId === goalId));
            
            goals = goals.filter(g => g.id !== goalId);
            saveData();
            renderGoalsView();
            renderApp(true); // Refresh the bills view
        }
    }

    // Global functions for inline onclick handlers
    window.togglePaymentLock = function(billId, buttonElement) {
        console.log(` Toggle lock called for bill ${billId}`);

        const isCurrentlyLocked = buttonElement.dataset.locked === 'true';
        console.log(` Current lock state: ${isCurrentlyLocked}`);

        // Check if this is a temporary bill (preview mode) - convert to string first
        const billIdStr = String(billId);
        if (billIdStr.startsWith('temp-')) {
            // This is a temporary bill during preview - we'll handle it in the modal
            console.log(` Temporary bill ${billId} - lock state will be handled in modal`);
        } else {
            // Find the bill and update its lock state in the data
            const bill = bills.find(b => b.id === billId);
            if (bill) {
                const wasLocked = bill.isLocked;
                bill.isLocked = !isCurrentlyLocked;
                console.log(` Bill ${billId} lock state updated in data: ${bill.isLocked}`);
                
                // If we're unlocking, we should offer to recalculate
                if (wasLocked && !bill.isLocked && bill.isGoalPayment) {
                    // Just save, recalculation will be done via the Recalculate button
                    console.log(` Payment unlocked - use Recalculate button to redistribute amounts`);
                }
                
                // Auto-save the lock state change
                saveData();
            }
        }

        // Toggle the lock state visually
        if (isCurrentlyLocked) {
            buttonElement.innerHTML = ' Lock';
            buttonElement.dataset.locked = 'false';
            buttonElement.style.background = '#f59e0b'; // Orange for unlocked
        } else {
            buttonElement.innerHTML = ' Unlock';
            buttonElement.dataset.locked = 'true';
            buttonElement.style.background = '#059669'; // Green for locked (as requested)
        }

        // Keep input field enabled even when locked (users should be able to edit locked amounts)
        const paymentItem = buttonElement.closest('.schedule-payment-item');
        if (paymentItem) {
            const inputField = paymentItem.querySelector('.payment-amount-input');
            if (inputField) {
                // Always keep input enabled - locked state is just a visual/calculation indicator
                inputField.disabled = false;
                console.log(` Input field kept enabled for editing locked amounts for bill ${billId}`);
            }
        }

        console.log(` Lock state toggled for bill ${billId} - Visual: ${buttonElement.dataset.locked}, Data: ${billIdStr.startsWith('temp-') ? 'temp bill' : 'not found'}`);
    }

    window.deleteGoalPayment = function(billId, buttonElement) {
        console.log(` Delete payment called for bill ${billId}`);

        const bill = bills.find(b => b.id === billId);
        if (!bill) {
            console.error('Bill not found for deletion:', billId);
            return;
        }

        const goalId = bill.goalId;

        // Remove from bills array
        bills = bills.filter(b => b.id !== billId);
        console.log(` Payment ${billId} deleted from bills array`);
        
        // Recalculate remaining payments
        if (goalId) {
            recalculateGoalPayments(goalId);
        }
        
        // Save changes
        saveData();
        
        // Refresh the modal to show updated payments
        setTimeout(() => {
            // Close current modal and reopen with updated data
            const modal = document.querySelector('#genericModal');
            if (modal && modal.classList.contains('visible')) {
                modal.classList.remove('visible');
                setTimeout(() => {
                    window.editGoal(goalId);
                }, 100);
            }
        }, 50);
    }

    window.editGoal = async function(goalId) {
        const goal = goals.find(g => g.id === goalId);
        if (!goal) return;

        const goalBills = bills.filter(b => b.isGoalPayment && b.goalId === goalId);
        goalBills.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Create the edit goal modal content
        const modalContent = `
            <div class="goal-edit-container">
                <div class="goal-edit-header">
                    <h3> Payment Schedule for "${goal.name}"</h3>
                    <div class="goal-progress-info">
                        <strong>Target:</strong> ${formatCurrency(goal.amount)} by ${new Date(goal.endDate).toLocaleDateString()}<br>
                        <strong>Saved:</strong> ${formatCurrency(goal.savedAmount || 0)} (${Math.round(((goal.savedAmount || 0) / goal.amount) * 100)}%)
                    </div>
                </div>
                
                <div class="payment-schedule-list">
                    ${goalBills.map((bill, index) => {
                        const statusIcon = bill.status === 'paid' ? '' : bill.status === 'pending' ? '' : '';
                        const lockIcon = bill.isLocked ? '' : '';
                        const editableClass = bill.canEdit && !bill.isGrayedOut ? 'editable' : 'non-editable';
                        const grayedClass = bill.isGrayedOut ? 'grayed-out' : '';

                        return `
                            <div class="schedule-payment-item ${editableClass} ${grayedClass}" data-bill-id="${bill.id}">
                                <div class="payment-date">
                                    ${bill.isDownPayment ? ' Down Payment' : ' Payment ' + bill.paymentNumber}
                                    <div class="payment-date-text">${new Date(bill.date).toLocaleDateString()}</div>
                                </div>
                                <div class="payment-amount">
                                    ${bill.canEdit ?
                                        `<input type="number" class="payment-amount-input" value="${bill.amount.toFixed(2)}" min="0" step="0.01" data-bill-id="${bill.id}">` :
                                        `<span class="payment-amount-display">${formatCurrency(bill.amount)}</span>`
                                    }
                                </div>
                                <div class="payment-status">
                                    ${statusIcon} ${bill.status.charAt(0).toUpperCase() + bill.status.slice(1)}
                                </div>
                                <div class="payment-controls">
                                    ${bill.canEdit ? `
                                        <button class="toggle-lock-btn" data-bill-id="${bill.id}" data-locked="${bill.isLocked}"
                                                onclick="togglePaymentLock(${bill.id}, this)"
                                                style="background: ${bill.isLocked ? '#059669' : '#f59e0b'}">
                                            ${lockIcon} ${bill.isLocked ? 'Unlock' : 'Lock'}
                                        </button>
                                    ` : ''}
                                    ${bill.canDelete ? `
                                        <button class="delete-payment-btn" data-bill-id="${bill.id}"
                                                onclick="deleteGoalPayment(${bill.id}, this)"> Delete</button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="goal-edit-summary">
                    <strong>Total Planned: </strong><span id="totalPlannedAmount">${formatCurrency(goalBills.reduce((sum, b) => sum + b.amount, 0))}</span><br>
                    <strong>Remaining to Goal: </strong><span id="remainingToGoal">${formatCurrency(goal.amount - (goal.savedAmount || 0))}</span>
                </div>
            </div>
        `;

        const result = await showModal({
            title: 'Edit Goal Payments',
            customHTML: modalContent,
            buttons: [
                { text: 'Save Changes', value: 'save', class: 'save-btn' },
                { text: ' Recalculate', value: 'recalculate', class: 'recalculate-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        // Add input change handlers to save amount changes
        setTimeout(() => {
            const modal = document.querySelector('#genericModal');
            if (modal) {
                modal.querySelectorAll('.payment-amount-input').forEach(input => {
                    // Add both blur and input handlers for better UX
                    const updateHandler = () => {
                        const billId = parseInt(input.dataset.billId);
                        const newAmount = parseFloat(input.value) || 0;
                        const bill = bills.find(b => b.id === billId);

                        if (bill && newAmount > 0) {
                            bill.amount = newAmount;
                            // Don't auto-lock when editing - let user control lock state manually
                            console.log(` Amount updated for bill ${billId}: ${formatCurrency(newAmount)} - Lock state preserved`);

                            // Update the summary in real-time
                            updateGoalEditSummary(goalId);
                            
                            // Auto-save changes
                            saveData();
                        }
                    };
                    
                    input.addEventListener('blur', updateHandler);
                    input.addEventListener('input', () => {
                        // Update summary live as user types
                        updateGoalEditSummary(goalId);
                    });
                });
                console.log(' Payment amount change handlers added');
            }
        }, 150);

        if (result === 'save') {
            // Process the changes made in the modal
            processGoalEditChanges(goalId);
        } else if (result === 'recalculate') {
            // First save current state from modal
            const modal = document.querySelector('#genericModal');
            if (modal) {
                // Save current values from inputs
                modal.querySelectorAll('.payment-amount-input').forEach(input => {
                    const billId = parseInt(input.dataset.billId);
                    const newAmount = parseFloat(input.value) || 0;
                    const bill = bills.find(b => b.id === billId);
                    if (bill && newAmount > 0) {
                        bill.amount = newAmount;
                    }
                });
                
                // Save current lock states from buttons
                modal.querySelectorAll('.toggle-lock-btn').forEach(button => {
                    const billId = parseInt(button.dataset.billId);
                    const isLocked = button.dataset.locked === 'true';
                    const bill = bills.find(b => b.id === billId);
                    if (bill) {
                        bill.isLocked = isLocked;
                    }
                });
            }
            
            // Recalculate unlocked payments
            recalculateGoalPayments(goalId);
            saveData();
            
            // Reopen the modal with updated values
            setTimeout(() => {
                window.editGoal(goalId);
            }, 100);
        }
    }

    function processGoalEditChanges(goalId) {
        const modal = document.querySelector('#genericModal');
        const amountInputs = modal.querySelectorAll('.payment-amount-input');
        const lockButtons = modal.querySelectorAll('.toggle-lock-btn');
        
        let changesDetected = false;

        // Process amount changes
        amountInputs.forEach(input => {
            const billId = parseInt(input.dataset.billId);
            const newAmount = parseFloat(input.value) || 0;
            const bill = bills.find(b => b.id === billId);
            
            if (bill && bill.amount !== newAmount && newAmount > 0) {
                console.log(`Updating payment ${billId}: ${formatCurrency(bill.amount)}  ${formatCurrency(newAmount)}`);
                bill.amount = newAmount;
                changesDetected = true;
            }
        });

        // Process lock state changes from button data attributes
        lockButtons.forEach(button => {
            const billId = parseInt(button.dataset.billId);
            const modalLockState = button.dataset.locked === 'true';
            const bill = bills.find(b => b.id === billId);
            
            if (bill) {
                console.log(` Processing lock state for payment ${billId}: Current=${bill.isLocked}, Modal=${modalLockState}`);
                if (bill.isLocked !== modalLockState) {
                    console.log(` Updating lock state for payment ${billId}: ${bill.isLocked}  ${modalLockState}`);
                    bill.isLocked = modalLockState;
                    changesDetected = true;
                } else {
                    console.log(` Lock state unchanged for payment ${billId}: ${bill.isLocked}`);
                }
            } else {
                console.error(` Bill ${billId} not found for lock state update`);
            }
        });

        if (changesDetected) {
            // Recalculate unlocked payments
            recalculateGoalPayments(goalId);
            
            // Note: Don't call updateGoalPaymentEditability here as it resets lock states
            // The editability rules are already correct from the initial modal load
            
            // Save and refresh
            saveData();
            renderGoalsView();
            renderApp(true);
            
            console.log('Goal payment changes saved successfully');
        }
    }

    function performRecalculation(goalId, closeModalAfter = true) {
        console.log(` Starting recalculation for goal ${goalId} (closeModal: ${closeModalAfter})`);

        const modal = document.querySelector('#genericModal');
        if (!modal) {
            console.error('Modal not found for recalculation');
            return;
        }

        const goal = goals.find(g => g.id === goalId);
        if (!goal) {
            console.error(`Goal ${goalId} not found for recalculation`);
            return;
        }

        // First apply current changes from the modal (amounts and lock states)
        console.log(' Applying current modal changes...');
        processGoalEditChanges(goalId);

        // Then recalculate unlocked payments
        console.log(' Recalculating unlocked payments...');
        recalculateGoalPayments(goalId);

        // Save data to localStorage
        saveData();
        console.log(' Goal payments recalculated and saved successfully');

        if (closeModalAfter) {
            // Auto-save: Close modal and refresh the app (for preview mode)
            setTimeout(() => {
                genericModal.classList.remove('visible');
                renderApp(true);
            }, 500);
        } else {
            // Just refresh the app without closing modal (for edit mode)
            renderApp(true);

            // Update the modal content to reflect new amounts after recalculation
            setTimeout(() => {
                const modal = document.querySelector('#genericModal');
                if (modal) {
                    // Update each payment amount input with the new calculated values
                    modal.querySelectorAll('.payment-amount-input').forEach(input => {
                        const billId = parseInt(input.dataset.billId);
                        const bill = bills.find(b => b.id === billId);
                        if (bill) {
                            input.value = bill.amount.toFixed(2);
                            // Always keep inputs enabled for editing locked amounts
                            input.disabled = false;
                        }
                    });

                    // Update lock button states to match the data
                    modal.querySelectorAll('.toggle-lock-btn').forEach(button => {
                        const billId = parseInt(button.dataset.billId);
                        const bill = bills.find(b => b.id === billId);
                        if (bill) {
                            const isLocked = bill.isLocked;
                            button.dataset.locked = isLocked;
                            button.innerHTML = isLocked ? ' Unlock' : ' Lock';
                            button.style.background = isLocked ? '#059669' : '#f59e0b';
                        }
                    });

                    // Update the summary amounts
                    const goalBills = bills.filter(b => b.isGoalPayment && b.goalId === goalId);
                    const totalPlannedEl = modal.querySelector('#totalPlannedAmount');
                    const remainingToGoalEl = modal.querySelector('#remainingToGoal');

                    if (totalPlannedEl) {
                        const totalPlanned = goalBills.reduce((sum, b) => sum + b.amount, 0);
                        totalPlannedEl.textContent = formatCurrency(totalPlanned);
                    }

                    if (remainingToGoalEl && goal) {
                        const remaining = goal.amount - (goal.savedAmount || 0);
                        remainingToGoalEl.textContent = formatCurrency(remaining);

                        // Color code based on whether planned amount covers the goal
                        if (goalBills.reduce((sum, b) => sum + b.amount, 0) >= remaining) {
                            remainingToGoalEl.style.color = '#059669'; // Green
                        } else {
                            remainingToGoalEl.style.color = '#dc2626'; // Red
                        }
                    }

                    // Re-attach input handlers after recalculation
                    modal.querySelectorAll('.payment-amount-input').forEach(input => {
                        if (!input.disabled) {
                            input.addEventListener('blur', () => {
                                const billId = parseInt(input.dataset.billId);
                                const newAmount = parseFloat(input.value) || 0;
                                const bill = bills.find(b => b.id === billId);

                                if (bill && newAmount > 0) {
                                    bill.amount = newAmount;
                                    // Don't auto-lock when editing - preserve user's lock state choice
                                    console.log(` Amount updated for bill ${billId}: ${formatCurrency(newAmount)} - Lock state preserved`);

                                    saveData();
                                }
                            });
                        }
                    });
                    console.log(' Modal updated and payment amount change handlers reattached after recalculation');
                }
            }, 200);
        }
        
        // Debug: Log final state
        const finalBills = bills.filter(b => b.isGoalPayment && b.goalId === goalId);
        console.log(' Final bill states:');
        finalBills.forEach(bill => {
            console.log(`  Bill ${bill.id}: ${formatCurrency(bill.amount)} - ${bill.isLocked ? ' LOCKED' : ' unlocked'}`);
        });
    }


    function updateGoalEditSummary(goalId) {
        const modal = document.querySelector('#genericModal');
        if (!modal) return;

        const goal = goals.find(g => g.id === goalId);
        if (!goal) return;

        // Calculate current total from modal inputs
        let totalPlanned = 0;
        modal.querySelectorAll('.payment-amount-input').forEach(input => {
            totalPlanned += parseFloat(input.value) || 0;
        });

        // Add amounts from non-editable payments
        modal.querySelectorAll('.payment-amount-display').forEach(display => {
            const amountText = display.textContent.replace(/[$,]/g, '');
            totalPlanned += parseFloat(amountText) || 0;
        });

        const totalPlannedEl = modal.querySelector('#totalPlannedAmount');
        const remainingToGoalEl = modal.querySelector('#remainingToGoal');
        
        if (totalPlannedEl) {
            totalPlannedEl.textContent = formatCurrency(totalPlanned);
        }
        
        if (remainingToGoalEl) {
            const remaining = goal.amount - (goal.savedAmount || 0);
            remainingToGoalEl.textContent = formatCurrency(remaining);
            
            // Color code based on whether planned amount covers the goal
            if (totalPlanned >= remaining) {
                remainingToGoalEl.style.color = '#059669'; // Green
            } else {
                remainingToGoalEl.style.color = '#dc2626'; // Red
            }
        }
    }

    // Goals Tab Navigation
    goalsTabBtn.addEventListener('click', () => {
        if (goalsTabBtn.classList.contains('active')) return;

        goalsView.style.display = 'flex';
        appView.style.display = 'none';
        archiveView.style.display = 'none';
        statisticsView.style.display = 'none';

        goalsTabBtn.classList.add('active');
        dashboardTabBtn.classList.remove('active');
        statisticsTabBtn.classList.remove('active');

        // Ensure goals are loaded and rendered
        if (!goals) goals = [];
        renderGoalsView();
    });

    // Goal Creation Form Events
    [addGoalBtn, createFirstGoalBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            goalCreationModal.classList.add('visible');
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            goalEndDate.min = tomorrow.toISOString().split('T')[0];
        });
    });

    cancelGoalBtn.addEventListener('click', () => {
        goalCreationModal.classList.remove('visible');
        // Use a timeout to allow the closing animation to finish before resetting the form
        setTimeout(() => {
            goalCreationForm.reset();
            feasibilityCheck.style.display = 'none';
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
            downPaymentAmount.style.display = 'none';
            makeDownPayment.checked = false;
            downPaymentInput.value = '';
        }, 200); // Match CSS transition duration
    });

    previewGoalBtn.addEventListener('click', () => {
        // Directly create the goal without preview
        goalCreationForm.dispatchEvent(new Event('submit'));
    });

    // Removed preview functionality - goals are created directly

    [goalAmount, goalEndDate].forEach(input => {
        input.addEventListener('input', checkGoalFeasibility);
    });

    // Down payment checkbox handler
    makeDownPayment.addEventListener('change', function() {
        if (this.checked) {
            downPaymentAmount.style.display = 'block';
            downPaymentInput.focus();
        } else {
            downPaymentAmount.style.display = 'none';
            downPaymentInput.value = '';
        }
        checkGoalFeasibility(); // Recalculate when down payment changes
    });

    downPaymentInput.addEventListener('input', checkGoalFeasibility);

    goalCreationForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Goal form submitted - starting goal creation process');
        
        const downPayment = makeDownPayment.checked ? (parseFloat(downPaymentInput.value) || 0) : 0;
        
        const newGoal = {
            id: Date.now(),
            name: goalName.value.trim(),
            amount: parseFloat(goalAmount.value),
            endDate: goalEndDate.value,
            notes: goalNotes.value.trim(),
            savedAmount: 0, // Will be credited when down payment is marked paid
            createdDate: new Date().toISOString()
        };

        console.log('New goal created:', newGoal);
        goals.push(newGoal);
        
        // Create down payment bill if applicable
        if (downPayment > 0) {
            console.log('Creating down payment bill for:', downPayment);
            createDownPaymentBill(newGoal, downPayment);
        }
        
        // Create automatic payment schedule for the goal
        console.log('Creating payment schedule for goal');
        createGoalPaymentSchedule(newGoal, downPayment);
        
        // Update editability rules for the new goal payments
        updateGoalPaymentEditability(newGoal.id);
        
        saveData();
        renderGoalsView();
        renderApp(true); // Refresh bills to show down payment bill
        
        // Hide the goal creation form with a small delay to ensure all operations complete
        setTimeout(() => {
            goalCreationModal.classList.remove('visible');
            goalCreationForm.reset();
            feasibilityCheck.style.display = 'none';
            paymentSchedulePreview.style.display = 'none';
            previewGoalBtn.style.display = 'none';
            createGoalBtn.style.display = 'none';
            downPaymentAmount.style.display = 'none';
            makeDownPayment.checked = false;
            downPaymentInput.value = '';
            console.log('Goal creation form hidden successfully');
        }, 100);
    });

    // --- INITIALIZATION ---
    function setupAccordionAnimation(details) {
        // On desktop, the finance card should not be collapsible via click.
        if (details.id === 'financeCard' && window.innerWidth > 768) {
            return;
        }

        const summary = details.querySelector('summary');
        // Use nextElementSibling for direct child, which is more reliable for this structure.
        const content = summary.nextElementSibling; 

        if (!summary || !content) return;

        let isAnimating = false;

        summary.addEventListener('click', (e) => {
            if (!enableNaturalSlide.checked) {
                return; // Allow default behavior
            }

            e.preventDefault();
            if (isAnimating) return;

            isAnimating = true;

            if (details.hasAttribute('open')) {
                // Closing animation
                const height = content.scrollHeight;
                const speed = parseFloat(slideSpeed.value) || 1000;
                const duration = (height / speed) * 1000;

                content.style.height = `${height}px`;
                content.style.overflow = 'hidden';
                content.style.transition = `height ${duration}ms var(--slide-ease)`;
                
                requestAnimationFrame(() => {
                    content.style.height = '0px';
                });

                setTimeout(() => {
                    details.removeAttribute('open');
                    content.style.height = '';
                    content.style.transition = '';
                    content.style.overflow = '';
                    isAnimating = false;
                }, duration);
            } else {
                // Opening animation
                details.setAttribute('open', '');
                const height = content.scrollHeight;
                const speed = parseFloat(slideSpeed.value) || 1000;
                const duration = (height / speed) * 1000;

                content.style.height = '0px';
                content.style.overflow = 'hidden';
                content.style.transition = `height ${duration}ms var(--slide-ease)`;

                requestAnimationFrame(() => {
                    content.style.height = `${height}px`;
                });

                setTimeout(() => {
                    content.style.height = ''; // Let it be auto
                    content.style.transition = '';
                    content.style.overflow = '';
                    isAnimating = false;
                }, duration);
            }
        });
    }

    // Initialize all accordions
    document.querySelectorAll('#billTrackerCard, #pastBillsCard, #financeCard, #theTabCard, #archive-filters, .menu-panel details').forEach(setupAccordionAnimation);

    function setupBillAccordions() {
        if (window.innerWidth <= 768) return;

        const upcomingBills = $('billTrackerCard');
        const pastBills = $('pastBillsCard');

        upcomingBills.addEventListener('toggle', () => {
            if (upcomingBills.open) {
                pastBills.removeAttribute('open');
            }
        });

        pastBills.addEventListener('toggle', () => {
            if (pastBills.open) {
                upcomingBills.removeAttribute('open');
            }
        });
    }
    setupBillAccordions();

    // Mobile detection function
    function checkMobileView() {
        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-view');
        } else {
            document.body.classList.remove('mobile-view');
        }
    }

    // Initial mobile check and resize listener
    checkMobileView();
    window.addEventListener('resize', checkMobileView);

    resizeCanvas(ambianceCanvas); loadData(); requestAnimationFrame(mainLoop);
})();
</script>
</body>
</html>
